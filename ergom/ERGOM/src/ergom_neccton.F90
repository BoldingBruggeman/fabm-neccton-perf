#include "fabm_driver.h"

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!                                                                        !
!                                                                        !
!     ERGOM model CGT version ported to FABM by Hagen Radtke             !
!     (Leibniz Institute for Baltic Sea Research Warnem√ºnde - IOW).      !
!     Code automatically generated by Code Generation Tool Version <cgt_version> !
!     See www.ergom.net                                                  !
!                                                                        !
!                                                                        !
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!-----------------------------------------------------------------------
!BOP
!
! !MODULE: fabm\_iow\_ergom --- Biogeochemical model ERGOM for NEMO
!
! !INTERFACE:
   module bsh_ergom_neccton
!
! !DESCRIPTION:
! Model: ERGOM Version CDOM 1.0 \\
! Ecological ReGional Ocean Model adapted for BSH-NECCTON \\
! Author(s): Thomas Neumann, Hagen Radtke, Martin Schmidt (IOW) Josefine Hahn (BSH), Anja Lindenthal (BSH) \\
! Contact: thomas.neumann@io-warnemuende.de, hagen.radtke@io-warnemuende.de, josefine.hahn@bsh.de, anja.lindenthal@bsh.de \\
! Code generated: 2025-Apr-24 16:45
!
! !USES:
   use fabm_types

   implicit none

   private
!
! !PUBLIC MEMBER FUNCTIONS:
   public type_bsh_ergom_neccton
!
! !REVISION HISTORY:
!  Author(s):

! ------------------------

! !PUBLIC_DERIVED_TYPES:
      type,extends(type_base_model) :: type_bsh_ergom_neccton
! Variable identifiers
      type (type_state_variable_id)        :: id_t_n2           
      type (type_state_variable_id)        :: id_t_o2           
      type (type_state_variable_id)        :: id_t_dic          
      type (type_state_variable_id)        :: id_t_nh4          
      type (type_state_variable_id)        :: id_t_no3          
      type (type_state_variable_id)        :: id_t_po4          
      type (type_state_variable_id)        :: id_t_spp          
      type (type_state_variable_id)        :: id_t_zoo          
      type (type_state_variable_id)        :: id_t_h2s          
      type (type_state_variable_id)        :: id_t_sul          
      type (type_state_variable_id)        :: id_t_alk          
      type (type_state_variable_id)        :: id_t_ipw          
      type (type_state_variable_id)        :: id_t_lpp          
      type (type_state_variable_id)        :: id_t_cya          
      type (type_state_variable_id)        :: id_t_det          
      type (type_state_variable_id)        :: id_t_poc          
      type (type_state_variable_id)        :: id_t_pocp         
      type (type_state_variable_id)        :: id_t_pocn         
      type (type_state_variable_id)        :: id_t_doc          
      type (type_state_variable_id)        :: id_t_dop          
      type (type_state_variable_id)        :: id_t_don          
      type (type_state_variable_id)        :: id_t_cdom         
      type (type_bottom_state_variable_id) :: id_t_sed          
      type (type_bottom_state_variable_id) :: id_t_ips          
      type (type_bottom_state_variable_id) :: id_t_sed_poc      
      type (type_bottom_state_variable_id) :: id_t_sed_pocn     
      type (type_bottom_state_variable_id) :: id_t_sed_pocp     
      type (type_dependency_id)            :: id_par,id_temp,id_salt,id_diffusivity
      type (type_horizontal_dependency_id) :: id_I_0,id_wind,id_taub
      type (type_horizontal_dependency_id) :: id_depth, id_lat, id_lon
      type (type_global_dependency_id)     :: id_timestep
      type (type_diagnostic_variable_id)   :: id_dPAR
!      type (type_diagnostic_variable_id)   :: id_dPAR,id_GPP,id_NCP,id_PPR,id_NPR
      type (type_diagnostic_variable_id)   :: id_k0_co2         
      type (type_diagnostic_variable_id)   :: id_k1_co2         
      type (type_diagnostic_variable_id)   :: id_k2_co2         
      type (type_diagnostic_variable_id)   :: id_alk_boron      
      type (type_diagnostic_variable_id)   :: id_alk_h2s        
      type (type_diagnostic_variable_id)   :: id_alk_water      
      type (type_diagnostic_variable_id)   :: id_alk_po4        
      type (type_diagnostic_variable_id)   :: id_alk_co2_denominator
      type (type_diagnostic_variable_id)   :: id_alk_co2        
      type (type_diagnostic_variable_id)   :: id_alk_residual   
      type (type_diagnostic_variable_id)   :: id_dalkp_dh3o     
      type (type_diagnostic_variable_id)   :: id_dalkc_dh3o     
      type (type_diagnostic_variable_id)   :: id_dalkresidual_dpH
      type (type_diagnostic_variable_id)   :: id_ph             
      type (type_diagnostic_variable_id)   :: id_h3o            
      type (type_diagnostic_variable_id)   :: id_lr_assim_lpp   
      type (type_diagnostic_variable_id)   :: id_lr_assim_lpp_doc
      type (type_diagnostic_variable_id)   :: id_lr_assim_spp_doc
      type (type_diagnostic_variable_id)   :: id_lr_assim_cya_doc
      type (type_diagnostic_variable_id)   :: id_lr_assim_spp   
      type (type_diagnostic_variable_id)   :: id_lr_assim_cya   
      type (type_diagnostic_variable_id)   :: id_lr_assim_lpp_dop
      type (type_diagnostic_variable_id)   :: id_lr_assim_spp_dop
      type (type_diagnostic_variable_id)   :: id_lr_assim_lpp_don
      type (type_diagnostic_variable_id)   :: id_lr_assim_spp_don
      type (type_diagnostic_variable_id)   :: id_phyto_C        
      type (type_diagnostic_variable_id)   :: id_cdom_decay     
      type (type_diagnostic_variable_id)   :: id_zoo_C          
      type (type_diagnostic_variable_id)   :: id_lpp_C          
      type (type_diagnostic_variable_id)   :: id_spp_C          
      type (type_diagnostic_variable_id)   :: id_cya_C          
      type (type_diagnostic_variable_id)   :: id_pp_total       
      type (type_diagnostic_variable_id)   :: id_resp_total     
      type (type_diagnostic_variable_id)   :: id_net_pp         
      type (type_diagnostic_variable_id)   :: id_chl_a          
      type (type_diagnostic_variable_id)   :: id_KD             
      type (type_diagnostic_variable_id)   :: id_secchi_depth   
      type (type_diagnostic_variable_id)   :: id_det_C          
      type (type_diagnostic_variable_id)   :: id_chl_a_C        
      type (type_diagnostic_variable_id)   :: id_chl_a_lpp_C    
      type (type_diagnostic_variable_id)   :: id_chl_a_spp_C    
      type (type_diagnostic_variable_id)   :: id_chl_a_cya_C    
      type (type_diagnostic_variable_id)   :: id_cdom3_C        
      type (type_diagnostic_variable_id)   :: id_cdom2_C        
      type (type_diagnostic_variable_id)   :: id_cdom1_C        
      type (type_diagnostic_variable_id)   :: id_r_zoo_mort_light
      type (type_diagnostic_variable_id)   :: id_p_no3_assim_lpp
      type (type_diagnostic_variable_id)   :: id_p_nh4_assim_lpp
      type (type_diagnostic_variable_id)   :: id_p_no3_assim_spp
      type (type_diagnostic_variable_id)   :: id_p_nh4_assim_spp
      type (type_diagnostic_variable_id)   :: id_p_n2_assim_cya 
      type (type_diagnostic_variable_id)   :: id_p_assim_lpp_doc
      type (type_diagnostic_variable_id)   :: id_p_assim_spp_doc
      type (type_diagnostic_variable_id)   :: id_p_assim_cya_doc
      type (type_diagnostic_variable_id)   :: id_p_assim_lpp_dop
      type (type_diagnostic_variable_id)   :: id_p_assim_spp_dop
      type (type_diagnostic_variable_id)   :: id_p_nh4_assim_lpp_don
      type (type_diagnostic_variable_id)   :: id_p_nh4_assim_spp_don
      type (type_diagnostic_variable_id)   :: id_p_no3_assim_spp_don
      type (type_diagnostic_variable_id)   :: id_p_poc_resp     
      type (type_diagnostic_variable_id)   :: id_p_poc_denit    
      type (type_diagnostic_variable_id)   :: id_p_poc_sulf     
      type (type_diagnostic_variable_id)   :: id_p_pocp_resp    
      type (type_diagnostic_variable_id)   :: id_p_lpp_graz_zoo 
      type (type_diagnostic_variable_id)   :: id_p_spp_graz_zoo 
      type (type_diagnostic_variable_id)   :: id_p_cya_graz_zoo 
      type (type_diagnostic_variable_id)   :: id_p_cya_mort_det_diff
      type (type_diagnostic_variable_id)   :: id_p_zoo_mort_det 
      type (type_diagnostic_variable_id)   :: id_p_det_resp_nh4 
      type (type_diagnostic_variable_id)   :: id_p_det_denit_nh4
      type (type_diagnostic_variable_id)   :: id_p_det_sulf_nh4 
      type (type_diagnostic_variable_id)   :: id_p_h2s_oxno3_sul
      type (type_diagnostic_variable_id)   :: id_p_doc2pco      
      type (type_diagnostic_variable_id)   :: id_p_dop2pocp     
      type (type_diagnostic_variable_id)   :: id_p_don2pocn     
      type (type_diagnostic_variable_id)   :: id_p_doc_resp     
      type (type_diagnostic_variable_id)   :: id_p_dop_resp     
      type (type_diagnostic_variable_id)   :: id_p_don_resp     
      type (type_diagnostic_variable_id)   :: id_p_cdom_decay   
      type (type_horizontal_diagnostic_variable_id)   :: id_sed_tot        
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_resp_nh4 
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_poc_resp 
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_poc_sulf 
      type (type_horizontal_diagnostic_variable_id)   :: id_p_det_sedi_sed 
      type (type_horizontal_diagnostic_variable_id)   :: id_p_poc_sedi_sed 
      type (type_horizontal_diagnostic_variable_id)   :: id_p_pocn_sedi_sed
      type (type_horizontal_diagnostic_variable_id)   :: id_p_pocp_sedi_sed
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_ero_pocn 
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_ero_pocp 
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_biores_poc
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_biores_pocn
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_biores_pocp
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_burial   
      type (type_horizontal_diagnostic_variable_id)   :: id_p_poc_burial   
      type (type_horizontal_diagnostic_variable_id)   :: id_p_pocn_burial  
      type (type_horizontal_diagnostic_variable_id)   :: id_p_pocp_burial  
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_pocn_resp
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_pocp_resp
      type (type_horizontal_diagnostic_variable_id)   :: id_p_sed_pocp_denit
      type (type_horizontal_diagnostic_variable_id)   :: id_pco2           
      type (type_horizontal_diagnostic_variable_id)   :: id_schmidtnumber_co2
      type (type_horizontal_diagnostic_variable_id)   :: id_schmidtnumber_o2
      type (type_horizontal_diagnostic_variable_id)   :: id_schmidtnumber_n2
      type (type_horizontal_diagnostic_variable_id)   :: id_p_n2_stf_down  
      type (type_horizontal_diagnostic_variable_id)   :: id_p_n2_stf_up    
      type (type_horizontal_diagnostic_variable_id)   :: id_p_o2_stf_down  
      type (type_horizontal_diagnostic_variable_id)   :: id_p_o2_stf_up    
      type (type_horizontal_diagnostic_variable_id)   :: id_p_co2_stf_down 
      type (type_horizontal_diagnostic_variable_id)   :: id_p_co2_stf_up   
! Model parameters
      real(rk) :: critical_stress
      real(rk) :: cya0           
      real(rk) :: din_min_lpp    
      real(rk) :: din_min_spp    
      real(rk) :: dip_min_cya    
      real(rk) :: epsilon        
      real(rk) :: food_min_zoo   
      real(rk) :: gamma0         
      real(rk) :: gamma1         
      real(rk) :: gamma2         
      real(rk) :: gamma3         
      real(rk) :: h2s_min_po4_liber
      real(rk) :: ips_threshold  
      real(rk) :: ips_cl         
      real(rk) :: k_h2s_no3      
      real(rk) :: k_h2s_o2       
      real(rk) :: k_sul_no3      
      real(rk) :: k_sul_o2       
      real(rk) :: light_opt_cya  
      real(rk) :: light_opt_lpp  
      real(rk) :: light_opt_spp  
      real(rk) :: lpp0           
      real(rk) :: no3_min_sed_denit
      real(rk) :: no3_min_det_denit
      real(rk) :: o2_min_det_resp
      real(rk) :: o2_min_nit     
      real(rk) :: o2_min_po4_retent
      real(rk) :: o2_min_sed_resp
      real(rk) :: patm_co2       
      real(rk) :: q10_det_rec    
      real(rk) :: q10_doc_rec    
      real(rk) :: q10_h2s        
      real(rk) :: q10_nit        
      real(rk) :: q10_sed_rec    
      real(rk) :: r_biores       
      real(rk) :: r_cya_assim    
      real(rk) :: r_cya_resp     
      real(rk) :: r_det_rec      
      real(rk) :: r_ips_burial   
      real(rk) :: r_ips_ero      
      real(rk) :: r_ips_liber    
      real(rk) :: r_lpp_assim    
      real(rk) :: r_lpp_resp     
      real(rk) :: r_nh4_nitrif   
      real(rk) :: r_pp_mort      
      real(rk) :: r_cya_mort_diff
      real(rk) :: r_cya_mort_thresh
      real(rk) :: r_sed_ero      
      real(rk) :: r_sed_rec      
      real(rk) :: r_sed_poc_rec  
      real(rk) :: r_spp_assim    
      real(rk) :: r_spp_resp     
      real(rk) :: r_zoo_graz     
      real(rk) :: r_zoo_mort     
      real(rk) :: r_zoo_resp     
      real(rk) :: rfr_c          
      real(rk) :: rfr_h          
      real(rk) :: rfr_o          
      real(rk) :: rfr_p          
      real(rk) :: rfr_cp         
      real(rk) :: sali_max_cya   
      real(rk) :: sali_min_cya   
      real(rk) :: nit_max_cya    
      real(rk) :: nit_switch_cya 
      real(rk) :: sed_max        
      real(rk) :: sed_burial     
      real(rk) :: spp0           
      real(rk) :: temp_min_cya   
      real(rk) :: temp_switch_cya
      real(rk) :: temp_min_spp   
      real(rk) :: temp_opt_zoo   
      real(rk) :: w_co2_stf      
      real(rk) :: w_cya          
      real(rk) :: w_det          
      real(rk) :: w_ipw          
      real(rk) :: w_det_sedi     
      real(rk) :: w_ipw_sedi     
      real(rk) :: w_lpp          
      real(rk) :: w_n2_stf       
      real(rk) :: w_o2_stf       
      real(rk) :: zoo0           
      real(rk) :: zoo_cl         
      real(rk) :: don_fraction   
      real(rk) :: r_poc_rec      
      real(rk) :: r_pocp_rec     
      real(rk) :: r_pocn_rec     
      real(rk) :: w_poc          
      real(rk) :: w_poc_sedi     
      real(rk) :: w_pocp         
      real(rk) :: w_pocp_sedi    
      real(rk) :: w_pocn         
      real(rk) :: w_pocn_sedi    
      real(rk) :: fac_doc_assim_lpp
      real(rk) :: fac_doc_assim_cya
      real(rk) :: fac_doc_assim_spp
      real(rk) :: fac_dop_assim  
      real(rk) :: fac_don_assim  
      real(rk) :: fac_enh_rec    
      real(rk) :: ret_po4_1      
      real(rk) :: ret_po4_2      
      real(rk) :: frac_denit_scal
      real(rk) :: reduced_rec    
      real(rk) :: martin_fac_poc 
      real(rk) :: r_doc2poc      
      real(rk) :: r_don2pocn     
      real(rk) :: r_dop2pocp     
      real(rk) :: r_doc_rec      
      real(rk) :: r_don_rec      
      real(rk) :: r_dop_rec      
      real(rk) :: fac_ips_burial 
      real(rk) :: r_cdom_decay   
      real(rk) :: r_cdom_light   
      real(rk) :: ten            
      real(rk) :: zero           
      real(rk) :: one            
      real(rk) :: three          
      real(rk) :: min_chl_n      
      real(rk) :: max_chl_n      
      real(rk) :: light_max      
      real(rk) :: molar_mass_C   
      real(rk) :: I_h            

! model time step may is stored here preliminarily
      real(rk) :: cgt_timestep

      contains

!     Model procedures
      procedure :: initialize
      procedure :: do
      procedure :: do_bottom
      procedure :: get_light_extinction
      procedure :: do_surface

  end type
!EOP
!-----------------------------------------------------------------------

   CONTAINS

!-----------------------------------------------------------------------
!BOP
!
! !IROUTINE: Initialise the ergom model
!
! !INTERFACE:
pure function theta(x)
!
! !DESCRIPTION:
!   The heavyside step function
!
   IMPLICIT NONE
!
! !INPUT PARAMETERS:
   real(rk), intent(in) :: x
   real(rk)             :: theta
!
!EOP
!-----------------------------------------------------------------------
!BOC
     if (x .gt. 0.0) then
       theta = 1.0
     else
       theta = 0.0
     end if
   END function theta
!EOC

!-----------------------------------------------------------------------
!BOP
!
! !INTERFACE:
pure function power(a,b)
!
! !DESCRIPTION:
!   Generic power function
!
   IMPLICIT NONE
!
! !INPUT PARAMETERS:
   real(rk), intent(in) :: a
   real(rk), intent(in) :: b
   real(rk)             :: power
!
!EOP
!-----------------------------------------------------------------------
!BOC
     power = a**b

   END function power
!EOC

!-----------------------------------------------------------------------
!BOP
!
! !IROUTINE: Initialise the ergom model
!
! !INTERFACE:
subroutine initialize(self,configunit)
!
! !DESCRIPTION:
!   Here, the ergom namelist is read and the variables exported by the model are registered with FABM
!
! !USES
!   List any modules used by this routine.
   IMPLICIT NONE
!
! !INPUT PARAMETERS:
   class (type_bsh_ergom_neccton), intent(inout), target :: self
   integer,                intent(in)            :: configunit
!
! !LOCAL VARIABLES:
   real(rk)           :: critical_stress=0.016    ! critical shear stress for sediment erosion [N/m2]
   real(rk)           :: cya0           =9.0E-8   ! seed concentration for diazotroph cyanobacteria [mol/kg]
   real(rk)           :: din_min_lpp    =1.0E-6   ! DIN half saturation constant for large-cell phytoplankton growth [mol/kg]
   real(rk)           :: din_min_spp    =1.6E-7   ! DIN half saturation constant for small-cell phytoplankton growth [mol/kg]
   real(rk)           :: dip_min_cya    =1.0E-8   ! DIP half saturation constant for diazotroph cyanobacteria growth [mol/kg]
   real(rk)           :: epsilon        =4.5E-17  ! no division by 0
   real(rk)           :: food_min_zoo   =4.108E-6 ! Ivlev phytoplankton concentration for zooplankton grazing [mol/kg]
   real(rk)           :: gamma0         =0.027    ! light attentuation parameter (opacity of clear water) [1/m], DO NOT CHANGE NAME gamma0 SINCE THIS NAME WILL BE USED IN THE TEMPLATE
   real(rk)           :: gamma1         =58.0     ! light attentuation parameter (opacity of POM containing chlorophyll) [m**2/mol]
   real(rk)           :: gamma2         =53.2     ! light attentuation parameter (opacity of POM detritus) [m**2/mol]
   real(rk)           :: gamma3         =12.6     ! light attentuation parameter (opacity of DON) [m**2/mol]
   real(rk)           :: h2s_min_po4_liber=1.0E-6   ! minimum h2s concentration for liberation of iron phosphate from the sediment [mol/kg]
   real(rk)           :: ips_threshold  =0.1      ! threshold for increased PO4 burial [mol/m**2]
   real(rk)           :: ips_cl         =0.02025  ! iron phosphate in sediment closure parameter [mol/m2]
   real(rk)           :: k_h2s_no3      =800000.0 ! reaction constant h2s oxidation with no3 [kg/mol/day]
   real(rk)           :: k_h2s_o2       =800000.0 ! reaction constant h2s oxidation with o2 [kg/mol/day]
   real(rk)           :: k_sul_no3      =20000.0  ! reaction constant sul oxidation with no3 [kg/mol/day]
   real(rk)           :: k_sul_o2       =20000.0  ! reaction constant sul oxidation with o2 [kg/mol/day]
   real(rk)           :: light_opt_cya  =50.0     ! optimal light for diazotroph cyanobacteria growth [W/m**2]
   real(rk)           :: light_opt_lpp  =35.0     ! optimal light for large-cell phytoplankton growth [W/m**2]
   real(rk)           :: light_opt_spp  =50.0     ! optimal light for small-cell phytoplankton growth [W/m**2]
   real(rk)           :: lpp0           =4.5E-9   ! seed concentration for large-cell phytoplankton [mol/kg]
   real(rk)           :: no3_min_sed_denit=1.423E-7 ! nitrate half-saturation concentration for denitrification in the water column [mol/kg]
   real(rk)           :: no3_min_det_denit=1.0E-9   ! minimum no3 concentration for recycling of detritus using nitrate (denitrification)
   real(rk)           :: o2_min_det_resp=1.0E-6   ! oxygen half-saturation constant for detritus recycling [mol/kg]
   real(rk)           :: o2_min_nit     =3.75E-6  ! oxygen half-saturation constant for nitrification [mol/kg]
   real(rk)           :: o2_min_po4_retent=0.0000375 ! oxygen half-saturation concentration for retension of phosphate during sediment denitrification [mol/kg]
   real(rk)           :: o2_min_sed_resp=0.000064952 ! oxygen half-saturation constant for recycling of sediment detritus using oxygen [mol/kg]
   real(rk)           :: patm_co2       =38.0     ! atmospheric partial pressure of CO2 [Pa]
   real(rk)           :: q10_det_rec    =0.15     ! q10 rule factor for recycling [1/K]
   real(rk)           :: q10_doc_rec    =0.069    ! q10 rule factor for DOC recycling [1/K]
   real(rk)           :: q10_h2s        =0.0693   ! q10 rule factor for oxidation of h2s and sul [1/K]
   real(rk)           :: q10_nit        =0.11     ! q10 rule factor for nitrification [1/K]
   real(rk)           :: q10_sed_rec    =0.175    ! q10 rule factor for detritus recycling in the sediment [1/K]
   real(rk)           :: r_biores       =0.015    ! bio-resuspension rate [1/day]
   real(rk)           :: r_cya_assim    =0.75     ! maximum rate for nutrient uptake of diazotroph cyanobacteria [1/day]
   real(rk)           :: r_cya_resp     =0.01     ! respiration rate of cyanobacteria to ammonium [1/day]
   real(rk)           :: r_det_rec      =0.003    ! recycling rate (detritus to ammonium) at 0degC [1/day]
   real(rk)           :: r_ips_burial   =0.0018   ! final burial rate for PO4 [1/day]
   real(rk)           :: r_ips_ero      =6.0      ! erosion rate for iron PO4 [1/day]
   real(rk)           :: r_ips_liber    =0.1      ! PO4 liberation rate under anoxic conditions [1/day]
   real(rk)           :: r_lpp_assim    =1.38     ! maximum rate for nutrient uptake of large-cell phytoplankton [1/day]
   real(rk)           :: r_lpp_resp     =0.075    ! respiration rate of large phytoplankton to ammonium [1/day]
   real(rk)           :: r_nh4_nitrif   =0.05     ! nitrification rate at 0degC [1/day]
   real(rk)           :: r_pp_mort      =0.03     ! mortality rate of phytoplankton [1/day]
   real(rk)           :: r_cya_mort_diff=40.0     ! enhanced cya mortality due to strong turbulence
   real(rk)           :: r_cya_mort_thresh=0.02     ! diffusivity threshold for enhanced cyano mortality
   real(rk)           :: r_sed_ero      =6.0      ! maximum sediment detritus erosion rate [1/day]
   real(rk)           :: r_sed_rec      =0.003    ! maximum recycling rate for sedimentary detritus [1/d]
   real(rk)           :: r_sed_poc_rec  =0.0005   ! maximum recycling rate for sedimentary POC [1/d]
   real(rk)           :: r_spp_assim    =0.4      ! maximum rate for nutrient uptake of small-cell phytoplankton [1/day]
   real(rk)           :: r_spp_resp     =0.0175   ! respiration rate of small phytoplankton to ammonium [1/day]
   real(rk)           :: r_zoo_graz     =0.5      ! maximum zooplankton grazing rate [1/day]
   real(rk)           :: r_zoo_mort     =0.03     ! mortality rate of zooplankton [1/day]
   real(rk)           :: r_zoo_resp     =0.01     ! respiration rate of zooplankton [1/day]
   real(rk)           :: rfr_c          =6.625    ! redfield ratio C/N
   real(rk)           :: rfr_h          =16.4375  ! redfield ratio H/N
   real(rk)           :: rfr_o          =6.875    ! redfield ratio O/N
   real(rk)           :: rfr_p          =0.0625   ! redfield ratio P/N
   real(rk)           :: rfr_cp         =106.0    ! redfield ratio C/P
   real(rk)           :: sali_max_cya   =8.0      ! upper salinity limit - diazotroph cyanobacteria [psu]
   real(rk)           :: sali_min_cya   =4.0      ! lower salinity limit - diazotroph cyanobacteria [psu]
   real(rk)           :: nit_max_cya    =5.0E-7   ! limits cyano growth in DIN reach environment
   real(rk)           :: nit_switch_cya =8.0      ! strengs of DIN control for cyano growth
   real(rk)           :: sed_max        =1.0      ! maximum sediment detritus concentration that feels erosion [mol/m**2]
   real(rk)           :: sed_burial     =1.0      ! maximum sediment load before burial
   real(rk)           :: spp0           =4.5E-9   ! seed concentration for small-cell phytoplankton [mol/kg]
   real(rk)           :: temp_min_cya   =13.5     ! lower temperature limit - diazotroph cyanobacteria [degC]
   real(rk)           :: temp_switch_cya=4.0      ! strengs of temperature control for cyano growth
   real(rk)           :: temp_min_spp   =10.0     ! lower temperature limit - small-cell phytoplankton [degC]
   real(rk)           :: temp_opt_zoo   =20.0     ! optimal temperature for zooplankton grazing [degC]
   real(rk)           :: w_co2_stf      =4.0      ! piston velocity for co2 surface flux [m/d]
   real(rk)           :: w_cya          =1.0      ! vertical speed of diazotroph cyanobacteria [m/day]
   real(rk)           :: w_det          =-4.5     ! vertical speed of detritus [m/day]
   real(rk)           :: w_ipw          =-1.0     ! vertical speed of suspended iron PO4 [m/day]
   real(rk)           :: w_det_sedi     =-2.25    ! sedimentation velocity (negative for downward) [m/day]
   real(rk)           :: w_ipw_sedi     =-0.5     ! sedimentation velocity for iron PO4 [m/day]
   real(rk)           :: w_lpp          =-0.5     ! vertical speed of large-cell phytoplankton [m/day]
   real(rk)           :: w_n2_stf       =5.0      ! piston velocity for n2 surface flux [m/d]
   real(rk)           :: w_o2_stf       =5.0      ! piston velocity for oxygen surface flux [m/d]
   real(rk)           :: zoo0           =4.5E-9   ! seed concentration for zooplankton [mol/kg]
   real(rk)           :: zoo_cl         =9.0E-8   ! zooplankton closure parameter [mol/kg]
   real(rk)           :: don_fraction   =0.0      ! fraction of DON in respiration products
   real(rk)           :: r_poc_rec      =0.003    ! recycling rate (poc to dic) at 0degC [1/day]
   real(rk)           :: r_pocp_rec     =0.002    ! recycling rate (pocp to dic and po4) at 0degC [1/day]
   real(rk)           :: r_pocn_rec     =0.002    ! recycling rate (pocn to dic and nh4) at 0degC [1/day]
   real(rk)           :: w_poc          =-0.2     ! vertical speed of poc [m/day]
   real(rk)           :: w_poc_sedi     =-0.1     ! sedimentation velocity (negative for downward) [m/day]
   real(rk)           :: w_pocp         =-0.1     ! vertical speed of pocp [m/day]
   real(rk)           :: w_pocp_sedi    =-0.05    ! sedimentation velocity (negative for downward) [m/day]
   real(rk)           :: w_pocn         =-0.1     ! vertical speed of pocn [m/day]
   real(rk)           :: w_pocn_sedi    =-0.05    ! sedimentation velocity (negative for downward) [m/day]
   real(rk)           :: fac_doc_assim_lpp=1.0      ! factor modifying DOC assimilation rate of large phytoplankton LPP
   real(rk)           :: fac_doc_assim_cya=1.0      ! factor modifying DOC assimilation rate of cyanobacteria
   real(rk)           :: fac_doc_assim_spp=1.0      ! factor modifying DOC assimilation rate of small phytoplankton SPP
   real(rk)           :: fac_dop_assim  =0.5      ! factor modifying assimilation rate for POCP production
   real(rk)           :: fac_don_assim  =1.0      ! factor modifying assimilation rate for POCN production
   real(rk)           :: fac_enh_rec    =10.0     ! enhance recyclig of DON,POCN/DOP,POCP in case of limiting DIN/DIP
   real(rk)           :: ret_po4_1      =0.15     ! PO4 retension in oxic sediments
   real(rk)           :: ret_po4_2      =0.5      ! additional PO4 retension in oxic sediments of the Bothnian Sea
   real(rk)           :: frac_denit_scal=1.0      ! scaling frac_denit_sed
   real(rk)           :: reduced_rec    =0.8      ! decrease recycling in sed under anoxia by reduce_rec
   real(rk)           :: martin_fac_poc =0.01     ! [1/d], depth dependence of POC sinking speed
   real(rk)           :: r_doc2poc      =0.01     ! POC formation rate
   real(rk)           :: r_don2pocn     =0.01     ! POCN formation rate
   real(rk)           :: r_dop2pocp     =0.01     ! POCP formation rate
   real(rk)           :: r_doc_rec      =0.001    ! recycling rate (doc to dic) at 0degC [1/day]
   real(rk)           :: r_don_rec      =0.001    ! recycling rate (don to dic and NH4) at 0degC [1/day]
   real(rk)           :: r_dop_rec      =0.001    ! recycling rate (dop to dic and PO4) at 0degC [1/day]
   real(rk)           :: fac_ips_burial =0.5      ! reduced burial of t_ips, mimicing resolving iron-P complexes in deeper sediment and subsequent upward PO4 flux
   real(rk)           :: r_cdom_decay   =0.0035   ! decay rate of cdom
   real(rk)           :: r_cdom_light   =40.0     ! PAR intensity controling CDOM decay
   real(rk)           :: ten            =10.0     ! for power function in k1_co2,k2_co2,h3o
   real(rk)           :: zero           =0.0      ! used in power function in k1_h2s
   real(rk)           :: one            =1.0      ! used in power function for k1_h2s
   real(rk)           :: three          =3.0      ! used in power function for k1_h2s
   real(rk)           :: min_chl_n      =2.0      ! mg Chl/mmol N
   real(rk)           :: max_chl_n      =2.5      ! mg Chl/mmol N
   real(rk)           :: light_max      =40.0     ! W/m2 for chlorophyll calculation
   real(rk)           :: molar_mass_C   =12.01    ! molar mass of carbon
   real(rk)           :: I_h            =0.001    ! half saturation constant W/m2 for zoo light-dependent mortality
   real(rk)           :: t_n2_initial=0.0_rk ! dissolved molecular nitrogen
   real(rk)           :: t_o2_initial=0.0_rk ! dissolved oxygen
   real(rk)           :: t_dic_initial=0.0_rk ! dissolved inorganic carbon, treated as carbon dioxide
   real(rk)           :: t_nh4_initial=0.0_rk ! ammonium
   real(rk)           :: t_no3_initial=0.0_rk ! nitrate
   real(rk)           :: t_po4_initial=0.0_rk ! phosphate
   real(rk)           :: t_spp_initial=0.0_rk ! small-cell phytoplankton
   real(rk)           :: t_zoo_initial=0.0_rk ! zooplankton
   real(rk)           :: t_h2s_initial=0.0_rk ! hydrogen sulfide
   real(rk)           :: t_sul_initial=0.0_rk ! sulfur
   real(rk)           :: t_alk_initial=0.0_rk ! total alkalinity
   real(rk)           :: t_ipw_initial=0.0_rk ! suspended iron phosphate
   real(rk)           :: t_lpp_initial=0.0_rk ! large-cell phytoplankton
   real(rk)           :: t_cya_initial=0.0_rk ! diazotroph cyanobacteria
   real(rk)           :: t_det_initial=0.0_rk ! detritus
   real(rk)           :: t_poc_initial=0.0_rk ! particulate organic carbon
   real(rk)           :: t_pocp_initial=0.0_rk ! phosphorus in particulate organic carbon in Redfield ratio
   real(rk)           :: t_pocn_initial=0.0_rk ! nitrogen in particulate organic carbon in Redfield ratio
   real(rk)           :: t_doc_initial=0.0_rk ! dissolved organic carbon
   real(rk)           :: t_dop_initial=0.0_rk ! phosphorus in dissolved organic carbon in Redfield ratio
   real(rk)           :: t_don_initial=0.0_rk ! nitrogen in dissolved organic carbon in Redfield ratio
   real(rk)           :: t_cdom_initial=0.0_rk ! colored dissolved organic carbon
   real(rk)           :: t_sed_initial=0.0_rk ! sediment detritus
   real(rk)           :: t_ips_initial=0.0_rk ! iron phosphate in sediment
   real(rk)           :: t_sed_poc_initial=0.0_rk ! sediment particular carbon
   real(rk)           :: t_sed_pocn_initial=0.0_rk ! sediment particular organic N+C
   real(rk)           :: t_sed_pocp_initial=0.0_rk ! sediment particular organic P+C
   real(rk)           :: cgt_timestep=1.0  ! ecosystem model time step [d]
   real(rk)           :: w_poc_var
   real(rk), parameter:: secs_pr_day=86400.0_rk
   real(rk), parameter:: cgt_density=1035.0_rk ! for conversion from N-based to C-based unit: mol/kg -> mg C/m3

!   integer            :: cgt_iteration        ! current number of iteration in the iterative loop
   real(rk)            :: cgt_iteration        ! current number of iteration in the iterative loop

!EOP
!-----------------------------------------------------------------------
!BOC

!  Store parameter values in our own derived type
 call self%get_parameter(self%critical_stress,'critical_stress','<units>','critical shear stress for sediment erosion [N/m2]',default=critical_stress)
 call self%get_parameter(self%cya0           ,'cya0           ','<units>','seed concentration for diazotroph cyanobacteria [mol/kg]',default=cya0           )
 call self%get_parameter(self%din_min_lpp    ,'din_min_lpp    ','<units>','DIN half saturation constant for large-cell phytoplankton growth [mol/kg]',default=din_min_lpp    )
 call self%get_parameter(self%din_min_spp    ,'din_min_spp    ','<units>','DIN half saturation constant for small-cell phytoplankton growth [mol/kg]',default=din_min_spp    )
 call self%get_parameter(self%dip_min_cya    ,'dip_min_cya    ','<units>','DIP half saturation constant for diazotroph cyanobacteria growth [mol/kg]',default=dip_min_cya    )
 call self%get_parameter(self%epsilon        ,'epsilon        ','<units>','no division by 0',default=epsilon        )
 call self%get_parameter(self%food_min_zoo   ,'food_min_zoo   ','<units>','Ivlev phytoplankton concentration for zooplankton grazing [mol/kg]',default=food_min_zoo   )
 call self%get_parameter(self%gamma0         ,'gamma0         ','<units>','light attentuation parameter (opacity of clear water) [1/m], DO NOT CHANGE NAME gamma0 SINCE THIS NAME WILL BE USED IN THE TEMPLATE',default=gamma0         )
 call self%get_parameter(self%gamma1         ,'gamma1         ','<units>','light attentuation parameter (opacity of POM containing chlorophyll) [m**2/mol]',default=gamma1         )
 call self%get_parameter(self%gamma2         ,'gamma2         ','<units>','light attentuation parameter (opacity of POM detritus) [m**2/mol]',default=gamma2         )
 call self%get_parameter(self%gamma3         ,'gamma3         ','<units>','light attentuation parameter (opacity of DON) [m**2/mol]',default=gamma3         )
 call self%get_parameter(self%h2s_min_po4_liber,'h2s_min_po4_liber','<units>','minimum h2s concentration for liberation of iron phosphate from the sediment [mol/kg]',default=h2s_min_po4_liber)
 call self%get_parameter(self%ips_threshold  ,'ips_threshold  ','<units>','threshold for increased PO4 burial [mol/m**2]',default=ips_threshold  )
 call self%get_parameter(self%ips_cl         ,'ips_cl         ','<units>','iron phosphate in sediment closure parameter [mol/m2]',default=ips_cl         )
 call self%get_parameter(self%k_h2s_no3      ,'k_h2s_no3      ','<units>','reaction constant h2s oxidation with no3 [kg/mol/day]',default=k_h2s_no3      )
 call self%get_parameter(self%k_h2s_o2       ,'k_h2s_o2       ','<units>','reaction constant h2s oxidation with o2 [kg/mol/day]',default=k_h2s_o2       )
 call self%get_parameter(self%k_sul_no3      ,'k_sul_no3      ','<units>','reaction constant sul oxidation with no3 [kg/mol/day]',default=k_sul_no3      )
 call self%get_parameter(self%k_sul_o2       ,'k_sul_o2       ','<units>','reaction constant sul oxidation with o2 [kg/mol/day]',default=k_sul_o2       )
 call self%get_parameter(self%light_opt_cya  ,'light_opt_cya  ','<units>','optimal light for diazotroph cyanobacteria growth [W/m**2]',default=light_opt_cya  )
 call self%get_parameter(self%light_opt_lpp  ,'light_opt_lpp  ','<units>','optimal light for large-cell phytoplankton growth [W/m**2]',default=light_opt_lpp  )
 call self%get_parameter(self%light_opt_spp  ,'light_opt_spp  ','<units>','optimal light for small-cell phytoplankton growth [W/m**2]',default=light_opt_spp  )
 call self%get_parameter(self%lpp0           ,'lpp0           ','<units>','seed concentration for large-cell phytoplankton [mol/kg]',default=lpp0           )
 call self%get_parameter(self%no3_min_sed_denit,'no3_min_sed_denit','<units>','nitrate half-saturation concentration for denitrification in the water column [mol/kg]',default=no3_min_sed_denit)
 call self%get_parameter(self%no3_min_det_denit,'no3_min_det_denit','<units>','minimum no3 concentration for recycling of detritus using nitrate (denitrification)',default=no3_min_det_denit)
 call self%get_parameter(self%o2_min_det_resp,'o2_min_det_resp','<units>','oxygen half-saturation constant for detritus recycling [mol/kg]',default=o2_min_det_resp)
 call self%get_parameter(self%o2_min_nit     ,'o2_min_nit     ','<units>','oxygen half-saturation constant for nitrification [mol/kg]',default=o2_min_nit     )
 call self%get_parameter(self%o2_min_po4_retent,'o2_min_po4_retent','<units>','oxygen half-saturation concentration for retension of phosphate during sediment denitrification [mol/kg]',default=o2_min_po4_retent)
 call self%get_parameter(self%o2_min_sed_resp,'o2_min_sed_resp','<units>','oxygen half-saturation constant for recycling of sediment detritus using oxygen [mol/kg]',default=o2_min_sed_resp)
 call self%get_parameter(self%patm_co2       ,'patm_co2       ','<units>','atmospheric partial pressure of CO2 [Pa]',default=patm_co2       )
 call self%get_parameter(self%q10_det_rec    ,'q10_det_rec    ','<units>','q10 rule factor for recycling [1/K]',default=q10_det_rec    )
 call self%get_parameter(self%q10_doc_rec    ,'q10_doc_rec    ','<units>','q10 rule factor for DOC recycling [1/K]',default=q10_doc_rec    )
 call self%get_parameter(self%q10_h2s        ,'q10_h2s        ','<units>','q10 rule factor for oxidation of h2s and sul [1/K]',default=q10_h2s        )
 call self%get_parameter(self%q10_nit        ,'q10_nit        ','<units>','q10 rule factor for nitrification [1/K]',default=q10_nit        )
 call self%get_parameter(self%q10_sed_rec    ,'q10_sed_rec    ','<units>','q10 rule factor for detritus recycling in the sediment [1/K]',default=q10_sed_rec    )
 call self%get_parameter(self%r_biores       ,'r_biores       ','<units>','bio-resuspension rate [1/day]',default=r_biores       )
 call self%get_parameter(self%r_cya_assim    ,'r_cya_assim    ','<units>','maximum rate for nutrient uptake of diazotroph cyanobacteria [1/day]',default=r_cya_assim    )
 call self%get_parameter(self%r_cya_resp     ,'r_cya_resp     ','<units>','respiration rate of cyanobacteria to ammonium [1/day]',default=r_cya_resp     )
 call self%get_parameter(self%r_det_rec      ,'r_det_rec      ','<units>','recycling rate (detritus to ammonium) at 0degC [1/day]',default=r_det_rec      )
 call self%get_parameter(self%r_ips_burial   ,'r_ips_burial   ','<units>','final burial rate for PO4 [1/day]',default=r_ips_burial   )
 call self%get_parameter(self%r_ips_ero      ,'r_ips_ero      ','<units>','erosion rate for iron PO4 [1/day]',default=r_ips_ero      )
 call self%get_parameter(self%r_ips_liber    ,'r_ips_liber    ','<units>','PO4 liberation rate under anoxic conditions [1/day]',default=r_ips_liber    )
 call self%get_parameter(self%r_lpp_assim    ,'r_lpp_assim    ','<units>','maximum rate for nutrient uptake of large-cell phytoplankton [1/day]',default=r_lpp_assim    )
 call self%get_parameter(self%r_lpp_resp     ,'r_lpp_resp     ','<units>','respiration rate of large phytoplankton to ammonium [1/day]',default=r_lpp_resp     )
 call self%get_parameter(self%r_nh4_nitrif   ,'r_nh4_nitrif   ','<units>','nitrification rate at 0degC [1/day]',default=r_nh4_nitrif   )
 call self%get_parameter(self%r_pp_mort      ,'r_pp_mort      ','<units>','mortality rate of phytoplankton [1/day]',default=r_pp_mort      )
 call self%get_parameter(self%r_cya_mort_diff,'r_cya_mort_diff','<units>','enhanced cya mortality due to strong turbulence',default=r_cya_mort_diff)
 call self%get_parameter(self%r_cya_mort_thresh,'r_cya_mort_thresh','<units>','diffusivity threshold for enhanced cyano mortality',default=r_cya_mort_thresh)
 call self%get_parameter(self%r_sed_ero      ,'r_sed_ero      ','<units>','maximum sediment detritus erosion rate [1/day]',default=r_sed_ero      )
 call self%get_parameter(self%r_sed_rec      ,'r_sed_rec      ','<units>','maximum recycling rate for sedimentary detritus [1/d]',default=r_sed_rec      )
 call self%get_parameter(self%r_sed_poc_rec  ,'r_sed_poc_rec  ','<units>','maximum recycling rate for sedimentary POC [1/d]',default=r_sed_poc_rec  )
 call self%get_parameter(self%r_spp_assim    ,'r_spp_assim    ','<units>','maximum rate for nutrient uptake of small-cell phytoplankton [1/day]',default=r_spp_assim    )
 call self%get_parameter(self%r_spp_resp     ,'r_spp_resp     ','<units>','respiration rate of small phytoplankton to ammonium [1/day]',default=r_spp_resp     )
 call self%get_parameter(self%r_zoo_graz     ,'r_zoo_graz     ','<units>','maximum zooplankton grazing rate [1/day]',default=r_zoo_graz     )
 call self%get_parameter(self%r_zoo_mort     ,'r_zoo_mort     ','<units>','mortality rate of zooplankton [1/day]',default=r_zoo_mort     )
 call self%get_parameter(self%r_zoo_resp     ,'r_zoo_resp     ','<units>','respiration rate of zooplankton [1/day]',default=r_zoo_resp     )
 call self%get_parameter(self%rfr_c          ,'rfr_c          ','<units>','redfield ratio C/N',default=rfr_c          )
 call self%get_parameter(self%rfr_h          ,'rfr_h          ','<units>','redfield ratio H/N',default=rfr_h          )
 call self%get_parameter(self%rfr_o          ,'rfr_o          ','<units>','redfield ratio O/N',default=rfr_o          )
 call self%get_parameter(self%rfr_p          ,'rfr_p          ','<units>','redfield ratio P/N',default=rfr_p          )
 call self%get_parameter(self%rfr_cp         ,'rfr_cp         ','<units>','redfield ratio C/P',default=rfr_cp         )
 call self%get_parameter(self%sali_max_cya   ,'sali_max_cya   ','<units>','upper salinity limit - diazotroph cyanobacteria [psu]',default=sali_max_cya   )
 call self%get_parameter(self%sali_min_cya   ,'sali_min_cya   ','<units>','lower salinity limit - diazotroph cyanobacteria [psu]',default=sali_min_cya   )
 call self%get_parameter(self%nit_max_cya    ,'nit_max_cya    ','<units>','limits cyano growth in DIN reach environment',default=nit_max_cya    )
 call self%get_parameter(self%nit_switch_cya ,'nit_switch_cya ','<units>','strengs of DIN control for cyano growth',default=nit_switch_cya )
 call self%get_parameter(self%sed_max        ,'sed_max        ','<units>','maximum sediment detritus concentration that feels erosion [mol/m**2]',default=sed_max        )
 call self%get_parameter(self%sed_burial     ,'sed_burial     ','<units>','maximum sediment load before burial',default=sed_burial     )
 call self%get_parameter(self%spp0           ,'spp0           ','<units>','seed concentration for small-cell phytoplankton [mol/kg]',default=spp0           )
 call self%get_parameter(self%temp_min_cya   ,'temp_min_cya   ','<units>','lower temperature limit - diazotroph cyanobacteria [degC]',default=temp_min_cya   )
 call self%get_parameter(self%temp_switch_cya,'temp_switch_cya','<units>','strengs of temperature control for cyano growth',default=temp_switch_cya)
 call self%get_parameter(self%temp_min_spp   ,'temp_min_spp   ','<units>','lower temperature limit - small-cell phytoplankton [degC]',default=temp_min_spp   )
 call self%get_parameter(self%temp_opt_zoo   ,'temp_opt_zoo   ','<units>','optimal temperature for zooplankton grazing [degC]',default=temp_opt_zoo   )
 call self%get_parameter(self%w_co2_stf      ,'w_co2_stf      ','<units>','piston velocity for co2 surface flux [m/d]',default=w_co2_stf      )
 call self%get_parameter(self%w_cya          ,'w_cya          ','<units>','vertical speed of diazotroph cyanobacteria [m/day]',default=w_cya          )
 call self%get_parameter(self%w_det          ,'w_det          ','<units>','vertical speed of detritus [m/day]',default=w_det          )
 call self%get_parameter(self%w_ipw          ,'w_ipw          ','<units>','vertical speed of suspended iron PO4 [m/day]',default=w_ipw          )
 call self%get_parameter(self%w_det_sedi     ,'w_det_sedi     ','<units>','sedimentation velocity (negative for downward) [m/day]',default=w_det_sedi     )
 call self%get_parameter(self%w_ipw_sedi     ,'w_ipw_sedi     ','<units>','sedimentation velocity for iron PO4 [m/day]',default=w_ipw_sedi     )
 call self%get_parameter(self%w_lpp          ,'w_lpp          ','<units>','vertical speed of large-cell phytoplankton [m/day]',default=w_lpp          )
 call self%get_parameter(self%w_n2_stf       ,'w_n2_stf       ','<units>','piston velocity for n2 surface flux [m/d]',default=w_n2_stf       )
 call self%get_parameter(self%w_o2_stf       ,'w_o2_stf       ','<units>','piston velocity for oxygen surface flux [m/d]',default=w_o2_stf       )
 call self%get_parameter(self%zoo0           ,'zoo0           ','<units>','seed concentration for zooplankton [mol/kg]',default=zoo0           )
 call self%get_parameter(self%zoo_cl         ,'zoo_cl         ','<units>','zooplankton closure parameter [mol/kg]',default=zoo_cl         )
 call self%get_parameter(self%don_fraction   ,'don_fraction   ','<units>','fraction of DON in respiration products',default=don_fraction   )
 call self%get_parameter(self%r_poc_rec      ,'r_poc_rec      ','<units>','recycling rate (poc to dic) at 0degC [1/day]',default=r_poc_rec      )
 call self%get_parameter(self%r_pocp_rec     ,'r_pocp_rec     ','<units>','recycling rate (pocp to dic and po4) at 0degC [1/day]',default=r_pocp_rec     )
 call self%get_parameter(self%r_pocn_rec     ,'r_pocn_rec     ','<units>','recycling rate (pocn to dic and nh4) at 0degC [1/day]',default=r_pocn_rec     )
 call self%get_parameter(self%w_poc          ,'w_poc          ','<units>','vertical speed of poc [m/day]',default=w_poc          )
 call self%get_parameter(self%w_poc_sedi     ,'w_poc_sedi     ','<units>','sedimentation velocity (negative for downward) [m/day]',default=w_poc_sedi     )
 call self%get_parameter(self%w_pocp         ,'w_pocp         ','<units>','vertical speed of pocp [m/day]',default=w_pocp         )
 call self%get_parameter(self%w_pocp_sedi    ,'w_pocp_sedi    ','<units>','sedimentation velocity (negative for downward) [m/day]',default=w_pocp_sedi    )
 call self%get_parameter(self%w_pocn         ,'w_pocn         ','<units>','vertical speed of pocn [m/day]',default=w_pocn         )
 call self%get_parameter(self%w_pocn_sedi    ,'w_pocn_sedi    ','<units>','sedimentation velocity (negative for downward) [m/day]',default=w_pocn_sedi    )
 call self%get_parameter(self%fac_doc_assim_lpp,'fac_doc_assim_lpp','<units>','factor modifying DOC assimilation rate of large phytoplankton LPP',default=fac_doc_assim_lpp)
 call self%get_parameter(self%fac_doc_assim_cya,'fac_doc_assim_cya','<units>','factor modifying DOC assimilation rate of cyanobacteria',default=fac_doc_assim_cya)
 call self%get_parameter(self%fac_doc_assim_spp,'fac_doc_assim_spp','<units>','factor modifying DOC assimilation rate of small phytoplankton SPP',default=fac_doc_assim_spp)
 call self%get_parameter(self%fac_dop_assim  ,'fac_dop_assim  ','<units>','factor modifying assimilation rate for POCP production',default=fac_dop_assim  )
 call self%get_parameter(self%fac_don_assim  ,'fac_don_assim  ','<units>','factor modifying assimilation rate for POCN production',default=fac_don_assim  )
 call self%get_parameter(self%fac_enh_rec    ,'fac_enh_rec    ','<units>','enhance recyclig of DON,POCN/DOP,POCP in case of limiting DIN/DIP',default=fac_enh_rec    )
 call self%get_parameter(self%ret_po4_1      ,'ret_po4_1      ','<units>','PO4 retension in oxic sediments',default=ret_po4_1      )
 call self%get_parameter(self%ret_po4_2      ,'ret_po4_2      ','<units>','additional PO4 retension in oxic sediments of the Bothnian Sea',default=ret_po4_2      )
 call self%get_parameter(self%frac_denit_scal,'frac_denit_scal','<units>','scaling frac_denit_sed',default=frac_denit_scal)
 call self%get_parameter(self%reduced_rec    ,'reduced_rec    ','<units>','decrease recycling in sed under anoxia by reduce_rec',default=reduced_rec    )
 call self%get_parameter(self%martin_fac_poc ,'martin_fac_poc ','<units>','[1/d], depth dependence of POC sinking speed',default=martin_fac_poc )
 call self%get_parameter(self%r_doc2poc      ,'r_doc2poc      ','<units>','POC formation rate',default=r_doc2poc      )
 call self%get_parameter(self%r_don2pocn     ,'r_don2pocn     ','<units>','POCN formation rate',default=r_don2pocn     )
 call self%get_parameter(self%r_dop2pocp     ,'r_dop2pocp     ','<units>','POCP formation rate',default=r_dop2pocp     )
 call self%get_parameter(self%r_doc_rec      ,'r_doc_rec      ','<units>','recycling rate (doc to dic) at 0degC [1/day]',default=r_doc_rec      )
 call self%get_parameter(self%r_don_rec      ,'r_don_rec      ','<units>','recycling rate (don to dic and NH4) at 0degC [1/day]',default=r_don_rec      )
 call self%get_parameter(self%r_dop_rec      ,'r_dop_rec      ','<units>','recycling rate (dop to dic and PO4) at 0degC [1/day]',default=r_dop_rec      )
 call self%get_parameter(self%fac_ips_burial ,'fac_ips_burial ','<units>','reduced burial of t_ips, mimicing resolving iron-P complexes in deeper sediment and subsequent upward PO4 flux',default=fac_ips_burial )
 call self%get_parameter(self%r_cdom_decay   ,'r_cdom_decay   ','<units>','decay rate of cdom',default=r_cdom_decay   )
 call self%get_parameter(self%r_cdom_light   ,'r_cdom_light   ','<units>','PAR intensity controling CDOM decay',default=r_cdom_light   )
 call self%get_parameter(self%ten            ,'ten            ','<units>','for power function in k1_co2,k2_co2,h3o',default=ten            )
 call self%get_parameter(self%zero           ,'zero           ','<units>','used in power function in k1_h2s',default=zero           )
 call self%get_parameter(self%one            ,'one            ','<units>','used in power function for k1_h2s',default=one            )
 call self%get_parameter(self%three          ,'three          ','<units>','used in power function for k1_h2s',default=three          )
 call self%get_parameter(self%min_chl_n      ,'min_chl_n      ','<units>','mg Chl/mmol N',default=min_chl_n      )
 call self%get_parameter(self%max_chl_n      ,'max_chl_n      ','<units>','mg Chl/mmol N',default=max_chl_n      )
 call self%get_parameter(self%light_max      ,'light_max      ','<units>','W/m2 for chlorophyll calculation',default=light_max      )
 call self%get_parameter(self%molar_mass_C   ,'molar_mass_C   ','<units>','molar mass of carbon',default=molar_mass_C   )
 call self%get_parameter(self%I_h            ,'I_h            ','<units>','half saturation constant W/m2 for zoo light-dependent mortality',default=I_h            )
!  Register state variables
   call self%get_parameter(t_n2_initial,'t_n2_initial','<units>','dissolved molecular nitrogen',default=t_n2_initial)
   call self%get_parameter(t_o2_initial,'t_o2_initial','<units>','dissolved oxygen',default=t_o2_initial)
   call self%get_parameter(t_dic_initial,'t_dic_initial','<units>','dissolved inorganic carbon, treated as carbon dioxide',default=t_dic_initial)
   call self%get_parameter(t_nh4_initial,'t_nh4_initial','<units>','ammonium',default=t_nh4_initial)
   call self%get_parameter(t_no3_initial,'t_no3_initial','<units>','nitrate',default=t_no3_initial)
   call self%get_parameter(t_po4_initial,'t_po4_initial','<units>','phosphate',default=t_po4_initial)
   call self%get_parameter(t_spp_initial,'t_spp_initial','<units>','small-cell phytoplankton',default=t_spp_initial)
   call self%get_parameter(t_zoo_initial,'t_zoo_initial','<units>','zooplankton',default=t_zoo_initial)
   call self%get_parameter(t_h2s_initial,'t_h2s_initial','<units>','hydrogen sulfide',default=t_h2s_initial)
   call self%get_parameter(t_sul_initial,'t_sul_initial','<units>','sulfur',default=t_sul_initial)
   call self%get_parameter(t_alk_initial,'t_alk_initial','<units>','total alkalinity',default=t_alk_initial)
   call self%get_parameter(t_ipw_initial,'t_ipw_initial','<units>','suspended iron phosphate',default=t_ipw_initial)
   call self%get_parameter(t_lpp_initial,'t_lpp_initial','<units>','large-cell phytoplankton',default=t_lpp_initial)
   call self%get_parameter(t_cya_initial,'t_cya_initial','<units>','diazotroph cyanobacteria',default=t_cya_initial)
   call self%get_parameter(t_det_initial,'t_det_initial','<units>','detritus',default=t_det_initial)
   call self%get_parameter(t_poc_initial,'t_poc_initial','<units>','particulate organic carbon',default=t_poc_initial)
   call self%get_parameter(t_pocp_initial,'t_pocp_initial','<units>','phosphorus in particulate organic carbon in Redfield ratio',default=t_pocp_initial)
   call self%get_parameter(t_pocn_initial,'t_pocn_initial','<units>','nitrogen in particulate organic carbon in Redfield ratio',default=t_pocn_initial)
   call self%get_parameter(t_doc_initial,'t_doc_initial','<units>','dissolved organic carbon',default=t_doc_initial)
   call self%get_parameter(t_dop_initial,'t_dop_initial','<units>','phosphorus in dissolved organic carbon in Redfield ratio',default=t_dop_initial)
   call self%get_parameter(t_don_initial,'t_don_initial','<units>','nitrogen in dissolved organic carbon in Redfield ratio',default=t_don_initial)
   call self%get_parameter(t_cdom_initial,'t_cdom_initial','<units>','colored dissolved organic carbon',default=t_cdom_initial)
   call self%get_parameter(t_sed_initial,'t_sed_initial','<units>','sediment detritus',default=t_sed_initial)
   call self%get_parameter(t_ips_initial,'t_ips_initial','<units>','iron phosphate in sediment',default=t_ips_initial)
   call self%get_parameter(t_sed_poc_initial,'t_sed_poc_initial','<units>','sediment particular carbon',default=t_sed_poc_initial)
   call self%get_parameter(t_sed_pocn_initial,'t_sed_pocn_initial','<units>','sediment particular organic N+C',default=t_sed_pocn_initial)
   call self%get_parameter(t_sed_pocp_initial,'t_sed_pocp_initial','<units>','sediment particular organic P+C',default=t_sed_pocp_initial)


!  Register state variables
   call self%register_state_variable(self%id_t_n2           ,'t_n2','mol/kg', &
         'dissolved molecular nitrogen', t_n2_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_o2           ,'t_o2','mol/kg', &
         'dissolved oxygen', t_o2_initial &
         , minimum=0._rk &
         , no_river_dilution=.true. &
         )
   call self%register_state_variable(self%id_t_dic          ,'t_dic','mol/kg', &
         'dissolved inorganic carbon, treated as carbon dioxide', t_dic_initial &
         , minimum=0._rk &
         , no_river_dilution=.true. &
         )
   call self%register_state_variable(self%id_t_nh4          ,'t_nh4','mol/kg', &
         'ammonium', t_nh4_initial &
         , minimum=0._rk &
         , no_river_dilution=.true. &
         )
   call self%register_state_variable(self%id_t_no3          ,'t_no3','mol/kg', &
         'nitrate', t_no3_initial &
         , minimum=0._rk &
         , no_river_dilution=.true. &
         )
   call self%register_state_variable(self%id_t_po4          ,'t_po4','mol/kg', &
         'phosphate', t_po4_initial &
         , minimum=0._rk &
         , no_river_dilution=.true. &
         )
   call self%register_state_variable(self%id_t_spp          ,'t_spp','mol/kg', &
         'small-cell phytoplankton', t_spp_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_zoo          ,'t_zoo','mol/kg', &
         'zooplankton', t_zoo_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_h2s          ,'t_h2s','mol/kg', &
         'hydrogen sulfide', t_h2s_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_sul          ,'t_sul','mol/kg', &
         'sulfur', t_sul_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_alk          ,'t_alk','mol/kg', &
         'total alkalinity', t_alk_initial &
         , no_river_dilution=.true. &
         )
   call self%register_state_variable(self%id_t_ipw          ,'t_ipw','mol/kg', &
         'suspended iron phosphate', t_ipw_initial &
         , minimum=0._rk &
         , vertical_movement=w_ipw/secs_pr_day &
         )
   call self%register_state_variable(self%id_t_lpp          ,'t_lpp','mol/kg', &
         'large-cell phytoplankton', t_lpp_initial &
         , minimum=0._rk &
         , vertical_movement=w_lpp/secs_pr_day &
         )
   call self%register_state_variable(self%id_t_cya          ,'t_cya','mol/kg', &
         'diazotroph cyanobacteria', t_cya_initial &
         , minimum=0._rk &
         , vertical_movement=w_cya/secs_pr_day &
         )
   call self%register_state_variable(self%id_t_det          ,'t_det','mol/kg', &
         'detritus', t_det_initial &
         , minimum=0._rk &
         , vertical_movement=w_det/secs_pr_day &
         , no_river_dilution=.true. &
         )
   call self%register_state_variable(self%id_t_poc          ,'t_poc','mol/kg', &
         'particulate organic carbon', t_poc_initial &
         , minimum=0._rk &
         , vertical_movement=w_poc_var/secs_pr_day &
         )
   call self%register_state_variable(self%id_t_pocp         ,'t_pocp','mol/kg', &
         'phosphorus in particulate organic carbon in Redfield ratio', t_pocp_initial &
         , minimum=0._rk &
         , vertical_movement=w_pocp/secs_pr_day &
         )
   call self%register_state_variable(self%id_t_pocn         ,'t_pocn','mol/kg', &
         'nitrogen in particulate organic carbon in Redfield ratio', t_pocn_initial &
         , minimum=0._rk &
         , vertical_movement=w_pocn/secs_pr_day &
         )
   call self%register_state_variable(self%id_t_doc          ,'t_doc','mol/kg', &
         'dissolved organic carbon', t_doc_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_dop          ,'t_dop','mol/kg', &
         'phosphorus in dissolved organic carbon in Redfield ratio', t_dop_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_don          ,'t_don','mol/kg', &
         'nitrogen in dissolved organic carbon in Redfield ratio', t_don_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_cdom         ,'t_cdom','mol/kg', &
         'colored dissolved organic carbon', t_cdom_initial &
         , minimum=0._rk &
         , no_river_dilution=.true. &
         )
   call self%register_state_variable(self%id_t_sed          ,'t_sed','mol/m**2','sediment detritus', &
         t_sed_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_ips          ,'t_ips','mol/m**2','iron phosphate in sediment', &
         t_ips_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_sed_poc      ,'t_sed_poc','mol/m**2','sediment particular carbon', &
         t_sed_poc_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_sed_pocn     ,'t_sed_pocn','mol/m**2','sediment particular organic N+C', &
         t_sed_pocn_initial &
         , minimum=0._rk &
         )
   call self%register_state_variable(self%id_t_sed_pocp     ,'t_sed_pocp','mol/m**2','sediment particular organic P+C', &
         t_sed_pocp_initial &
         , minimum=0._rk &
         )

   ! Register the contribution of all state variables to total nitrogen
   call self%add_to_aggregate_variable(standard_variables%total_nitrogen,self%id_t_no3, scale_factor=1e6_rk)
   call self%add_to_aggregate_variable(standard_variables%total_nitrogen,self%id_t_nh4, scale_factor=1e6_rk)
   call self%add_to_aggregate_variable(standard_variables%total_nitrogen,self%id_t_spp, scale_factor=1e6_rk)
   call self%add_to_aggregate_variable(standard_variables%total_nitrogen,self%id_t_lpp, scale_factor=1e6_rk)
   call self%add_to_aggregate_variable(standard_variables%total_nitrogen,self%id_t_zoo, scale_factor=1e6_rk)
   call self%add_to_aggregate_variable(standard_variables%total_nitrogen,self%id_t_det, scale_factor=1e6_rk)
   call self%add_to_aggregate_variable(standard_variables%total_nitrogen,self%id_t_cya, scale_factor=1e6_rk)

! Register diagnostic variables
   call self%register_diagnostic_variable(self%id_dPAR,'PAR','W/m**2','photosynthetically active radiation',   &
         output=output_instantaneous)
!   call self%register_diagnostic_variable(self%id_GPP,'GPP','mmol/m**3','gross primary production',            &
!         time_treatment=time_treatment_step_integrated)
!   call self%register_diagnostic_variable(self%id_NCP,'NCP','mmol/m**3','net community production',            &
!         time_treatment=time_treatment_step_integrated)
!   call self%register_diagnostic_variable(self%id_PPR,'PPR','mmol/m**3/d','gross primary production rate',     &
!         time_treatment=time_treatment_averaged)
!   call self%register_diagnostic_variable(self%id_NPR,'NPR','mmol/m**3/d','net community production rate',     &
!         time_treatment=time_treatment_averaged)
! <auxiliaries vertLoc=WAT; isOutput=1>
!   call self%register_diagnostic_variable(self%id_ERGOM,'ERGOM','1.0','Ecological ReGional Ocean Model adapted for BSH-NECCTON',     &
!        output=output_instantaneous)
!  </auxiliaries>
   call self%register_diagnostic_variable(self%id_k0_co2         ,'k0_co2','','Solubility of CO2 [mol/kg/Pa]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_k1_co2         ,'k1_co2','','Acid dissociation constant CO2 + 2 H2O <-> HCO3- + H3O+ [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_k2_co2         ,'k2_co2','','Acid dissociation constant HCO3- + H2O <-> [CO3 2-] + H3O+ [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_alk_boron      ,'alk_boron','','boron alkalinity [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_alk_h2s        ,'alk_h2s','','hydrogen sulfide alkalinity [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_alk_water      ,'alk_water','','water alkalinity [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_alk_po4        ,'alk_po4','','phosphate alkalinity [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_alk_co2_denominator,'alk_co2_denominator','','denominator in carbonate alkalinity formula [mol2/kg2]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_alk_co2        ,'alk_co2','','carbonate alkalinity [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_alk_residual   ,'alk_residual','','error in total alkalinity calculation at the assumed pH [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_dalkp_dh3o     ,'dalkp_dh3o','','derivative of phosphate alkalinity with respect to h3o [1]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_dalkc_dh3o     ,'dalkc_dh3o','','derivative of carbonate alkalinity with respect to h3o [1]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_dalkresidual_dpH,'dalkresidual_dpH','','derivative of residual_alk with respect to pH [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_ph             ,'ph','','newly determined pH value [1]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_h3o            ,'h3o','','h3o ion concentration [mol/kg]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_lpp   ,'lr_assim_lpp','','growth rate of large-cell phytoplankton, limited by DIN, DIP, light and oxygen [1/day]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_lpp_doc,'lr_assim_lpp_doc','','production rate of DOC by LPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_spp_doc,'lr_assim_spp_doc','','production rate of POC by SPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_cya_doc,'lr_assim_cya_doc','','production rate of POC by CYA',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_spp   ,'lr_assim_spp','','growth rate of small-cell phytoplankton, limited by DIN, DIP, light, oxygen and temperature [1/day]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_cya   ,'lr_assim_cya','','growth rate of diazotroph cyanobacteria, limited by DIP, light, oxygen, temperature and salinity [1/day]',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_lpp_dop,'lr_assim_lpp_dop','','production rate of POCP by LPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_spp_dop,'lr_assim_spp_dop','','production rate of POCP by SPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_lpp_don,'lr_assim_lpp_don','','production rate of POCN by LPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lr_assim_spp_don,'lr_assim_spp_don','','production rate of POCN by SPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_phyto_C        ,'phyto_C','mmol/m3','total phytoplankton C',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_cdom_decay     ,'cdom_decay','','convert r_cdom_decay',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_zoo_C          ,'zoo_C','mmol/m3','total zooplankton C',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_lpp_C          ,'lpp_C','mg C/m3','total large phytoplankton C',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_spp_C          ,'spp_C','mg C/m3','total small phytoplankton C',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_cya_C          ,'cya_C','mg C/m3','total cyanobacteria C',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_pp_total       ,'pp_total','','total primary production (mol/kg/d)',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_resp_total     ,'resp_total','','total phytoplankton respiration loss',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_net_pp         ,'net_pp','mg/m3/d','net primary production',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_chl_a          ,'chl_a','mg/m3','chlorophyll A concentration calculated from phytoplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_KD             ,'KD','1/m','attenuation coefficient',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_secchi_depth   ,'secchi_depth','m','secchi depth calculated with KD',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_det_C          ,'det_C','mg C/m3','detritus in C',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_chl_a_C        ,'chl_a_C','mg/m3','chlorophyll A concentration in C calculated from phytoplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_chl_a_lpp_C    ,'chl_a_lpp_C','mg/m3','chlorophyll A concentration in C calculated from diatoms',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_chl_a_spp_C    ,'chl_a_spp_C','mg/m3','chlorophyll A concentration in C calculated from flagellates',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_chl_a_cya_C    ,'chl_a_cya_C','mg/m3','chlorophyll A concentration in C calculated from blue-green algae',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_cdom3_C        ,'cdom3_C','mg C/m3','Coloured dissolved organic matter in carbon units',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_cdom2_C        ,'cdom2_C','mg C/m3','Coloured dissolved organic matter in carbon units',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_cdom1_C        ,'cdom1_C','mg C/m3','Coloured dissolved organic matter in carbon units',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_r_zoo_mort_light,'r_zoo_mort_light','','light-dependent mortality rate 1/day',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_no3_assim_lpp,'p_no3_assim_lpp','mol/kg/d','assimilation of nitrate by large-cell phytoplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_nh4_assim_lpp,'p_nh4_assim_lpp','mol/kg/d','assimilation of ammonium by large-cell phytoplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_no3_assim_spp,'p_no3_assim_spp','mol/kg/d','assimilation of nitrate by small-cell phytoplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_nh4_assim_spp,'p_nh4_assim_spp','mol/kg/d','assimilation of ammonium by small-cell phytoplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_n2_assim_cya ,'p_n2_assim_cya','mol/kg/d','fixation of dinitrogen by diazotroph cyanobacteria',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_assim_lpp_doc,'p_assim_lpp_doc','mol/kg/d','Production of DOC by LPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_assim_spp_doc,'p_assim_spp_doc','mol/kg/d','Production of DOC by SPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_assim_cya_doc,'p_assim_cya_doc','mol/kg/d','Production of POC by CYA',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_assim_lpp_dop,'p_assim_lpp_dop','mol/kg/d','Production of DOP by LPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_assim_spp_dop,'p_assim_spp_dop','mol/kg/d','Production of DOP by SPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_nh4_assim_lpp_don,'p_nh4_assim_lpp_don','mol/kg/d','Production of DON by LPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_nh4_assim_spp_don,'p_nh4_assim_spp_don','mol/kg/d','Production of DON by SPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_no3_assim_spp_don,'p_no3_assim_spp_don','mol/kg/d','Production of DON by SPP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_poc_resp     ,'p_poc_resp','mol/kg/d','respiration of POC',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_poc_denit    ,'p_poc_denit','mol/kg/d','recycling of POC using nitrate (denitrification)',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_poc_sulf     ,'p_poc_sulf','mol/kg/d','Mineralization of POC, e-acceptor sulfate (sulfate reduction)',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_pocp_resp    ,'p_pocp_resp','mol/kg/d','respiration of POCP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_lpp_graz_zoo ,'p_lpp_graz_zoo','mol/kg/d','grazing of zooplankton eating large-cell phytoplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_spp_graz_zoo ,'p_spp_graz_zoo','mol/kg/d','grazing of zooplankton eating small-cell phytoplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_cya_graz_zoo ,'p_cya_graz_zoo','mol/kg/d','grazing of zooplankton eating diazotroph cyanobacteria',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_cya_mort_det_diff,'p_cya_mort_det_diff','mol/kg/d','mortality of diazotroph cyanobacteria due to strong turbulence',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_zoo_mort_det ,'p_zoo_mort_det','mol/kg/d','mortality of zooplankton',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_det_resp_nh4 ,'p_det_resp_nh4','mol/kg/d','recycling of detritus using oxygen (respiration)',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_det_denit_nh4,'p_det_denit_nh4','mol/kg/d','recycling of detritus using nitrate (denitrification)',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_det_sulf_nh4 ,'p_det_sulf_nh4','mol/kg/d','recycling of detritus using sulfate (sulfate reduction)',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_h2s_oxno3_sul,'p_h2s_oxno3_sul','mol/kg/d','oxidation of hydrogen sulfide with nitrate',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_doc2pco      ,'p_doc2pco','mol/kg/d','particle formation from DOC',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_dop2pocp     ,'p_dop2pocp','mol/kg/d','particle formation from DOP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_don2pocn     ,'p_don2pocn','mol/kg/d','particle formation from DON',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_doc_resp     ,'p_doc_resp','mol/kg/d','respiration of DOC',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_dop_resp     ,'p_dop_resp','mol/kg/d','respiration of DOP',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_don_resp     ,'p_don_resp','mol/kg/d','respiration of DON',     &
         output=output_instantaneous)
   call self%register_diagnostic_variable(self%id_p_cdom_decay   ,'p_cdom_decay','mol/kg/d','decay of cdom due to light',     &
         output=output_instantaneous)
   call self%register_horizontal_diagnostic_variable(self%id_sed_tot        ,'sed_tot','1.0','total carbon in sediment layer [mol/m**2]',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_resp_nh4 ,'p_sed_resp_nh4','mol/kg/d','recycling of sedimentary detritus to ammonium using oxygen (respiration)',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_poc_resp ,'p_sed_poc_resp','mol/kg/d','recycling of sedimentary poc to dic using oxygen (respiration)',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_poc_sulf ,'p_sed_poc_sulf','mol/kg/d','recycling of sedimentary poc to dic using sulfate (sulfate reduction)',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_det_sedi_sed ,'p_det_sedi_sed','mol/kg/d','detritus sedimentation',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_poc_sedi_sed ,'p_poc_sedi_sed','mol/kg/d','poc sedimentation',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_pocn_sedi_sed,'p_pocn_sedi_sed','mol/kg/d','pocn sedimentation',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_pocp_sedi_sed,'p_pocp_sedi_sed','mol/kg/d','pocp sedimentation',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_ero_pocn ,'p_sed_ero_pocn','mol/kg/d','sedimentary pocn erosion',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_ero_pocp ,'p_sed_ero_pocp','mol/kg/d','sedimentary pocp erosion',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_biores_poc,'p_sed_biores_poc','mol/kg/d','bio resuspension of sedimentary poc',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_biores_pocn,'p_sed_biores_pocn','mol/kg/d','bio resuspension of sedimentary pocn',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_biores_pocp,'p_sed_biores_pocp','mol/kg/d','bio resuspension of sedimentary pocp',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_burial   ,'p_sed_burial','mol/kg/d','burial of detritus deeper than max_sed',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_poc_burial   ,'p_poc_burial','mol/kg/d','burial of poc deeper than max_sed',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_pocn_burial  ,'p_pocn_burial','mol/kg/d','burial of pocn deeper than max_sed',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_pocp_burial  ,'p_pocp_burial','mol/kg/d','burial of pocp deeper than max_sed',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_pocn_resp,'p_sed_pocn_resp','mol/kg/d','recycling of sedimentary pocn to dic and NH4 using oxygen (respiration)',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_pocp_resp,'p_sed_pocp_resp','mol/kg/d','recycling of sedimentary pocp to dic and PO4 using oxygen (respiration)',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_p_sed_pocp_denit,'p_sed_pocp_denit','mol/kg/d','recycling of sedimentary pocp to dic and PO4 using nitrate (denitrification)',     &
         output=output_instantaneous,source=source_do_bottom)
   call self%register_horizontal_diagnostic_variable(self%id_pco2           ,'pco2','1.0','co2 partial pressure [Pa]',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_schmidtnumber_co2,'schmidtnumber_co2','1.0','Schmidt number for CO2 surface flux [1]',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_schmidtnumber_o2,'schmidtnumber_o2','1.0','Schmidt number for oxygen surface flux [1]',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_schmidtnumber_n2,'schmidtnumber_n2','1.0','Schmidt number for nitrogen surface flux [1]',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_p_n2_stf_down  ,'p_n2_stf_down','mol/kg/d','downward nitrogen flux through the surface',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_p_n2_stf_up    ,'p_n2_stf_up','mol/kg/d','upward nitrogen flux through the surface',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_p_o2_stf_down  ,'p_o2_stf_down','mol/kg/d','downward oxygen flux through the surface',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_p_o2_stf_up    ,'p_o2_stf_up','mol/kg/d','upward oxygen flux through the surface',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_p_co2_stf_down ,'p_co2_stf_down','mol/kg/d','downward co2 flux through the surface',     &
         output=output_instantaneous,source=source_do_surface)
   call self%register_horizontal_diagnostic_variable(self%id_p_co2_stf_up   ,'p_co2_stf_up','mol/kg/d','upward co2 flux through the surface',     &
         output=output_instantaneous,source=source_do_surface)
 
! Register environmental dependencies
   call self%register_dependency(self%id_par,standard_variables%downwelling_photosynthetic_radiative_flux)
   call self%register_dependency(self%id_temp,standard_variables%temperature)
   call self%register_dependency(self%id_salt,standard_variables%practical_salinity)
   call self%register_dependency(self%id_I_0,standard_variables%surface_downwelling_photosynthetic_radiative_flux)
   call self%register_dependency(self%id_wind,standard_variables%wind_speed)
   call self%register_dependency(self%id_depth,standard_variables%bottom_depth)
   call self%register_dependency(self%id_taub,standard_variables%bottom_stress)
   call self%register_dependency(self%id_lat,standard_variables%latitude)
   call self%register_dependency(self%id_lon,standard_variables%longitude)

   call self%register_dependency(self%id_timestep,standard_variables%maximum_time_step)
   call self%register_dependency(self%id_diffusivity,type_interior_standard_variable(name='vertical_tracer_diffusivity', units='m2 s-1'))

   return

   END subroutine initialize
!EOC


!-----------------------------------------------------------------------
!BOP
!
! !IROUTINE: Right hand sides of ergom model
!
! !INTERFACE:
   subroutine do(self,_ARGUMENTS_DO_)
!!
! !USES:
   IMPLICIT NONE
!
! !INPUT PARAMETERS:
   class(type_bsh_ergom_neccton), INTENT(IN) :: self
  _DECLARE_ARGUMENTS_DO_
!
!
! !LOCAL VARIABLES:
    real(rk)        :: critical_stress
    real(rk)        :: cya0           
    real(rk)        :: din_min_lpp    
    real(rk)        :: din_min_spp    
    real(rk)        :: dip_min_cya    
    real(rk)        :: epsilon        
    real(rk)        :: food_min_zoo   
    real(rk)        :: gamma0         
    real(rk)        :: gamma1         
    real(rk)        :: gamma2         
    real(rk)        :: gamma3         
    real(rk)        :: h2s_min_po4_liber
    real(rk)        :: ips_threshold  
    real(rk)        :: ips_cl         
    real(rk)        :: k_h2s_no3      
    real(rk)        :: k_h2s_o2       
    real(rk)        :: k_sul_no3      
    real(rk)        :: k_sul_o2       
    real(rk)        :: light_opt_cya  
    real(rk)        :: light_opt_lpp  
    real(rk)        :: light_opt_spp  
    real(rk)        :: lpp0           
    real(rk)        :: no3_min_sed_denit
    real(rk)        :: no3_min_det_denit
    real(rk)        :: o2_min_det_resp
    real(rk)        :: o2_min_nit     
    real(rk)        :: o2_min_po4_retent
    real(rk)        :: o2_min_sed_resp
    real(rk)        :: patm_co2       
    real(rk)        :: q10_det_rec    
    real(rk)        :: q10_doc_rec    
    real(rk)        :: q10_h2s        
    real(rk)        :: q10_nit        
    real(rk)        :: q10_sed_rec    
    real(rk)        :: r_biores       
    real(rk)        :: r_cya_assim    
    real(rk)        :: r_cya_resp     
    real(rk)        :: r_det_rec      
    real(rk)        :: r_ips_burial   
    real(rk)        :: r_ips_ero      
    real(rk)        :: r_ips_liber    
    real(rk)        :: r_lpp_assim    
    real(rk)        :: r_lpp_resp     
    real(rk)        :: r_nh4_nitrif   
    real(rk)        :: r_pp_mort      
    real(rk)        :: r_cya_mort_diff
    real(rk)        :: r_cya_mort_thresh
    real(rk)        :: r_sed_ero      
    real(rk)        :: r_sed_rec      
    real(rk)        :: r_sed_poc_rec  
    real(rk)        :: r_spp_assim    
    real(rk)        :: r_spp_resp     
    real(rk)        :: r_zoo_graz     
    real(rk)        :: r_zoo_mort     
    real(rk)        :: r_zoo_resp     
    real(rk)        :: rfr_c          
    real(rk)        :: rfr_h          
    real(rk)        :: rfr_o          
    real(rk)        :: rfr_p          
    real(rk)        :: rfr_cp         
    real(rk)        :: sali_max_cya   
    real(rk)        :: sali_min_cya   
    real(rk)        :: nit_max_cya    
    real(rk)        :: nit_switch_cya 
    real(rk)        :: sed_max        
    real(rk)        :: sed_burial     
    real(rk)        :: spp0           
    real(rk)        :: temp_min_cya   
    real(rk)        :: temp_switch_cya
    real(rk)        :: temp_min_spp   
    real(rk)        :: temp_opt_zoo   
    real(rk)        :: w_co2_stf      
    real(rk)        :: w_cya          
    real(rk)        :: w_det          
    real(rk)        :: w_ipw          
    real(rk)        :: w_det_sedi     
    real(rk)        :: w_ipw_sedi     
    real(rk)        :: w_lpp          
    real(rk)        :: w_n2_stf       
    real(rk)        :: w_o2_stf       
    real(rk)        :: zoo0           
    real(rk)        :: zoo_cl         
    real(rk)        :: don_fraction   
    real(rk)        :: r_poc_rec      
    real(rk)        :: r_pocp_rec     
    real(rk)        :: r_pocn_rec     
    real(rk)        :: w_poc          
    real(rk)        :: w_poc_sedi     
    real(rk)        :: w_pocp         
    real(rk)        :: w_pocp_sedi    
    real(rk)        :: w_pocn         
    real(rk)        :: w_pocn_sedi    
    real(rk)        :: fac_doc_assim_lpp
    real(rk)        :: fac_doc_assim_cya
    real(rk)        :: fac_doc_assim_spp
    real(rk)        :: fac_dop_assim  
    real(rk)        :: fac_don_assim  
    real(rk)        :: fac_enh_rec    
    real(rk)        :: ret_po4_1      
    real(rk)        :: ret_po4_2      
    real(rk)        :: frac_denit_scal
    real(rk)        :: reduced_rec    
    real(rk)        :: martin_fac_poc 
    real(rk)        :: r_doc2poc      
    real(rk)        :: r_don2pocn     
    real(rk)        :: r_dop2pocp     
    real(rk)        :: r_doc_rec      
    real(rk)        :: r_don_rec      
    real(rk)        :: r_dop_rec      
    real(rk)        :: fac_ips_burial 
    real(rk)        :: r_cdom_decay   
    real(rk)        :: r_cdom_light   
    real(rk)        :: ten            
    real(rk)        :: zero           
    real(rk)        :: one            
    real(rk)        :: three          
    real(rk)        :: min_chl_n      
    real(rk)        :: max_chl_n      
    real(rk)        :: light_max      
    real(rk)        :: molar_mass_C   
    real(rk)        :: I_h            
    real(rk)        :: t_n2           
    real(rk)        :: t_o2           
    real(rk)        :: t_dic          
    real(rk)        :: t_nh4          
    real(rk)        :: t_no3          
    real(rk)        :: t_po4          
    real(rk)        :: t_spp          
    real(rk)        :: t_zoo          
    real(rk)        :: t_h2s          
    real(rk)        :: t_sul          
    real(rk)        :: t_alk          
    real(rk)        :: t_ipw          
    real(rk)        :: t_lpp          
    real(rk)        :: t_cya          
    real(rk)        :: t_det          
    real(rk)        :: t_poc          
    real(rk)        :: t_pocp         
    real(rk)        :: t_pocn         
    real(rk)        :: t_doc          
    real(rk)        :: t_dop          
    real(rk)        :: t_don          
    real(rk)        :: t_cdom         
    real(rk)        :: temp_k         
    real(rk)        :: ph_temp        
    real(rk)        :: k_water        
    real(rk)        :: k0_co2         
    real(rk)        :: k1_co2         
    real(rk)        :: k2_co2         
    real(rk)        :: k_boron        
    real(rk)        :: k1_po4         
    real(rk)        :: k2_po4         
    real(rk)        :: k3_po4         
    real(rk)        :: k1_h2s         
    real(rk)        :: boron_total    
    real(rk)        :: alk_boron      
    real(rk)        :: alk_h2s        
    real(rk)        :: alk_water      
    real(rk)        :: alk_po4_denominator
    real(rk)        :: alk_po4        
    real(rk)        :: alk_co2_denominator
    real(rk)        :: alk_co2        
    real(rk)        :: alk_residual   
    real(rk)        :: dalkp_dh3o     
    real(rk)        :: dalkc_dh3o     
    real(rk)        :: dalkresidual_dpH
    real(rk)        :: ph             
    real(rk)        :: h3o            
    real(rk)        :: o2_sat         
    real(rk)        :: n2_sat         
    real(rk)        :: solubility_n2  
    real(rk)        :: temp_sq        
    real(rk)        :: zoo_eff        
    real(rk)        :: din            
    real(rk)        :: din_sq         
    real(rk)        :: po4_sq         
    real(rk)        :: phyto          
    real(rk)        :: lpp_plus_lpp0  
    real(rk)        :: spp_plus_spp0  
    real(rk)        :: cya_plus_cya0  
    real(rk)        :: food_zoo       
    real(rk)        :: lim_light_lpp  
    real(rk)        :: lim_light_spp  
    real(rk)        :: lim_light_cya  
    real(rk)        :: lr_assim_lpp   
    real(rk)        :: lr_assim_lpp_doc
    real(rk)        :: lr_assim_spp_doc
    real(rk)        :: lr_assim_cya_doc
    real(rk)        :: lr_assim_spp   
    real(rk)        :: lr_assim_cya   
    real(rk)        :: lr_assim_lpp_dop
    real(rk)        :: lr_assim_spp_dop
    real(rk)        :: lr_assim_lpp_don
    real(rk)        :: lr_assim_spp_don
    real(rk)        :: lr_graz_zoo    
    real(rk)        :: frac_po4retent 
    real(rk)        :: ref_p_sw       
    real(rk)        :: ref_n_sw       
    real(rk)        :: lr_pocp        
    real(rk)        :: lr_dop         
    real(rk)        :: lr_pocn        
    real(rk)        :: lr_don         
    real(rk)        :: w_poc_var      
    real(rk)        :: w_pocn_var     
    real(rk)        :: w_pocp_var     
    real(rk)        :: phyto_C        
    real(rk)        :: cdom_decay     
    real(rk)        :: zoo_C          
    real(rk)        :: lpp_C          
    real(rk)        :: spp_C          
    real(rk)        :: cya_C          
    real(rk)        :: pp_total       
    real(rk)        :: resp_total     
    real(rk)        :: net_pp         
    real(rk)        :: chl_a          
    real(rk)        :: KD             
    real(rk)        :: secchi_depth   
    real(rk)        :: det_C          
    real(rk)        :: chl_a_C        
    real(rk)        :: chl_a_lpp_C    
    real(rk)        :: chl_a_spp_C    
    real(rk)        :: chl_a_cya_C    
    real(rk)        :: cdom3_C        
    real(rk)        :: cdom2_C        
    real(rk)        :: cdom1_C        
    real(rk)        :: r_zoo_mort_light
    real(rk)        :: lim_t_n2_7          
    real(rk)        :: lim_t_o2_0          
    real(rk)        :: lim_t_o2_2          
    real(rk)        :: lim_t_o2_4          
    real(rk)        :: lim_t_o2_6          
    real(rk)        :: lim_t_dic_8         
    real(rk)        :: lim_t_nh4_11        
    real(rk)        :: lim_t_no3_1         
    real(rk)        :: lim_t_no3_3         
    real(rk)        :: lim_t_no3_10        
    real(rk)        :: lim_t_po4_9         
    real(rk)        :: lim_t_spp_16        
    real(rk)        :: lim_t_zoo_18        
    real(rk)        :: lim_t_h2s_5         
    real(rk)        :: lim_t_h2s_23        
    real(rk)        :: lim_t_sul_24        
    real(rk)        :: lim_t_ipw_25        
    real(rk)        :: lim_t_lpp_15        
    real(rk)        :: lim_t_cya_17        
    real(rk)        :: lim_t_det_19        
    real(rk)        :: lim_t_poc_12        
    real(rk)        :: lim_t_pocp_13       
    real(rk)        :: lim_t_pocn_14       
    real(rk)        :: lim_t_doc_28        
    real(rk)        :: lim_t_dop_29        
    real(rk)        :: lim_t_don_30        
    real(rk)        :: lim_t_cdom_31       
    real(rk)        :: p_no3_assim_lpp
    real(rk)        :: p_nh4_assim_lpp
    real(rk)        :: p_no3_assim_spp
    real(rk)        :: p_nh4_assim_spp
    real(rk)        :: p_n2_assim_cya 
    real(rk)        :: p_assim_lpp_doc
    real(rk)        :: p_assim_spp_doc
    real(rk)        :: p_assim_cya_doc
    real(rk)        :: p_assim_lpp_dop
    real(rk)        :: p_assim_spp_dop
    real(rk)        :: p_nh4_assim_lpp_don
    real(rk)        :: p_no3_assim_lpp_don
    real(rk)        :: p_nh4_assim_spp_don
    real(rk)        :: p_no3_assim_spp_don
    real(rk)        :: p_poc_resp     
    real(rk)        :: p_poc_denit    
    real(rk)        :: p_poc_sulf     
    real(rk)        :: p_pocp_resp    
    real(rk)        :: p_pocp_denit   
    real(rk)        :: p_pocp_sulf    
    real(rk)        :: p_pocn_resp    
    real(rk)        :: p_pocn_denit   
    real(rk)        :: p_pocn_sulf    
    real(rk)        :: p_lpp_graz_zoo 
    real(rk)        :: p_spp_graz_zoo 
    real(rk)        :: p_cya_graz_zoo 
    real(rk)        :: p_lpp_resp_nh4 
    real(rk)        :: p_spp_resp_nh4 
    real(rk)        :: p_cya_resp_nh4 
    real(rk)        :: p_zoo_resp_nh4 
    real(rk)        :: p_lpp_mort_det 
    real(rk)        :: p_spp_mort_det 
    real(rk)        :: p_cya_mort_det 
    real(rk)        :: p_cya_mort_det_diff
    real(rk)        :: p_zoo_mort_det 
    real(rk)        :: p_nh4_nit_no3  
    real(rk)        :: p_det_resp_nh4 
    real(rk)        :: p_det_denit_nh4
    real(rk)        :: p_det_sulf_nh4 
    real(rk)        :: p_h2s_oxo2_sul 
    real(rk)        :: p_h2s_oxno3_sul
    real(rk)        :: p_sul_oxo2_so4 
    real(rk)        :: p_sul_oxno3_so4
    real(rk)        :: p_doc2pco      
    real(rk)        :: p_dop2pocp     
    real(rk)        :: p_don2pocn     
    real(rk)        :: p_doc_resp     
    real(rk)        :: p_doc_denit    
    real(rk)        :: p_doc_sulf     
    real(rk)        :: p_dop_resp     
    real(rk)        :: p_dop_denit    
    real(rk)        :: p_dop_sulf     
    real(rk)        :: p_don_resp     
    real(rk)        :: p_don_denit    
    real(rk)        :: p_don_sulf     
    real(rk)        :: p_cdom_decay   
    real(rk)        :: cgt_temp
    real(rk)        :: cgt_sali
    real(rk)        :: cgt_light
    real(rk)        :: cgt_density
    real(rk)        :: cgt_longitude
    real(rk)        :: cgt_latitude
    real(rk)        :: cgt_timestep
    real(rk)        :: cgt_diffusivity
    real(rk)        :: cgt_bottomdepth
    real(rk)        :: secs_pr_day=86400.0_rk
    real(rk)        :: inv_secs_pr_day
    real(rk)        :: temp1, temp2, temp3, temp4, temp5, &
                       temp6, temp7, temp8, temp9
    real(rk)        :: cgt_iteration    
!    integer        :: cgt_iteration        ! current number of iteration in the iterative loop
!EOP
!-----------------------------------------------------------------------
!BOC
!   Store values of constants in local variables
    inv_secs_pr_day = 1.0_rk/secs_pr_day
    critical_stress = self%critical_stress
    cya0            = self%cya0           
    din_min_lpp     = self%din_min_lpp    
    din_min_spp     = self%din_min_spp    
    dip_min_cya     = self%dip_min_cya    
    epsilon         = self%epsilon        
    food_min_zoo    = self%food_min_zoo   
    gamma0          = self%gamma0         
    gamma1          = self%gamma1         
    gamma2          = self%gamma2         
    gamma3          = self%gamma3         
    h2s_min_po4_liber = self%h2s_min_po4_liber
    ips_threshold   = self%ips_threshold  
    ips_cl          = self%ips_cl         
    k_h2s_no3       = self%k_h2s_no3      
    k_h2s_o2        = self%k_h2s_o2       
    k_sul_no3       = self%k_sul_no3      
    k_sul_o2        = self%k_sul_o2       
    light_opt_cya   = self%light_opt_cya  
    light_opt_lpp   = self%light_opt_lpp  
    light_opt_spp   = self%light_opt_spp  
    lpp0            = self%lpp0           
    no3_min_sed_denit = self%no3_min_sed_denit
    no3_min_det_denit = self%no3_min_det_denit
    o2_min_det_resp = self%o2_min_det_resp
    o2_min_nit      = self%o2_min_nit     
    o2_min_po4_retent = self%o2_min_po4_retent
    o2_min_sed_resp = self%o2_min_sed_resp
    patm_co2        = self%patm_co2       
    q10_det_rec     = self%q10_det_rec    
    q10_doc_rec     = self%q10_doc_rec    
    q10_h2s         = self%q10_h2s        
    q10_nit         = self%q10_nit        
    q10_sed_rec     = self%q10_sed_rec    
    r_biores        = self%r_biores       
    r_cya_assim     = self%r_cya_assim    
    r_cya_resp      = self%r_cya_resp     
    r_det_rec       = self%r_det_rec      
    r_ips_burial    = self%r_ips_burial   
    r_ips_ero       = self%r_ips_ero      
    r_ips_liber     = self%r_ips_liber    
    r_lpp_assim     = self%r_lpp_assim    
    r_lpp_resp      = self%r_lpp_resp     
    r_nh4_nitrif    = self%r_nh4_nitrif   
    r_pp_mort       = self%r_pp_mort      
    r_cya_mort_diff = self%r_cya_mort_diff
    r_cya_mort_thresh = self%r_cya_mort_thresh
    r_sed_ero       = self%r_sed_ero      
    r_sed_rec       = self%r_sed_rec      
    r_sed_poc_rec   = self%r_sed_poc_rec  
    r_spp_assim     = self%r_spp_assim    
    r_spp_resp      = self%r_spp_resp     
    r_zoo_graz      = self%r_zoo_graz     
    r_zoo_mort      = self%r_zoo_mort     
    r_zoo_resp      = self%r_zoo_resp     
    rfr_c           = self%rfr_c          
    rfr_h           = self%rfr_h          
    rfr_o           = self%rfr_o          
    rfr_p           = self%rfr_p          
    rfr_cp          = self%rfr_cp         
    sali_max_cya    = self%sali_max_cya   
    sali_min_cya    = self%sali_min_cya   
    nit_max_cya     = self%nit_max_cya    
    nit_switch_cya  = self%nit_switch_cya 
    sed_max         = self%sed_max        
    sed_burial      = self%sed_burial     
    spp0            = self%spp0           
    temp_min_cya    = self%temp_min_cya   
    temp_switch_cya = self%temp_switch_cya
    temp_min_spp    = self%temp_min_spp   
    temp_opt_zoo    = self%temp_opt_zoo   
    w_co2_stf       = self%w_co2_stf      
    w_cya           = self%w_cya          
    w_det           = self%w_det          
    w_ipw           = self%w_ipw          
    w_det_sedi      = self%w_det_sedi     
    w_ipw_sedi      = self%w_ipw_sedi     
    w_lpp           = self%w_lpp          
    w_n2_stf        = self%w_n2_stf       
    w_o2_stf        = self%w_o2_stf       
    zoo0            = self%zoo0           
    zoo_cl          = self%zoo_cl         
    don_fraction    = self%don_fraction   
    r_poc_rec       = self%r_poc_rec      
    r_pocp_rec      = self%r_pocp_rec     
    r_pocn_rec      = self%r_pocn_rec     
    w_poc           = self%w_poc          
    w_poc_sedi      = self%w_poc_sedi     
    w_pocp          = self%w_pocp         
    w_pocp_sedi     = self%w_pocp_sedi    
    w_pocn          = self%w_pocn         
    w_pocn_sedi     = self%w_pocn_sedi    
    fac_doc_assim_lpp = self%fac_doc_assim_lpp
    fac_doc_assim_cya = self%fac_doc_assim_cya
    fac_doc_assim_spp = self%fac_doc_assim_spp
    fac_dop_assim   = self%fac_dop_assim  
    fac_don_assim   = self%fac_don_assim  
    fac_enh_rec     = self%fac_enh_rec    
    ret_po4_1       = self%ret_po4_1      
    ret_po4_2       = self%ret_po4_2      
    frac_denit_scal = self%frac_denit_scal
    reduced_rec     = self%reduced_rec    
    martin_fac_poc  = self%martin_fac_poc 
    r_doc2poc       = self%r_doc2poc      
    r_don2pocn      = self%r_don2pocn     
    r_dop2pocp      = self%r_dop2pocp     
    r_doc_rec       = self%r_doc_rec      
    r_don_rec       = self%r_don_rec      
    r_dop_rec       = self%r_dop_rec      
    fac_ips_burial  = self%fac_ips_burial 
    r_cdom_decay    = self%r_cdom_decay   
    r_cdom_light    = self%r_cdom_light   
    ten             = self%ten            
    zero            = self%zero           
    one             = self%one            
    three           = self%three          
    min_chl_n       = self%min_chl_n      
    max_chl_n       = self%max_chl_n      
    light_max       = self%light_max      
    molar_mass_C    = self%molar_mass_C   
    I_h             = self%I_h            

!   Enter spatial_loops (if any)
    _LOOP_BEGIN_

!   Retrieve current (local) state variable values
    _GET_(self%id_t_n2           ,t_n2           ) !dissolved molecular nitrogen
    _GET_(self%id_t_o2           ,t_o2           ) !dissolved oxygen
    _GET_(self%id_t_dic          ,t_dic          ) !dissolved inorganic carbon, treated as carbon dioxide
    _GET_(self%id_t_nh4          ,t_nh4          ) !ammonium
    _GET_(self%id_t_no3          ,t_no3          ) !nitrate
    _GET_(self%id_t_po4          ,t_po4          ) !phosphate
    _GET_(self%id_t_spp          ,t_spp          ) !small-cell phytoplankton
    _GET_(self%id_t_zoo          ,t_zoo          ) !zooplankton
    _GET_(self%id_t_h2s          ,t_h2s          ) !hydrogen sulfide
    _GET_(self%id_t_sul          ,t_sul          ) !sulfur
    _GET_(self%id_t_alk          ,t_alk          ) !total alkalinity
    _GET_(self%id_t_ipw          ,t_ipw          ) !suspended iron phosphate
    _GET_(self%id_t_lpp          ,t_lpp          ) !large-cell phytoplankton
    _GET_(self%id_t_cya          ,t_cya          ) !diazotroph cyanobacteria
    _GET_(self%id_t_det          ,t_det          ) !detritus
    _GET_(self%id_t_poc          ,t_poc          ) !particulate organic carbon
    _GET_(self%id_t_pocp         ,t_pocp         ) !phosphorus in particulate organic carbon in Redfield ratio
    _GET_(self%id_t_pocn         ,t_pocn         ) !nitrogen in particulate organic carbon in Redfield ratio
    _GET_(self%id_t_doc          ,t_doc          ) !dissolved organic carbon
    _GET_(self%id_t_dop          ,t_dop          ) !phosphorus in dissolved organic carbon in Redfield ratio
    _GET_(self%id_t_don          ,t_don          ) !nitrogen in dissolved organic carbon in Redfield ratio
    _GET_(self%id_t_cdom         ,t_cdom         ) !colored dissolved organic carbon

!   Retrieve current environmental conditions
    _GET_   (self%id_par,cgt_light)    ! local photosynthetically active radiation
    _GET_   (self%id_temp,cgt_temp)    !local water temperature
    _GET_   (self%id_salt,cgt_sali)    !local water temperature
    _GET_   (self%id_diffusivity,cgt_diffusivity)    !local tracer diffusivity
    _GET_GLOBAL_(self%id_timestep,cgt_timestep)    ! integration time step [s]
    _GET_HORIZONTAL_(self%id_lon,cgt_longitude)! Longitude [degE]
    _GET_HORIZONTAL_(self%id_lat,cgt_latitude) ! Latitude  [degN]
    _GET_HORIZONTAL_(self%id_depth,cgt_bottomdepth) !local water depth
    cgt_density = 1035.0_rk               ! Boussinesq density
    cgt_timestep  = cgt_timestep/secs_pr_day  ! ecosystem model time step [d]

!  if ((cgt_longitude .gt. 11.68).and.(cgt_longitude .lt. 11.72)) then 
!  if ((cgt_latitude .gt. 54.83).and.(cgt_latitude .lt. 54.87)) then
   
!  WRITE(*,*) "subroutine do started"
!  WRITE(*,*) "t_dic=",t_dic
 
! endif
! endif
  
! Initialize auxiliaries for iterative loop
             temp_k          = 0.0
             ph_temp         = 0.0
             k_water         = 0.0
             k0_co2          = 0.0
             k1_co2          = 0.0
             k2_co2          = 0.0
             k_boron         = 0.0
             k1_po4          = 0.0
             k2_po4          = 0.0
             k3_po4          = 0.0
             k1_h2s          = 0.0
             boron_total     = 0.0
             alk_boron       = 0.0
             alk_h2s         = 0.0
             alk_water       = 0.0
             alk_po4_denominator = 0.0
             alk_po4         = 0.0
             alk_co2_denominator = 0.0
             alk_co2         = 0.0
             alk_residual    = 0.0
             dalkp_dh3o      = 0.0
             dalkc_dh3o      = 0.0
             dalkresidual_dpH = 0.0
             ph              = 0.0
             h3o             = 1.0e-8

! Iterative loop follows
             do cgt_iteration=1,10
                if (cgt_iteration .le. 1) then
                   ! absolute temperature [K] :
                   temp_k          = cgt_temp + 273.15             
                endif
                if (cgt_iteration .le. 10) then
                   ! temporary value assumed for pH [1] :
                   ph_temp         = 0.0-log(h3o)/log(10.0)        
                endif
                if (cgt_iteration .le. 1) then
                   ! self-ionization constant of Water [mol2/kg2] :
                   k_water         = exp( -13847.26 / temp_k + 148.96502 - 23.6521 * log(temp_k) + (118.67/temp_k - 5.977 + 1.0495 * log(temp_k)) * sqrt(cgt_sali) - 0.01615 * cgt_sali)
                endif
                if (cgt_iteration .le. 1) then
                   ! Solubility of CO2 [mol/kg/Pa] :
                   k0_co2          = exp(9345.17 / temp_k - 60.2409 + 23.3585 * (log(temp_k) - 4.605170186) + cgt_sali*(0.023517 - 0.00023656 * temp_k + 0.00000047036 *temp_k*temp_k))/101325.0
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant CO2 + 2 H2O <-> HCO3- + H3O+ [mol/kg] :
                   k1_co2          = power(ten,( -3633.86 / temp_k + 61.2172 - 9.6777 * log(temp_k) + 0.011555 * cgt_sali - 0.0001152 * cgt_sali * cgt_sali))
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant HCO3- + H2O <-> [CO3 2-] + H3O+ [mol/kg] :
                   k2_co2          = power(ten,( -471.78 / temp_k - 25.929 + 3.16967 * log(temp_k) + 0.01781 * cgt_sali - 0.0001122 * cgt_sali * cgt_sali))
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant of boric acid [mol/kg] :
                   k_boron         = exp(( -8966.9 - 2890.53*sqrt(cgt_sali) - 77.942*cgt_sali + 1.728*cgt_sali*sqrt(cgt_sali) - 0.0996*cgt_sali*cgt_sali) / temp_k + 148.0248 + 137.1942*sqrt(cgt_sali) + 1.62142*cgt_sali + (-24.4344 - 25.085*sqrt(cgt_sali &
) - 0.2474*cgt_sali)*log(temp_k) + 0.053105*sqrt(cgt_sali)*temp_k )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant H3PO4 + H2O <-> [H2PO4 -] + H3O+ [mol/kg] :
                   k1_po4          = exp( -4576.752/temp_k + 115.525 - 18.453*log(temp_k) + (0.69171 - 106.736/temp_k)*sqrt(cgt_sali) - (0.01844 + 0.65643/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant [H2PO4 -] + H2O+ <-> [HPO4 2-] + H3O+ [mol/kg] :
                   k2_po4          = exp( -8814.715/temp_k + 172.0883 - 27.927*log(temp_k) + (1.35660 - 160.340/temp_k)*sqrt(cgt_sali) - (0.05778 - 0.37335/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant [HPO4 2-] + H2O <-> [PO4 3-] + H3O+ [mol/kg] :
                   k3_po4          = exp( -3070.75/temp_k - 18.141 + (2.81197 + 17.27039/temp_k)*sqrt(cgt_sali) - (0.09984 + 44.99486/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant H2S + H2O <-> HS- + H3O+ [mol/kg] :
                   k1_h2s          = exp( -3131.42/temp_k + 5.818 + 0.368*(power(max(zero,cgt_sali),(one/three))))
                endif
                if (cgt_iteration .le. 1) then
                   ! total concentration of boron [mol/kg] :
                   boron_total     = 0.000416 * cgt_sali/35.0      
                endif
                if (cgt_iteration .le. 10) then
                   ! boron alkalinity [mol/kg] :
                   alk_boron       = boron_total * k_boron / (k_boron + h3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! hydrogen sulfide alkalinity [mol/kg] :
                   alk_h2s         = t_h2s * k1_h2s / (k1_h2s + h3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! water alkalinity [mol/kg] :
                   alk_water       = k_water / h3o - h3o           
                endif
                if (cgt_iteration .le. 10) then
                   ! denominator in phosphate alkalinity formula [mol3/kg3] :
                   alk_po4_denominator = (h3o*h3o*h3o + k1_po4*h3o*h3o + k1_po4*k2_po4*h3o + k1_po4*k2_po4*k3_po4)
                endif
                if (cgt_iteration .le. 10) then
                   ! phosphate alkalinity [mol/kg] :
                   alk_po4         = t_po4*(k1_po4*k2_po4*h3o + 2.0*k1_po4*k2_po4*k3_po4 - h3o*h3o*h3o) / alk_po4_denominator
                endif
                if (cgt_iteration .le. 10) then
                   ! denominator in carbonate alkalinity formula [mol2/kg2] :
                   alk_co2_denominator = (h3o*h3o + k1_co2*h3o + k1_co2*k2_co2)
                endif
                if (cgt_iteration .le. 10) then
                   ! carbonate alkalinity [mol/kg] :
                   alk_co2         = t_dic*k1_co2*(h3o+2*k2_co2)/alk_co2_denominator
                endif
                if (cgt_iteration .le. 10) then
                   ! error in total alkalinity calculation at the assumed pH [mol/kg] :
                   alk_residual    = t_alk - alk_co2 - alk_po4 - alk_boron - alk_h2s - alk_water
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of phosphate alkalinity with respect to h3o [1] :
                   dalkp_dh3o      = t_po4*(0.0-k1_po4*h3o*h3o*h3o*h3o-4*k1_po4*k2_po4*h3o*h3o*h3o-(k1_po4*k1_po4*k2_po4+9*k1_po4*k2_po4*k3_po4)*h3o*h3o-4*k1_po4*k1_po4*k2_po4*k3_po4*h3o-k1_po4*k1_po4*k2_po4*k2_po4*k3_po4 &
)/(alk_po4_denominator*alk_po4_denominator)
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of carbonate alkalinity with respect to h3o [1] :
                   dalkc_dh3o      = t_dic*(0.0-k1_co2*h3o*h3o-k1_co2*k1_co2*k2_co2-4*k1_co2*k2_co2*h3o)/(alk_co2_denominator*alk_co2_denominator)
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of residual_alk with respect to pH [mol/kg] :
                   dalkresidual_dpH = 0.0-log(10.0)*h3o*(alk_boron/(k_boron+h3o)+alk_h2s/(k1_h2s+h3o)+k_water/(h3o*h3o)+1-dalkp_dh3o-dalkc_dh3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! newly determined pH value [1] :
                   temp1 = alk_residual/dalkresidual_dpH 
                   ph              = ph_temp - temp1 + theta(abs(temp1) - 1)*0.5*temp1
                endif
                if (cgt_iteration .le. 10) then
                   ! h3o ion concentration [mol/kg] :
                   h3o             = power(ten,0.0-max(one,min((ten+three),ph)))
                endif
             enddo

!   Calculation of auxiliary variables (not iterative)
    o2_sat          = (10.18e0+((5.306e-3-4.8725e-5*cgt_temp)*cgt_temp-0.2785e0)*cgt_temp+cgt_sali*((2.2258e-3+(4.39e-7*cgt_temp-4.645e-5)*cgt_temp)*cgt_temp-6.33e-2))*44.66e0*1e-6
    temp1 = log((298.15-cgt_temp)/(273.15+cgt_temp))
    temp2 = temp1*temp1                   
    temp3 = temp2*temp1                   
    n2_sat          = 1e-6*exp(6.42931 + 2.92704*temp1 + 4.32531*temp2 + 4.69149*temp3 + cgt_sali*(0.0 - 7.44129e-3 - 8.02566e-3*temp1 - 1.46775e-2*temp2))
    solubility_n2   = n2_sat * 1.263925e-5          
    temp_sq         = max(0.0,cgt_temp)*max(0.0,cgt_temp)
    zoo_eff         = t_zoo*t_zoo/zoo_cl            
    din             = t_no3+t_nh4                   
    din_sq          = din*din                       
    po4_sq          = t_po4*t_po4                   
    phyto           = t_lpp+t_spp+t_cya             
    lpp_plus_lpp0   = t_lpp+lpp0                    
    spp_plus_spp0   = t_spp+spp0                    
    cya_plus_cya0   = t_cya+cya0                    
    food_zoo        = t_lpp+t_spp+0.5*t_cya         
    temp1 = max(cgt_light/2.0,light_opt_lpp)
    lim_light_lpp   = cgt_light/temp1*exp(1-cgt_light/temp1)
    temp1 = max(cgt_light/2.0,light_opt_spp)
    lim_light_spp   = cgt_light/temp1*exp(1-cgt_light/temp1)
    temp1 = max(cgt_light/2.0,light_opt_cya)
    lim_light_cya   = cgt_light/temp1*exp(1-cgt_light/temp1)
    lr_assim_lpp    = r_lpp_assim*theta(t_o2-2*t_h2s)*min(din_sq/(din_sq+din_min_lpp*din_min_lpp),min(po4_sq/(po4_sq+din_min_lpp*din_min_lpp*rfr_p*rfr_p),lim_light_lpp))
    lr_assim_lpp_doc = fac_doc_assim_lpp * r_lpp_assim * theta(t_o2-2*t_h2s) * min(max(1 - din_sq/(din_sq+din_min_lpp*din_min_lpp),1 - po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
    lr_assim_spp_doc = fac_doc_assim_spp * r_spp_assim * theta(t_o2-2*t_h2s) * min(max(1 - din_sq/(din_sq+din_min_spp*din_min_spp),1 - po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
    lr_assim_cya_doc = fac_doc_assim_cya * r_cya_assim*theta(t_o2-2*t_h2s)*min(1 - po4_sq/(po4_sq+dip_min_cya*dip_min_cya),lim_light_cya)*(1/(1+exp(temp_switch_cya*(temp_min_cya-cgt_temp))))*(1/(1+exp(cgt_sali-sali_max_cya)) &
)*(1/(1+exp(sali_min_cya-cgt_sali)))
    lr_assim_spp    = r_spp_assim*theta(t_o2-2*t_h2s)*min(din_sq/(din_sq+din_min_spp*din_min_spp),min(po4_sq/(po4_sq+din_min_spp*din_min_spp*rfr_p*rfr_p),lim_light_spp))*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
    lr_assim_cya    = r_cya_assim*theta(t_o2-2*t_h2s)*min(po4_sq/(po4_sq+dip_min_cya*dip_min_cya),lim_light_cya)*(1/(1+exp(temp_switch_cya*(temp_min_cya-cgt_temp))))*(1/(1+exp(cgt_sali-sali_max_cya)))*(1/(1+exp(sali_min_cya-cgt_sali)) &
)*(1/(1+exp(nit_switch_cya*(din-nit_max_cya))))
    lr_assim_lpp_dop = fac_dop_assim * r_lpp_assim * theta(t_o2-2*t_h2s) * min(min(1 - din_sq/(din_sq+din_min_lpp*din_min_lpp),po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
    lr_assim_spp_dop = fac_dop_assim * r_spp_assim * theta(t_o2-2*t_h2s) * min(min(1 - din_sq/(din_sq+din_min_spp*din_min_spp),po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
    lr_assim_lpp_don = fac_don_assim * r_lpp_assim * theta(t_o2-2*t_h2s) * min(min(din_sq/(din_sq+din_min_lpp*din_min_lpp),1 - po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
    lr_assim_spp_don = fac_don_assim * r_spp_assim * theta(t_o2-2*t_h2s) * min(min(din_sq/(din_sq+din_min_spp*din_min_spp),1 - po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
    lr_graz_zoo     = r_zoo_graz*(1-exp(-food_zoo*food_zoo/(food_min_zoo*food_min_zoo)))*theta(t_o2-2*t_h2s)*(1.0+temp_sq/(temp_opt_zoo*temp_opt_zoo)*exp(2.0-cgt_temp*2.0/temp_opt_zoo))
    frac_po4retent  = ret_po4_1 + ret_po4_2*theta(cgt_latitude-60.75)
    ref_p_sw        = (1 - (po4_sq/(rfr_p*din_min_lpp*rfr_p*din_min_lpp+po4_sq)))/(1+exp(6.0*(1-din/(t_po4/rfr_p+epsilon))))
    ref_n_sw        = (1 - (din_sq/(din_min_lpp*din_min_lpp+din_sq)))/(1+exp(6.0*(1-t_po4/rfr_p/(din+epsilon))))
    lr_pocp         = r_pocp_rec*(1 + fac_enh_rec*ref_p_sw)
    lr_dop          = r_dop_rec*(1 + fac_enh_rec*ref_p_sw)
    lr_pocn         = r_pocn_rec*(1 + fac_enh_rec*ref_n_sw)
    lr_don          = r_don_rec*(1 + fac_enh_rec*ref_n_sw)
    w_poc_var       = martin_fac_poc * cgt_bottomdepth * (-1.0)
    w_pocn_var      = -0.15                         
    w_pocp_var      = -0.15                         
    phyto_C         = (t_lpp+t_spp+t_cya)*rfr_c *1000 *cgt_density
    cdom_decay      = r_cdom_decay/(0.037*12*10**6) 
    lpp_C           = t_lpp*molar_mass_C*rfr_c*1000*cgt_density
    spp_C           = t_spp*molar_mass_C*rfr_c*1000*cgt_density
    cya_C           = t_cya*molar_mass_C*rfr_c*1000*cgt_density
    chl_a           = ((t_lpp+t_spp+t_cya)*1000*cgt_density)*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    KD              = gamma0+(t_spp+t_lpp+t_cya)*gamma1*cgt_density+t_det*gamma2*cgt_density+t_cdom*gamma3*cgt_density
    secchi_depth    = theta(KD)*(1.614*KD**(-0.936)) + theta(1.0e-8-KD)*0.01
    det_C           = t_det*molar_mass_C*1000*rfr_c*cgt_density
    chl_a_C         = ((lpp_C+spp_C+cya_C))*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    chl_a_lpp_C     = lpp_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    chl_a_spp_C     = spp_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    chl_a_cya_C     = cya_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    cdom3_C         = t_cdom*molar_mass_C*1000*rfr_c*cgt_density
    cdom2_C         = 0                             
    cdom1_C         = 0                             
    r_zoo_mort_light = 0.005 + 0.035 * cgt_light/(I_h+cgt_light)

!   Calculation of process limitation factors
             lim_t_n2_7           = theta(t_n2-0.0)
             lim_t_o2_0           = 1.0-exp(-t_o2/o2_min_det_resp)
             lim_t_o2_2           = theta(t_o2-0.0)
             lim_t_o2_4           = t_o2*t_o2/(t_o2*t_o2+o2_min_po4_retent*o2_min_po4_retent)
             lim_t_o2_6           = t_o2*t_o2/(t_o2*t_o2+o2_min_sed_resp*o2_min_sed_resp)
             lim_t_dic_8          = theta(t_dic-0.0)
             lim_t_nh4_11         = theta(t_nh4-0.0)
             lim_t_no3_1          = 1.0-exp(-t_no3/no3_min_det_denit)
             lim_t_no3_3          = t_no3*t_no3/(t_no3*t_no3+no3_min_sed_denit*no3_min_sed_denit)
             lim_t_no3_10         = theta(t_no3-0.0)
             lim_t_po4_9          = theta(t_po4-0.0)
             lim_t_spp_16         = theta(t_spp-0.0)
             lim_t_zoo_18         = theta(t_zoo-0.0)
             lim_t_h2s_5          = theta(t_h2s-h2s_min_po4_liber)
             lim_t_h2s_23         = theta(t_h2s-0.0)
             lim_t_sul_24         = theta(t_sul-0.0)
             lim_t_ipw_25         = theta(t_ipw-0.0)
             lim_t_lpp_15         = theta(t_lpp-0.0)
             lim_t_cya_17         = theta(t_cya-0.0)
             lim_t_det_19         = theta(t_det-0.0)
             lim_t_poc_12         = theta(t_poc-0.0)
             lim_t_pocp_13        = theta(t_pocp-0.0)
             lim_t_pocn_14        = theta(t_pocn-0.0)
             lim_t_doc_28         = theta(t_doc-0.0)
             lim_t_dop_29         = theta(t_dop-0.0)
             lim_t_don_30         = theta(t_don-0.0)
             lim_t_cdom_31        = theta(t_cdom-0.0)

!   Calculation of process rates
    p_no3_assim_lpp = (lpp_plus_lpp0*lr_assim_lpp*t_no3/(din+epsilon))*lim_t_dic_8*lim_t_po4_9*lim_t_no3_10
    p_nh4_assim_lpp = (lpp_plus_lpp0*lr_assim_lpp*t_nh4/(din+epsilon))*lim_t_nh4_11*lim_t_po4_9*lim_t_dic_8
    p_no3_assim_spp = (spp_plus_spp0*lr_assim_spp*t_no3/(din+epsilon))*lim_t_dic_8*lim_t_po4_9*lim_t_no3_10
    p_nh4_assim_spp = (spp_plus_spp0*lr_assim_spp*t_nh4/(din+epsilon))*lim_t_nh4_11*lim_t_po4_9*lim_t_dic_8
    p_n2_assim_cya  = (cya_plus_cya0*lr_assim_cya)*lim_t_n2_7*lim_t_po4_9*lim_t_dic_8
    p_assim_lpp_doc = (rfr_c * t_lpp * lr_assim_lpp_doc)*lim_t_dic_8
    p_assim_spp_doc = (rfr_c * t_spp * lr_assim_spp_doc)*lim_t_dic_8
    p_assim_cya_doc = (rfr_c * t_cya * lr_assim_cya_doc)*lim_t_dic_8
    p_assim_lpp_dop = (rfr_p * t_lpp * lr_assim_lpp_dop)*lim_t_dic_8*lim_t_po4_9
    p_assim_spp_dop = (rfr_p * t_spp * lr_assim_spp_dop)*lim_t_po4_9*lim_t_dic_8
    p_nh4_assim_lpp_don = (t_lpp * lr_assim_lpp_don*t_nh4/(din+epsilon))*lim_t_dic_8*lim_t_nh4_11
    p_no3_assim_lpp_don = (t_lpp * lr_assim_lpp_don*t_no3/(din+epsilon))*lim_t_no3_10*lim_t_dic_8
    p_nh4_assim_spp_don = (t_spp * lr_assim_spp_don*t_nh4/(din+epsilon))*lim_t_nh4_11*lim_t_dic_8
    p_no3_assim_spp_don = (t_spp * lr_assim_spp_don*t_no3/(din+epsilon))*lim_t_dic_8*lim_t_no3_10
    p_poc_resp      = (t_poc * r_poc_rec * exp(q10_det_rec * cgt_temp))*lim_t_o2_0*lim_t_poc_12
    p_poc_denit     = (t_poc*r_poc_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*lim_t_no3_1*lim_t_poc_12
    p_poc_sulf      = (t_poc*r_poc_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*(1.0-lim_t_no3_1)*lim_t_poc_12
    p_pocp_resp     = (t_pocp * lr_pocp * exp(q10_det_rec * cgt_temp))*lim_t_o2_0*lim_t_pocp_13
    p_pocp_denit    = (t_pocp*r_pocp_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*lim_t_no3_1*lim_t_pocp_13
    p_pocp_sulf     = (t_pocp*r_pocp_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*(1.0-lim_t_no3_1)*lim_t_pocp_13
    p_pocn_resp     = (t_pocn * lr_pocn * exp(q10_det_rec * cgt_temp))*lim_t_o2_0*lim_t_pocn_14
    p_pocn_denit    = (t_pocn*r_pocn_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*lim_t_no3_1*lim_t_pocn_14
    p_pocn_sulf     = (t_pocn*r_pocn_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*(1.0-lim_t_no3_1)*lim_t_pocn_14
    p_lpp_graz_zoo  = ((t_zoo+zoo0)*lr_graz_zoo*t_lpp/max(food_zoo,epsilon))*lim_t_lpp_15
    p_spp_graz_zoo  = ((t_zoo+zoo0)*lr_graz_zoo*t_spp/max(food_zoo,epsilon))*lim_t_spp_16
    p_cya_graz_zoo  = ((t_zoo+zoo0)*lr_graz_zoo*(0.5*t_cya)/max(food_zoo,epsilon))*lim_t_cya_17
    p_lpp_resp_nh4  = (t_lpp*r_lpp_resp)*lim_t_o2_2*lim_t_lpp_15
    p_spp_resp_nh4  = (t_spp*r_spp_resp)*lim_t_spp_16*lim_t_o2_2
    p_cya_resp_nh4  = (t_cya*r_cya_resp)*lim_t_cya_17*lim_t_o2_2
    p_zoo_resp_nh4  = (zoo_eff*r_zoo_resp)*lim_t_zoo_18*lim_t_o2_2
    p_lpp_mort_det  = (t_lpp*r_pp_mort*(1+9*theta(5.0e-6-t_o2)))*lim_t_lpp_15
    p_spp_mort_det  = (t_spp*r_pp_mort*(1+9*theta(5.0e-6-t_o2)))*lim_t_spp_16
    p_cya_mort_det  = (t_cya*r_pp_mort*(1+9*theta(5.0e-6-t_o2)))*lim_t_cya_17
    p_cya_mort_det_diff = (t_cya*r_pp_mort*(r_cya_mort_diff*theta(cgt_diffusivity-r_cya_mort_thresh)))*lim_t_cya_17
    p_zoo_mort_det  = (zoo_eff*r_zoo_mort_light*(1+9*theta(5.0e-6-t_o2)))*lim_t_zoo_18
    p_nh4_nit_no3   = (t_nh4*r_nh4_nitrif*exp(q10_nit*cgt_temp))*lim_t_o2_2*lim_t_nh4_11
    p_det_resp_nh4  = (t_det*r_det_rec*exp(q10_det_rec*cgt_temp))*lim_t_o2_0*lim_t_det_19
    p_det_denit_nh4 = (t_det*r_det_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*lim_t_no3_1*lim_t_det_19
    p_det_sulf_nh4  = (t_det*r_det_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*(1.0-lim_t_no3_1)*lim_t_det_19
    p_h2s_oxo2_sul  = (t_h2s*t_o2*k_h2s_o2*exp(q10_h2s*cgt_temp))*lim_t_h2s_23*lim_t_o2_2
    p_h2s_oxno3_sul = (t_h2s*t_no3*k_h2s_no3*exp(q10_h2s*cgt_temp))*lim_t_no3_10*lim_t_h2s_23
    p_sul_oxo2_so4  = (t_sul*t_o2*k_sul_o2*exp(q10_h2s*cgt_temp))*lim_t_o2_2*lim_t_sul_24
    p_sul_oxno3_so4 = (t_sul*t_no3*k_sul_no3*exp(q10_h2s*cgt_temp))*lim_t_no3_10*lim_t_sul_24
    p_doc2pco       = (t_doc * r_doc2poc)*lim_t_doc_28
    p_dop2pocp      = (t_dop * r_dop2pocp)*lim_t_dop_29
    p_don2pocn      = (t_don * r_don2pocn)*lim_t_don_30
    p_doc_resp      = (t_doc * r_doc_rec * exp(q10_doc_rec * cgt_temp))*lim_t_o2_0*lim_t_doc_28
    p_doc_denit     = (t_doc*r_doc_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*lim_t_no3_1*lim_t_doc_28
    p_doc_sulf      = (t_doc*r_doc_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*(1.0-lim_t_no3_1)*lim_t_doc_28
    p_dop_resp      = (t_dop * lr_dop * exp(q10_det_rec * cgt_temp))*lim_t_o2_0*lim_t_dop_29
    p_dop_denit     = (t_dop*r_dop_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*lim_t_no3_1*lim_t_dop_29
    p_dop_sulf      = (t_dop*r_dop_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*(1.0-lim_t_no3_1)*lim_t_dop_29
    p_don_resp      = (t_don * lr_don * exp(q10_det_rec * cgt_temp))*lim_t_o2_0*lim_t_don_30
    p_don_denit     = (t_don*r_don_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*lim_t_no3_1*lim_t_don_30
    p_don_sulf      = (t_don*r_don_rec*exp(q10_det_rec*cgt_temp))*(1.0-lim_t_o2_0)*(1.0-lim_t_no3_1)*lim_t_don_30
    p_cdom_decay    = (t_cdom*r_cdom_decay*cgt_light/r_cdom_light)*lim_t_cdom_31

!   Calculation of late auxiliary variables
    zoo_C           = t_zoo*rfr_c*1000*cgt_density  
    pp_total        = p_no3_assim_lpp+p_nh4_assim_lpp+p_no3_assim_spp+p_nh4_assim_spp+p_n2_assim_cya
    resp_total      = p_lpp_resp_nh4+p_spp_resp_nh4+p_cya_resp_nh4
    net_pp          = (pp_total-resp_total)*1000.0*rfr_c*12.0*cgt_density

!  Applying time tendencies for tracers
  _ADD_SOURCE_(self%id_t_n2           ,0.0       + (p_poc_denit)*(0.4)         *inv_secs_pr_day       + (p_pocp_denit)*(42.4)       *inv_secs_pr_day       + (p_pocn_denit)*(2.65)       *inv_secs_pr_day       + (p_det_denit_nh4)*(2.65)    &
 *inv_secs_pr_day       + (p_h2s_oxno3_sul)*(0.2)     *inv_secs_pr_day       + (p_sul_oxno3_so4)*(0.6)     *inv_secs_pr_day       + (p_doc_denit)*(0.4)         *inv_secs_pr_day       + (p_dop_denit)*(42.4)        *inv_secs_pr_day       + (p_don_denit &
)*(2.65)        *inv_secs_pr_day       - (p_n2_assim_cya)*(0.5)      *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_o2           ,0.0       + (p_no3_assim_lpp)*(8.625)   *inv_secs_pr_day       + (p_nh4_assim_lpp)*(6.625)   *inv_secs_pr_day       + (p_no3_assim_spp)*(8.625)   *inv_secs_pr_day       + (p_nh4_assim_spp)*(6.625)   &
 *inv_secs_pr_day       + (p_n2_assim_cya)*(7.375)    *inv_secs_pr_day       + p_assim_lpp_doc             *inv_secs_pr_day       + p_assim_spp_doc             *inv_secs_pr_day       + p_assim_cya_doc             *inv_secs_pr_day       + &
 (p_assim_lpp_dop)*(106)     *inv_secs_pr_day       + (p_assim_spp_dop)*(106)     *inv_secs_pr_day       + (p_nh4_assim_lpp_don)*(6.625)*inv_secs_pr_day       + (p_no3_assim_lpp_don)*(8.625)*inv_secs_pr_day       + (p_nh4_assim_spp_don)*(6.625 &
)*inv_secs_pr_day       + (p_no3_assim_spp_don)*(8.625)*inv_secs_pr_day       - p_poc_resp                  *inv_secs_pr_day       - (p_pocp_resp)*(106)         *inv_secs_pr_day       - (p_pocn_resp)*(6.625)       *inv_secs_pr_day       - &
 (p_lpp_resp_nh4)*(6.625)    *inv_secs_pr_day       - (p_spp_resp_nh4)*(6.625)    *inv_secs_pr_day       - (p_cya_resp_nh4)*(6.625)    *inv_secs_pr_day       - (p_zoo_resp_nh4)*(6.625)    *inv_secs_pr_day       - (p_nh4_nit_no3)*(2)         &
 *inv_secs_pr_day       - (p_det_resp_nh4)*(6.625)    *inv_secs_pr_day       - (p_h2s_oxo2_sul)*(0.5)      *inv_secs_pr_day       - (p_sul_oxo2_so4)*(1.5)      *inv_secs_pr_day       - p_doc_resp                  *inv_secs_pr_day       - (p_dop_resp &
)*(106)          *inv_secs_pr_day       - (p_don_resp)*(6.625)        *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_dic          ,0.0       + p_poc_resp                  *inv_secs_pr_day       + p_poc_denit                 *inv_secs_pr_day       + p_poc_sulf                  *inv_secs_pr_day       + (p_pocp_resp)*(106)         &
 *inv_secs_pr_day       + (p_pocp_denit)*(106)        *inv_secs_pr_day       + (p_pocp_sulf)*(106)         *inv_secs_pr_day       + (p_pocn_resp)*(6.625)       *inv_secs_pr_day       + (p_pocn_denit)*(6.625)      *inv_secs_pr_day       + (p_pocn_sulf &
)*(6.625)       *inv_secs_pr_day       + (p_lpp_resp_nh4)*(rfr_c)    *inv_secs_pr_day       + (p_spp_resp_nh4)*(rfr_c)    *inv_secs_pr_day       + (p_cya_resp_nh4)*(rfr_c)    *inv_secs_pr_day       + (p_zoo_resp_nh4)*(rfr_c)    *inv_secs_pr_day       + &
 (p_det_resp_nh4)*(rfr_c)    *inv_secs_pr_day       + (p_det_denit_nh4)*(rfr_c)   *inv_secs_pr_day       + (p_det_sulf_nh4)*(rfr_c)    *inv_secs_pr_day       + p_doc_resp                  *inv_secs_pr_day       + p_doc_denit                 &
 *inv_secs_pr_day       + p_doc_sulf                  *inv_secs_pr_day       + (p_dop_resp)*(106)          *inv_secs_pr_day       + (p_dop_denit)*(106)         *inv_secs_pr_day       + (p_dop_sulf)*(106)          *inv_secs_pr_day       + (p_don_resp &
)*(6.625)        *inv_secs_pr_day       + (p_don_denit)*(6.625)       *inv_secs_pr_day       + (p_don_sulf)*(6.625)        *inv_secs_pr_day       - (p_no3_assim_lpp)*(rfr_c)   *inv_secs_pr_day       - (p_nh4_assim_lpp)*(rfr_c)   *inv_secs_pr_day       - &
 (p_no3_assim_spp)*(rfr_c)   *inv_secs_pr_day       - (p_nh4_assim_spp)*(rfr_c)   *inv_secs_pr_day       - (p_n2_assim_cya)*(rfr_c)    *inv_secs_pr_day       - p_assim_lpp_doc             *inv_secs_pr_day       - p_assim_spp_doc             &
 *inv_secs_pr_day       - p_assim_cya_doc             *inv_secs_pr_day       - (p_assim_lpp_dop)*(106)     *inv_secs_pr_day       - (p_assim_spp_dop)*(106)     *inv_secs_pr_day       - (p_nh4_assim_lpp_don)*(6.625)*inv_secs_pr_day       - &
 (p_no3_assim_lpp_don)*(6.625)*inv_secs_pr_day       - (p_nh4_assim_spp_don)*(6.625)*inv_secs_pr_day       - (p_no3_assim_spp_don)*(6.625)*inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_nh4          ,0.0       + p_pocn_resp                 *inv_secs_pr_day       + p_pocn_denit                *inv_secs_pr_day       + p_pocn_sulf                 *inv_secs_pr_day       + (p_lpp_resp_nh4)*((1-don_fraction) &
)*inv_secs_pr_day       + (p_spp_resp_nh4)*((1-don_fraction))*inv_secs_pr_day       + (p_cya_resp_nh4)*((1-don_fraction))*inv_secs_pr_day       + (p_zoo_resp_nh4)*((1-don_fraction))*inv_secs_pr_day       + p_det_resp_nh4              *inv_secs_pr_day    &
    + p_det_denit_nh4             *inv_secs_pr_day       + p_det_sulf_nh4              *inv_secs_pr_day       + p_don_resp                  *inv_secs_pr_day       + p_don_denit                 *inv_secs_pr_day       + p_don_sulf                  &
 *inv_secs_pr_day       - p_nh4_assim_lpp             *inv_secs_pr_day       - p_nh4_assim_spp             *inv_secs_pr_day       - p_nh4_assim_lpp_don         *inv_secs_pr_day       - p_nh4_assim_spp_don         *inv_secs_pr_day       - p_nh4_nit_no3   &
             *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_no3          ,0.0       + p_nh4_nit_no3               *inv_secs_pr_day       - p_no3_assim_lpp             *inv_secs_pr_day       - p_no3_assim_spp             *inv_secs_pr_day       - p_no3_assim_lpp_don         &
 *inv_secs_pr_day       - p_no3_assim_spp_don         *inv_secs_pr_day       - (p_poc_denit)*(0.8)         *inv_secs_pr_day       - (p_pocp_denit)*(84.8)       *inv_secs_pr_day       - (p_pocn_denit)*(5.3)        *inv_secs_pr_day       - &
 (p_det_denit_nh4)*(5.3)     *inv_secs_pr_day       - (p_h2s_oxno3_sul)*(0.4)     *inv_secs_pr_day       - (p_sul_oxno3_so4)*(1.2)     *inv_secs_pr_day       - (p_doc_denit)*(0.8)         *inv_secs_pr_day       - (p_dop_denit)*(84.8)        &
 *inv_secs_pr_day       - (p_don_denit)*(5.3)         *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_po4          ,0.0       + p_pocp_resp                 *inv_secs_pr_day       + p_pocp_denit                *inv_secs_pr_day       + p_pocp_sulf                 *inv_secs_pr_day       + (p_lpp_resp_nh4)*(rfr_p)    &
 *inv_secs_pr_day       + (p_spp_resp_nh4)*(rfr_p)    *inv_secs_pr_day       + (p_cya_resp_nh4)*(rfr_p)    *inv_secs_pr_day       + (p_zoo_resp_nh4)*(rfr_p)    *inv_secs_pr_day       + (p_det_resp_nh4)*(rfr_p)    *inv_secs_pr_day       + &
 (p_det_denit_nh4)*(rfr_p)   *inv_secs_pr_day       + (p_det_sulf_nh4)*(rfr_p)    *inv_secs_pr_day       + p_dop_resp                  *inv_secs_pr_day       + p_dop_denit                 *inv_secs_pr_day       + p_dop_sulf                  &
 *inv_secs_pr_day       - (p_no3_assim_lpp)*(rfr_p)   *inv_secs_pr_day       - (p_nh4_assim_lpp)*(rfr_p)   *inv_secs_pr_day       - (p_no3_assim_spp)*(rfr_p)   *inv_secs_pr_day       - (p_nh4_assim_spp)*(rfr_p)   *inv_secs_pr_day       - (p_n2_assim_cya &
)*(rfr_p)    *inv_secs_pr_day       - p_assim_lpp_dop             *inv_secs_pr_day       - p_assim_spp_dop             *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_spp          ,0.0       + p_no3_assim_spp             *inv_secs_pr_day       + p_nh4_assim_spp             *inv_secs_pr_day       - p_spp_graz_zoo              *inv_secs_pr_day       - p_spp_resp_nh4              &
 *inv_secs_pr_day       - p_spp_mort_det              *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_zoo          ,0.0       + p_lpp_graz_zoo              *inv_secs_pr_day       + p_spp_graz_zoo              *inv_secs_pr_day       + p_cya_graz_zoo              *inv_secs_pr_day       - p_zoo_resp_nh4              &
 *inv_secs_pr_day       - p_zoo_mort_det              *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_h2s          ,0.0       + (p_poc_sulf)*(0.5)          *inv_secs_pr_day       + (p_pocp_sulf)*(53)          *inv_secs_pr_day       + (p_pocn_sulf)*(3.3125)      *inv_secs_pr_day       + (p_det_sulf_nh4)*(3.3125)   &
 *inv_secs_pr_day       + (p_doc_sulf)*(0.5)          *inv_secs_pr_day       + (p_dop_sulf)*(53)           *inv_secs_pr_day       + (p_don_sulf)*(3.3125)       *inv_secs_pr_day       - p_h2s_oxo2_sul              *inv_secs_pr_day       - p_h2s_oxno3_sul &
             *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_sul          ,0.0       + p_h2s_oxo2_sul              *inv_secs_pr_day       + p_h2s_oxno3_sul             *inv_secs_pr_day       - p_sul_oxo2_so4              *inv_secs_pr_day       - p_sul_oxno3_so4             &
 *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_alk          ,0.0       + (1)*(p_pocn_resp)*(0.5)     *inv_secs_pr_day       + (1)*(p_pocn_denit)*(0.5)    *inv_secs_pr_day       + (1)*(p_pocn_sulf)*(0.5)     *inv_secs_pr_day       + (1)*(p_don_resp)*(0.5)      &
 *inv_secs_pr_day       + (1)*(p_don_denit)*(0.5)     *inv_secs_pr_day       + (1)*(p_don_sulf)*(0.5)      *inv_secs_pr_day       - (1)*(p_nh4_assim_lpp_don)   *inv_secs_pr_day       - (1)*(p_nh4_assim_spp_don)   *inv_secs_pr_day       - (1 &
)*(p_pocp_denit)*(3)      *inv_secs_pr_day       - (1)*(p_pocp_sulf)*(3)       *inv_secs_pr_day       - (1)*(p_dop_denit)*(3)       *inv_secs_pr_day       - (1)*(p_dop_sulf)*(3)        *inv_secs_pr_day       + (-1)*(p_nh4_assim_lpp)*(0.8125 &
)*inv_secs_pr_day       + (-1)*(p_nh4_assim_spp)*(0.8125)*inv_secs_pr_day       + (-1)*(p_pocp_resp)*(3)      *inv_secs_pr_day       + (-1)*(p_nh4_nit_no3)*(2)    *inv_secs_pr_day       + (-1)*(p_sul_oxo2_so4)*(2)   *inv_secs_pr_day       + (-1 &
)*(p_sul_oxno3_so4)*(0.8)*inv_secs_pr_day       + (-1)*(p_dop_resp)*(3)       *inv_secs_pr_day       - (-1)*(p_no3_assim_lpp)*(1.1875)*inv_secs_pr_day       - (-1)*(p_no3_assim_spp)*(1.1875)*inv_secs_pr_day       - (-1)*(p_n2_assim_cya)*(0.1875 &
)*inv_secs_pr_day       - (-1)*(p_assim_lpp_dop)*(3)  *inv_secs_pr_day       - (-1)*(p_assim_spp_dop)*(3)  *inv_secs_pr_day       - (-1)*(p_no3_assim_lpp_don)  *inv_secs_pr_day       - (-1)*(p_no3_assim_spp_don)  *inv_secs_pr_day       - (-1 &
)*(p_poc_denit)*(0.8)    *inv_secs_pr_day       - (-1)*(p_poc_sulf)           *inv_secs_pr_day       - (-1)*(p_pocp_denit)*(84.8)  *inv_secs_pr_day       - (-1)*(p_pocp_sulf)*(106)    *inv_secs_pr_day       - (-1)*(p_pocn_resp)*(0.5)    *inv_secs_pr_day &
       - (-1)*(p_pocn_denit)*(5.8)   *inv_secs_pr_day       - (-1)*(p_pocn_sulf)*(7.125)  *inv_secs_pr_day       - (-1)*(p_lpp_resp_nh4)*(0.8125)*inv_secs_pr_day       - (-1)*(p_spp_resp_nh4)*(0.8125)*inv_secs_pr_day       - (-1)*(p_cya_resp_nh4 &
)*(0.8125)*inv_secs_pr_day       - (-1)*(p_zoo_resp_nh4)*(0.8125)*inv_secs_pr_day       - (-1)*(p_det_resp_nh4)*(0.8125)*inv_secs_pr_day       - (-1)*(p_det_denit_nh4)*(6.1125)*inv_secs_pr_day       - (-1)*(p_det_sulf_nh4)*(7.4375)*inv_secs_pr_day       &
 - (-1)*(p_h2s_oxno3_sul)*(0.4)*inv_secs_pr_day       - (-1)*(p_doc_denit)*(0.8)    *inv_secs_pr_day       - (-1)*(p_doc_sulf)           *inv_secs_pr_day       - (-1)*(p_dop_denit)*(84.8)   *inv_secs_pr_day       - (-1)*(p_dop_sulf)*(106)     &
 *inv_secs_pr_day       - (-1)*(p_don_resp)*(0.5)     *inv_secs_pr_day       - (-1)*(p_don_denit)*(5.8)    *inv_secs_pr_day       - (-1)*(p_don_sulf)*(7.125)   *inv_secs_pr_day       + (2)*(p_pocp_resp)           *inv_secs_pr_day       + (2 &
)*(p_pocp_denit)          *inv_secs_pr_day       + (2)*(p_pocp_sulf)           *inv_secs_pr_day       + (2)*(p_lpp_resp_nh4)*(rfr_p)*inv_secs_pr_day       + (2)*(p_spp_resp_nh4)*(rfr_p)*inv_secs_pr_day       + (2)*(p_cya_resp_nh4)*(rfr_p &
)*inv_secs_pr_day       + (2)*(p_zoo_resp_nh4)*(rfr_p)*inv_secs_pr_day       + (2)*(p_det_resp_nh4)*(rfr_p)*inv_secs_pr_day       + (2)*(p_det_denit_nh4)*(rfr_p)*inv_secs_pr_day       + (2)*(p_det_sulf_nh4)*(rfr_p)*inv_secs_pr_day       + (2 &
)*(p_dop_resp)            *inv_secs_pr_day       + (2)*(p_dop_denit)           *inv_secs_pr_day       + (2)*(p_dop_sulf)            *inv_secs_pr_day       - (2)*(p_no3_assim_lpp)*(rfr_p)*inv_secs_pr_day       - (2)*(p_nh4_assim_lpp)*(rfr_p &
)*inv_secs_pr_day       - (2)*(p_no3_assim_spp)*(rfr_p)*inv_secs_pr_day       - (2)*(p_nh4_assim_spp)*(rfr_p)*inv_secs_pr_day       - (2)*(p_n2_assim_cya)*(rfr_p)*inv_secs_pr_day       - (2)*(p_assim_lpp_dop)       *inv_secs_pr_day       - (2 &
)*(p_assim_spp_dop)       *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_ipw          ,0.0   )
  _ADD_SOURCE_(self%id_t_lpp          ,0.0       + p_no3_assim_lpp             *inv_secs_pr_day       + p_nh4_assim_lpp             *inv_secs_pr_day       - p_lpp_graz_zoo              *inv_secs_pr_day       - p_lpp_resp_nh4              &
 *inv_secs_pr_day       - p_lpp_mort_det              *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_cya          ,0.0       + p_n2_assim_cya              *inv_secs_pr_day       - p_cya_graz_zoo              *inv_secs_pr_day       - p_cya_resp_nh4              *inv_secs_pr_day       - p_cya_mort_det              &
 *inv_secs_pr_day       - p_cya_mort_det_diff         *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_det          ,0.0       + p_lpp_mort_det              *inv_secs_pr_day       + p_spp_mort_det              *inv_secs_pr_day       + p_cya_mort_det              *inv_secs_pr_day       + p_cya_mort_det_diff         &
 *inv_secs_pr_day       + p_zoo_mort_det              *inv_secs_pr_day       - p_det_resp_nh4              *inv_secs_pr_day       - p_det_denit_nh4             *inv_secs_pr_day       - p_det_sulf_nh4              *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_poc          ,0.0       + p_doc2pco                   *inv_secs_pr_day       - p_poc_resp                  *inv_secs_pr_day       - p_poc_denit                 *inv_secs_pr_day       - p_poc_sulf                  &
 *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_pocp         ,0.0       + p_dop2pocp                  *inv_secs_pr_day       - p_pocp_resp                 *inv_secs_pr_day       - p_pocp_denit                *inv_secs_pr_day       - p_pocp_sulf                 &
 *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_pocn         ,0.0       + p_don2pocn                  *inv_secs_pr_day       - p_pocn_resp                 *inv_secs_pr_day       - p_pocn_denit                *inv_secs_pr_day       - p_pocn_sulf                 &
 *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_doc          ,0.0       + p_assim_lpp_doc             *inv_secs_pr_day       + p_assim_spp_doc             *inv_secs_pr_day       + p_assim_cya_doc             *inv_secs_pr_day       - p_doc2pco                   &
 *inv_secs_pr_day       - p_doc_resp                  *inv_secs_pr_day       - p_doc_denit                 *inv_secs_pr_day       - p_doc_sulf                  *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_dop          ,0.0       + p_assim_lpp_dop             *inv_secs_pr_day       + p_assim_spp_dop             *inv_secs_pr_day       - p_dop2pocp                  *inv_secs_pr_day       - p_dop_resp                  &
 *inv_secs_pr_day       - p_dop_denit                 *inv_secs_pr_day       - p_dop_sulf                  *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_don          ,0.0       + p_nh4_assim_lpp_don         *inv_secs_pr_day       + p_no3_assim_lpp_don         *inv_secs_pr_day       + p_nh4_assim_spp_don         *inv_secs_pr_day       + p_no3_assim_spp_don         &
 *inv_secs_pr_day       + (p_lpp_resp_nh4)*(don_fraction)*inv_secs_pr_day       + (p_spp_resp_nh4)*(don_fraction)*inv_secs_pr_day       + (p_cya_resp_nh4)*(don_fraction)*inv_secs_pr_day       + (p_zoo_resp_nh4)*(don_fraction)*inv_secs_pr_day       - &
 p_don2pocn                  *inv_secs_pr_day       - p_don_resp                  *inv_secs_pr_day       - p_don_denit                 *inv_secs_pr_day       - p_don_sulf                  *inv_secs_pr_day   )
  _ADD_SOURCE_(self%id_t_cdom         ,0.0       - p_cdom_decay                *inv_secs_pr_day   )

!  if ((cgt_longitude .gt. 11.68).and.(cgt_longitude .lt. 11.72)) then 
!  if ((cgt_latitude .gt. 54.83).and.(cgt_latitude .lt. 54.87)) then
  
!<tracers name=t_dic>
!  WRITE(*,*) "change_dic=",0.0 !    <timeTendencies vertLoc=WAT>
!      <timeTendency>*inv_secs_pr_day !    </timeTendencies>
!</tracers>  

!endif
!endif

! Export diagnostic variables
   _SET_DIAGNOSTIC_(self%id_dPAR,cgt_light)
!   _SET_DIAGNOSTIC_(self%id_GPP ,r1/(p1+self%p10)+r2/(p2+self%p20)+r3/(p2+self%p30))
!   _SET_DIAGNOSTIC_(self%id_NCP ,r1/(p1+self%p10)+r2/(p2+self%p20)+r3/(p2+self%p30) - self%lpa*(p1+p2+p3))
!   _SET_DIAGNOSTIC_(self%id_PPR ,(r1/(p1+self%p10)+r2/(p2+self%p20)+r3/(p2+self%p30))*secs_pr_day)
!   _SET_DIAGNOSTIC_(self%id_NPR ,(r1/(p1+self%p10)+r2/(p2+self%p20)+r3/(p2+self%p30) - self%lpa*(p1+p2+p3))*secs_pr_day)
   _SET_DIAGNOSTIC_(self%id_k0_co2          ,k0_co2         )
   _SET_DIAGNOSTIC_(self%id_k1_co2          ,k1_co2         )
   _SET_DIAGNOSTIC_(self%id_k2_co2          ,k2_co2         )
   _SET_DIAGNOSTIC_(self%id_alk_boron       ,alk_boron      )
   _SET_DIAGNOSTIC_(self%id_alk_h2s         ,alk_h2s        )
   _SET_DIAGNOSTIC_(self%id_alk_water       ,alk_water      )
   _SET_DIAGNOSTIC_(self%id_alk_po4         ,alk_po4        )
   _SET_DIAGNOSTIC_(self%id_alk_co2_denominator ,alk_co2_denominator)
   _SET_DIAGNOSTIC_(self%id_alk_co2         ,alk_co2        )
   _SET_DIAGNOSTIC_(self%id_alk_residual    ,alk_residual   )
   _SET_DIAGNOSTIC_(self%id_dalkp_dh3o      ,dalkp_dh3o     )
   _SET_DIAGNOSTIC_(self%id_dalkc_dh3o      ,dalkc_dh3o     )
   _SET_DIAGNOSTIC_(self%id_dalkresidual_dpH ,dalkresidual_dpH)
   _SET_DIAGNOSTIC_(self%id_ph              ,ph             )
   _SET_DIAGNOSTIC_(self%id_h3o             ,h3o            )
   _SET_DIAGNOSTIC_(self%id_lr_assim_lpp    ,lr_assim_lpp   )
   _SET_DIAGNOSTIC_(self%id_lr_assim_lpp_doc ,lr_assim_lpp_doc)
   _SET_DIAGNOSTIC_(self%id_lr_assim_spp_doc ,lr_assim_spp_doc)
   _SET_DIAGNOSTIC_(self%id_lr_assim_cya_doc ,lr_assim_cya_doc)
   _SET_DIAGNOSTIC_(self%id_lr_assim_spp    ,lr_assim_spp   )
   _SET_DIAGNOSTIC_(self%id_lr_assim_cya    ,lr_assim_cya   )
   _SET_DIAGNOSTIC_(self%id_lr_assim_lpp_dop ,lr_assim_lpp_dop)
   _SET_DIAGNOSTIC_(self%id_lr_assim_spp_dop ,lr_assim_spp_dop)
   _SET_DIAGNOSTIC_(self%id_lr_assim_lpp_don ,lr_assim_lpp_don)
   _SET_DIAGNOSTIC_(self%id_lr_assim_spp_don ,lr_assim_spp_don)
   _SET_DIAGNOSTIC_(self%id_phyto_C         ,phyto_C        )
   _SET_DIAGNOSTIC_(self%id_cdom_decay      ,cdom_decay     )
   _SET_DIAGNOSTIC_(self%id_zoo_C           ,zoo_C          )
   _SET_DIAGNOSTIC_(self%id_lpp_C           ,lpp_C          )
   _SET_DIAGNOSTIC_(self%id_spp_C           ,spp_C          )
   _SET_DIAGNOSTIC_(self%id_cya_C           ,cya_C          )
   _SET_DIAGNOSTIC_(self%id_pp_total        ,pp_total       )
   _SET_DIAGNOSTIC_(self%id_resp_total      ,resp_total     )
   _SET_DIAGNOSTIC_(self%id_net_pp          ,net_pp         )
   _SET_DIAGNOSTIC_(self%id_chl_a           ,chl_a          )
   _SET_DIAGNOSTIC_(self%id_KD              ,KD             )
   _SET_DIAGNOSTIC_(self%id_secchi_depth    ,secchi_depth   )
   _SET_DIAGNOSTIC_(self%id_det_C           ,det_C          )
   _SET_DIAGNOSTIC_(self%id_chl_a_C         ,chl_a_C        )
   _SET_DIAGNOSTIC_(self%id_chl_a_lpp_C     ,chl_a_lpp_C    )
   _SET_DIAGNOSTIC_(self%id_chl_a_spp_C     ,chl_a_spp_C    )
   _SET_DIAGNOSTIC_(self%id_chl_a_cya_C     ,chl_a_cya_C    )
   _SET_DIAGNOSTIC_(self%id_cdom3_C         ,cdom3_C        )
   _SET_DIAGNOSTIC_(self%id_cdom2_C         ,cdom2_C        )
   _SET_DIAGNOSTIC_(self%id_cdom1_C         ,cdom1_C        )
   _SET_DIAGNOSTIC_(self%id_r_zoo_mort_light ,r_zoo_mort_light)
   _SET_DIAGNOSTIC_(self%id_p_no3_assim_lpp ,p_no3_assim_lpp)
   _SET_DIAGNOSTIC_(self%id_p_nh4_assim_lpp ,p_nh4_assim_lpp)
   _SET_DIAGNOSTIC_(self%id_p_no3_assim_spp ,p_no3_assim_spp)
   _SET_DIAGNOSTIC_(self%id_p_nh4_assim_spp ,p_nh4_assim_spp)
   _SET_DIAGNOSTIC_(self%id_p_n2_assim_cya  ,p_n2_assim_cya )
   _SET_DIAGNOSTIC_(self%id_p_assim_lpp_doc ,p_assim_lpp_doc)
   _SET_DIAGNOSTIC_(self%id_p_assim_spp_doc ,p_assim_spp_doc)
   _SET_DIAGNOSTIC_(self%id_p_assim_cya_doc ,p_assim_cya_doc)
   _SET_DIAGNOSTIC_(self%id_p_assim_lpp_dop ,p_assim_lpp_dop)
   _SET_DIAGNOSTIC_(self%id_p_assim_spp_dop ,p_assim_spp_dop)
   _SET_DIAGNOSTIC_(self%id_p_nh4_assim_lpp_don ,p_nh4_assim_lpp_don)
   _SET_DIAGNOSTIC_(self%id_p_nh4_assim_spp_don ,p_nh4_assim_spp_don)
   _SET_DIAGNOSTIC_(self%id_p_no3_assim_spp_don ,p_no3_assim_spp_don)
   _SET_DIAGNOSTIC_(self%id_p_poc_resp      ,p_poc_resp     )
   _SET_DIAGNOSTIC_(self%id_p_poc_denit     ,p_poc_denit    )
   _SET_DIAGNOSTIC_(self%id_p_poc_sulf      ,p_poc_sulf     )
   _SET_DIAGNOSTIC_(self%id_p_pocp_resp     ,p_pocp_resp    )
   _SET_DIAGNOSTIC_(self%id_p_lpp_graz_zoo  ,p_lpp_graz_zoo )
   _SET_DIAGNOSTIC_(self%id_p_spp_graz_zoo  ,p_spp_graz_zoo )
   _SET_DIAGNOSTIC_(self%id_p_cya_graz_zoo  ,p_cya_graz_zoo )
   _SET_DIAGNOSTIC_(self%id_p_cya_mort_det_diff ,p_cya_mort_det_diff)
   _SET_DIAGNOSTIC_(self%id_p_zoo_mort_det  ,p_zoo_mort_det )
   _SET_DIAGNOSTIC_(self%id_p_det_resp_nh4  ,p_det_resp_nh4 )
   _SET_DIAGNOSTIC_(self%id_p_det_denit_nh4 ,p_det_denit_nh4)
   _SET_DIAGNOSTIC_(self%id_p_det_sulf_nh4  ,p_det_sulf_nh4 )
   _SET_DIAGNOSTIC_(self%id_p_h2s_oxno3_sul ,p_h2s_oxno3_sul)
   _SET_DIAGNOSTIC_(self%id_p_doc2pco       ,p_doc2pco      )
   _SET_DIAGNOSTIC_(self%id_p_dop2pocp      ,p_dop2pocp     )
   _SET_DIAGNOSTIC_(self%id_p_don2pocn      ,p_don2pocn     )
   _SET_DIAGNOSTIC_(self%id_p_doc_resp      ,p_doc_resp     )
   _SET_DIAGNOSTIC_(self%id_p_dop_resp      ,p_dop_resp     )
   _SET_DIAGNOSTIC_(self%id_p_don_resp      ,p_don_resp     )
   _SET_DIAGNOSTIC_(self%id_p_cdom_decay    ,p_cdom_decay   )
!   Leave spatial loops (if any)
   _LOOP_END_

   END subroutine do
!EOC

!-----------------------------------------------------------------------
!BOP
!
! !IROUTINE: Get the light extinction coefficient due to biogeochemical
! variables
!
! !DESCRIPTION:

! !INTERFACE:
   subroutine get_light_extinction(self,_ARGUMENTS_GET_EXTINCTION_)
!
! !INPUT PARAMETERS:
   class (type_bsh_ergom_neccton), intent(in) :: self
   _DECLARE_ARGUMENTS_GET_EXTINCTION_
!
! !REVISION HISTORY:
!  Original author(s): Jorn Bruggeman
!
! !LOCAL VARIABLES:
   real(rk)                     :: critical_stress
   real(rk)                     :: cya0           
   real(rk)                     :: din_min_lpp    
   real(rk)                     :: din_min_spp    
   real(rk)                     :: dip_min_cya    
   real(rk)                     :: epsilon        
   real(rk)                     :: food_min_zoo   
   real(rk)                     :: gamma0         
   real(rk)                     :: gamma1         
   real(rk)                     :: gamma2         
   real(rk)                     :: gamma3         
   real(rk)                     :: h2s_min_po4_liber
   real(rk)                     :: ips_threshold  
   real(rk)                     :: ips_cl         
   real(rk)                     :: k_h2s_no3      
   real(rk)                     :: k_h2s_o2       
   real(rk)                     :: k_sul_no3      
   real(rk)                     :: k_sul_o2       
   real(rk)                     :: light_opt_cya  
   real(rk)                     :: light_opt_lpp  
   real(rk)                     :: light_opt_spp  
   real(rk)                     :: lpp0           
   real(rk)                     :: no3_min_sed_denit
   real(rk)                     :: no3_min_det_denit
   real(rk)                     :: o2_min_det_resp
   real(rk)                     :: o2_min_nit     
   real(rk)                     :: o2_min_po4_retent
   real(rk)                     :: o2_min_sed_resp
   real(rk)                     :: patm_co2       
   real(rk)                     :: q10_det_rec    
   real(rk)                     :: q10_doc_rec    
   real(rk)                     :: q10_h2s        
   real(rk)                     :: q10_nit        
   real(rk)                     :: q10_sed_rec    
   real(rk)                     :: r_biores       
   real(rk)                     :: r_cya_assim    
   real(rk)                     :: r_cya_resp     
   real(rk)                     :: r_det_rec      
   real(rk)                     :: r_ips_burial   
   real(rk)                     :: r_ips_ero      
   real(rk)                     :: r_ips_liber    
   real(rk)                     :: r_lpp_assim    
   real(rk)                     :: r_lpp_resp     
   real(rk)                     :: r_nh4_nitrif   
   real(rk)                     :: r_pp_mort      
   real(rk)                     :: r_cya_mort_diff
   real(rk)                     :: r_cya_mort_thresh
   real(rk)                     :: r_sed_ero      
   real(rk)                     :: r_sed_rec      
   real(rk)                     :: r_sed_poc_rec  
   real(rk)                     :: r_spp_assim    
   real(rk)                     :: r_spp_resp     
   real(rk)                     :: r_zoo_graz     
   real(rk)                     :: r_zoo_mort     
   real(rk)                     :: r_zoo_resp     
   real(rk)                     :: rfr_c          
   real(rk)                     :: rfr_h          
   real(rk)                     :: rfr_o          
   real(rk)                     :: rfr_p          
   real(rk)                     :: rfr_cp         
   real(rk)                     :: sali_max_cya   
   real(rk)                     :: sali_min_cya   
   real(rk)                     :: nit_max_cya    
   real(rk)                     :: nit_switch_cya 
   real(rk)                     :: sed_max        
   real(rk)                     :: sed_burial     
   real(rk)                     :: spp0           
   real(rk)                     :: temp_min_cya   
   real(rk)                     :: temp_switch_cya
   real(rk)                     :: temp_min_spp   
   real(rk)                     :: temp_opt_zoo   
   real(rk)                     :: w_co2_stf      
   real(rk)                     :: w_cya          
   real(rk)                     :: w_det          
   real(rk)                     :: w_ipw          
   real(rk)                     :: w_det_sedi     
   real(rk)                     :: w_ipw_sedi     
   real(rk)                     :: w_lpp          
   real(rk)                     :: w_n2_stf       
   real(rk)                     :: w_o2_stf       
   real(rk)                     :: zoo0           
   real(rk)                     :: zoo_cl         
   real(rk)                     :: don_fraction   
   real(rk)                     :: r_poc_rec      
   real(rk)                     :: r_pocp_rec     
   real(rk)                     :: r_pocn_rec     
   real(rk)                     :: w_poc          
   real(rk)                     :: w_poc_sedi     
   real(rk)                     :: w_pocp         
   real(rk)                     :: w_pocp_sedi    
   real(rk)                     :: w_pocn         
   real(rk)                     :: w_pocn_sedi    
   real(rk)                     :: fac_doc_assim_lpp
   real(rk)                     :: fac_doc_assim_cya
   real(rk)                     :: fac_doc_assim_spp
   real(rk)                     :: fac_dop_assim  
   real(rk)                     :: fac_don_assim  
   real(rk)                     :: fac_enh_rec    
   real(rk)                     :: ret_po4_1      
   real(rk)                     :: ret_po4_2      
   real(rk)                     :: frac_denit_scal
   real(rk)                     :: reduced_rec    
   real(rk)                     :: martin_fac_poc 
   real(rk)                     :: r_doc2poc      
   real(rk)                     :: r_don2pocn     
   real(rk)                     :: r_dop2pocp     
   real(rk)                     :: r_doc_rec      
   real(rk)                     :: r_don_rec      
   real(rk)                     :: r_dop_rec      
   real(rk)                     :: fac_ips_burial 
   real(rk)                     :: r_cdom_decay   
   real(rk)                     :: r_cdom_light   
   real(rk)                     :: ten            
   real(rk)                     :: zero           
   real(rk)                     :: one            
   real(rk)                     :: three          
   real(rk)                     :: min_chl_n      
   real(rk)                     :: max_chl_n      
   real(rk)                     :: light_max      
   real(rk)                     :: molar_mass_C   
   real(rk)                     :: I_h            
   real(rk)                     :: t_spp          
   real(rk)                     :: t_lpp          
   real(rk)                     :: t_cya          
   real(rk)                     :: t_det          
   real(rk)                     :: t_don          

   real(rk)                     :: cgt_density
!EOP
!-----------------------------------------------------------------------
!BOC
   ! Store values of constants in local variables
   critical_stress = self%critical_stress
   cya0            = self%cya0           
   din_min_lpp     = self%din_min_lpp    
   din_min_spp     = self%din_min_spp    
   dip_min_cya     = self%dip_min_cya    
   epsilon         = self%epsilon        
   food_min_zoo    = self%food_min_zoo   
   gamma0          = self%gamma0         
   gamma1          = self%gamma1         
   gamma2          = self%gamma2         
   gamma3          = self%gamma3         
   h2s_min_po4_liber = self%h2s_min_po4_liber
   ips_threshold   = self%ips_threshold  
   ips_cl          = self%ips_cl         
   k_h2s_no3       = self%k_h2s_no3      
   k_h2s_o2        = self%k_h2s_o2       
   k_sul_no3       = self%k_sul_no3      
   k_sul_o2        = self%k_sul_o2       
   light_opt_cya   = self%light_opt_cya  
   light_opt_lpp   = self%light_opt_lpp  
   light_opt_spp   = self%light_opt_spp  
   lpp0            = self%lpp0           
   no3_min_sed_denit = self%no3_min_sed_denit
   no3_min_det_denit = self%no3_min_det_denit
   o2_min_det_resp = self%o2_min_det_resp
   o2_min_nit      = self%o2_min_nit     
   o2_min_po4_retent = self%o2_min_po4_retent
   o2_min_sed_resp = self%o2_min_sed_resp
   patm_co2        = self%patm_co2       
   q10_det_rec     = self%q10_det_rec    
   q10_doc_rec     = self%q10_doc_rec    
   q10_h2s         = self%q10_h2s        
   q10_nit         = self%q10_nit        
   q10_sed_rec     = self%q10_sed_rec    
   r_biores        = self%r_biores       
   r_cya_assim     = self%r_cya_assim    
   r_cya_resp      = self%r_cya_resp     
   r_det_rec       = self%r_det_rec      
   r_ips_burial    = self%r_ips_burial   
   r_ips_ero       = self%r_ips_ero      
   r_ips_liber     = self%r_ips_liber    
   r_lpp_assim     = self%r_lpp_assim    
   r_lpp_resp      = self%r_lpp_resp     
   r_nh4_nitrif    = self%r_nh4_nitrif   
   r_pp_mort       = self%r_pp_mort      
   r_cya_mort_diff = self%r_cya_mort_diff
   r_cya_mort_thresh = self%r_cya_mort_thresh
   r_sed_ero       = self%r_sed_ero      
   r_sed_rec       = self%r_sed_rec      
   r_sed_poc_rec   = self%r_sed_poc_rec  
   r_spp_assim     = self%r_spp_assim    
   r_spp_resp      = self%r_spp_resp     
   r_zoo_graz      = self%r_zoo_graz     
   r_zoo_mort      = self%r_zoo_mort     
   r_zoo_resp      = self%r_zoo_resp     
   rfr_c           = self%rfr_c          
   rfr_h           = self%rfr_h          
   rfr_o           = self%rfr_o          
   rfr_p           = self%rfr_p          
   rfr_cp          = self%rfr_cp         
   sali_max_cya    = self%sali_max_cya   
   sali_min_cya    = self%sali_min_cya   
   nit_max_cya     = self%nit_max_cya    
   nit_switch_cya  = self%nit_switch_cya 
   sed_max         = self%sed_max        
   sed_burial      = self%sed_burial     
   spp0            = self%spp0           
   temp_min_cya    = self%temp_min_cya   
   temp_switch_cya = self%temp_switch_cya
   temp_min_spp    = self%temp_min_spp   
   temp_opt_zoo    = self%temp_opt_zoo   
   w_co2_stf       = self%w_co2_stf      
   w_cya           = self%w_cya          
   w_det           = self%w_det          
   w_ipw           = self%w_ipw          
   w_det_sedi      = self%w_det_sedi     
   w_ipw_sedi      = self%w_ipw_sedi     
   w_lpp           = self%w_lpp          
   w_n2_stf        = self%w_n2_stf       
   w_o2_stf        = self%w_o2_stf       
   zoo0            = self%zoo0           
   zoo_cl          = self%zoo_cl         
   don_fraction    = self%don_fraction   
   r_poc_rec       = self%r_poc_rec      
   r_pocp_rec      = self%r_pocp_rec     
   r_pocn_rec      = self%r_pocn_rec     
   w_poc           = self%w_poc          
   w_poc_sedi      = self%w_poc_sedi     
   w_pocp          = self%w_pocp         
   w_pocp_sedi     = self%w_pocp_sedi    
   w_pocn          = self%w_pocn         
   w_pocn_sedi     = self%w_pocn_sedi    
   fac_doc_assim_lpp = self%fac_doc_assim_lpp
   fac_doc_assim_cya = self%fac_doc_assim_cya
   fac_doc_assim_spp = self%fac_doc_assim_spp
   fac_dop_assim   = self%fac_dop_assim  
   fac_don_assim   = self%fac_don_assim  
   fac_enh_rec     = self%fac_enh_rec    
   ret_po4_1       = self%ret_po4_1      
   ret_po4_2       = self%ret_po4_2      
   frac_denit_scal = self%frac_denit_scal
   reduced_rec     = self%reduced_rec    
   martin_fac_poc  = self%martin_fac_poc 
   r_doc2poc       = self%r_doc2poc      
   r_don2pocn      = self%r_don2pocn     
   r_dop2pocp      = self%r_dop2pocp     
   r_doc_rec       = self%r_doc_rec      
   r_don_rec       = self%r_don_rec      
   r_dop_rec       = self%r_dop_rec      
   fac_ips_burial  = self%fac_ips_burial 
   r_cdom_decay    = self%r_cdom_decay   
   r_cdom_light    = self%r_cdom_light   
   ten             = self%ten            
   zero            = self%zero           
   one             = self%one            
   three           = self%three          
   min_chl_n       = self%min_chl_n      
   max_chl_n       = self%max_chl_n      
   light_max       = self%light_max      
   molar_mass_C    = self%molar_mass_C   
   I_h             = self%I_h            
   cgt_density = 1035.0_rk               ! Boussinesq density
   ! Enter spatial loops (if any)
   _LOOP_BEGIN_

   ! Retrieve current (local) state variable values.

   _GET_(self%id_t_spp          ,t_spp          ) ! small-cell phytoplankton
   _GET_(self%id_t_lpp          ,t_lpp          ) ! large-cell phytoplankton
   _GET_(self%id_t_cya          ,t_cya          ) ! diazotroph cyanobacteria
   _GET_(self%id_t_det          ,t_det          ) ! detritus
   _GET_(self%id_t_don          ,t_don          ) ! nitrogen in dissolved organic carbon in Redfield ratio

   ! Self-shading with explicit contribution from background phytoplankton concentration.
   _SET_EXTINCTION_(0.0                     + t_spp           * gamma1 * cgt_density                     + t_lpp           * gamma1 * cgt_density                     + t_cya           * gamma1 * cgt_density                     + t_det           * gamma2 &
 * cgt_density                     + t_don           * gamma3 * cgt_density                    )

   ! Leave spatial loops (if any)
   _LOOP_END_

   end subroutine get_light_extinction
!EOC

!-----------------------------------------------------------------------
!BOP
!
! !IROUTINE:
!
! !INTERFACE:
   subroutine do_bottom(self,_ARGUMENTS_DO_BOTTOM_)
!
! !DESCRIPTION:
! Calculating the benthic fluxes
!
   implicit none

! !INPUT PARAMETERS:
   class (type_bsh_ergom_neccton), intent(in) :: self
   _DECLARE_ARGUMENTS_DO_BOTTOM_
!
! !REVISION HISTORY:
!  Original author(s):
!
! !LOCAL VARIABLES:
   real(rk)                   :: critical_stress
   real(rk)                   :: cya0           
   real(rk)                   :: din_min_lpp    
   real(rk)                   :: din_min_spp    
   real(rk)                   :: dip_min_cya    
   real(rk)                   :: epsilon        
   real(rk)                   :: food_min_zoo   
   real(rk)                   :: gamma0         
   real(rk)                   :: gamma1         
   real(rk)                   :: gamma2         
   real(rk)                   :: gamma3         
   real(rk)                   :: h2s_min_po4_liber
   real(rk)                   :: ips_threshold  
   real(rk)                   :: ips_cl         
   real(rk)                   :: k_h2s_no3      
   real(rk)                   :: k_h2s_o2       
   real(rk)                   :: k_sul_no3      
   real(rk)                   :: k_sul_o2       
   real(rk)                   :: light_opt_cya  
   real(rk)                   :: light_opt_lpp  
   real(rk)                   :: light_opt_spp  
   real(rk)                   :: lpp0           
   real(rk)                   :: no3_min_sed_denit
   real(rk)                   :: no3_min_det_denit
   real(rk)                   :: o2_min_det_resp
   real(rk)                   :: o2_min_nit     
   real(rk)                   :: o2_min_po4_retent
   real(rk)                   :: o2_min_sed_resp
   real(rk)                   :: patm_co2       
   real(rk)                   :: q10_det_rec    
   real(rk)                   :: q10_doc_rec    
   real(rk)                   :: q10_h2s        
   real(rk)                   :: q10_nit        
   real(rk)                   :: q10_sed_rec    
   real(rk)                   :: r_biores       
   real(rk)                   :: r_cya_assim    
   real(rk)                   :: r_cya_resp     
   real(rk)                   :: r_det_rec      
   real(rk)                   :: r_ips_burial   
   real(rk)                   :: r_ips_ero      
   real(rk)                   :: r_ips_liber    
   real(rk)                   :: r_lpp_assim    
   real(rk)                   :: r_lpp_resp     
   real(rk)                   :: r_nh4_nitrif   
   real(rk)                   :: r_pp_mort      
   real(rk)                   :: r_cya_mort_diff
   real(rk)                   :: r_cya_mort_thresh
   real(rk)                   :: r_sed_ero      
   real(rk)                   :: r_sed_rec      
   real(rk)                   :: r_sed_poc_rec  
   real(rk)                   :: r_spp_assim    
   real(rk)                   :: r_spp_resp     
   real(rk)                   :: r_zoo_graz     
   real(rk)                   :: r_zoo_mort     
   real(rk)                   :: r_zoo_resp     
   real(rk)                   :: rfr_c          
   real(rk)                   :: rfr_h          
   real(rk)                   :: rfr_o          
   real(rk)                   :: rfr_p          
   real(rk)                   :: rfr_cp         
   real(rk)                   :: sali_max_cya   
   real(rk)                   :: sali_min_cya   
   real(rk)                   :: nit_max_cya    
   real(rk)                   :: nit_switch_cya 
   real(rk)                   :: sed_max        
   real(rk)                   :: sed_burial     
   real(rk)                   :: spp0           
   real(rk)                   :: temp_min_cya   
   real(rk)                   :: temp_switch_cya
   real(rk)                   :: temp_min_spp   
   real(rk)                   :: temp_opt_zoo   
   real(rk)                   :: w_co2_stf      
   real(rk)                   :: w_cya          
   real(rk)                   :: w_det          
   real(rk)                   :: w_ipw          
   real(rk)                   :: w_det_sedi     
   real(rk)                   :: w_ipw_sedi     
   real(rk)                   :: w_lpp          
   real(rk)                   :: w_n2_stf       
   real(rk)                   :: w_o2_stf       
   real(rk)                   :: zoo0           
   real(rk)                   :: zoo_cl         
   real(rk)                   :: don_fraction   
   real(rk)                   :: r_poc_rec      
   real(rk)                   :: r_pocp_rec     
   real(rk)                   :: r_pocn_rec     
   real(rk)                   :: w_poc          
   real(rk)                   :: w_poc_sedi     
   real(rk)                   :: w_pocp         
   real(rk)                   :: w_pocp_sedi    
   real(rk)                   :: w_pocn         
   real(rk)                   :: w_pocn_sedi    
   real(rk)                   :: fac_doc_assim_lpp
   real(rk)                   :: fac_doc_assim_cya
   real(rk)                   :: fac_doc_assim_spp
   real(rk)                   :: fac_dop_assim  
   real(rk)                   :: fac_don_assim  
   real(rk)                   :: fac_enh_rec    
   real(rk)                   :: ret_po4_1      
   real(rk)                   :: ret_po4_2      
   real(rk)                   :: frac_denit_scal
   real(rk)                   :: reduced_rec    
   real(rk)                   :: martin_fac_poc 
   real(rk)                   :: r_doc2poc      
   real(rk)                   :: r_don2pocn     
   real(rk)                   :: r_dop2pocp     
   real(rk)                   :: r_doc_rec      
   real(rk)                   :: r_don_rec      
   real(rk)                   :: r_dop_rec      
   real(rk)                   :: fac_ips_burial 
   real(rk)                   :: r_cdom_decay   
   real(rk)                   :: r_cdom_light   
   real(rk)                   :: ten            
   real(rk)                   :: zero           
   real(rk)                   :: one            
   real(rk)                   :: three          
   real(rk)                   :: min_chl_n      
   real(rk)                   :: max_chl_n      
   real(rk)                   :: light_max      
   real(rk)                   :: molar_mass_C   
   real(rk)                   :: I_h            
   real(rk)                   :: t_n2           
   real(rk)                   :: t_o2           
   real(rk)                   :: t_dic          
   real(rk)                   :: t_nh4          
   real(rk)                   :: t_no3          
   real(rk)                   :: t_po4          
   real(rk)                   :: t_spp          
   real(rk)                   :: t_zoo          
   real(rk)                   :: t_h2s          
   real(rk)                   :: t_sul          
   real(rk)                   :: t_alk          
   real(rk)                   :: t_ipw          
   real(rk)                   :: t_lpp          
   real(rk)                   :: t_cya          
   real(rk)                   :: t_det          
   real(rk)                   :: t_poc          
   real(rk)                   :: t_pocp         
   real(rk)                   :: t_pocn         
   real(rk)                   :: t_doc          
   real(rk)                   :: t_dop          
   real(rk)                   :: t_don          
   real(rk)                   :: t_cdom         
   real(rk)                   :: t_sed          
   real(rk)                   :: t_ips          
   real(rk)                   :: t_sed_poc      
   real(rk)                   :: t_sed_pocn     
   real(rk)                   :: t_sed_pocp     
   real(rk)                   :: temp_k         
   real(rk)                   :: ph_temp        
   real(rk)                   :: k_water        
   real(rk)                   :: k0_co2         
   real(rk)                   :: k1_co2         
   real(rk)                   :: k2_co2         
   real(rk)                   :: k_boron        
   real(rk)                   :: k1_po4         
   real(rk)                   :: k2_po4         
   real(rk)                   :: k3_po4         
   real(rk)                   :: k1_h2s         
   real(rk)                   :: boron_total    
   real(rk)                   :: alk_boron      
   real(rk)                   :: alk_h2s        
   real(rk)                   :: alk_water      
   real(rk)                   :: alk_po4_denominator
   real(rk)                   :: alk_po4        
   real(rk)                   :: alk_co2_denominator
   real(rk)                   :: alk_co2        
   real(rk)                   :: alk_residual   
   real(rk)                   :: dalkp_dh3o     
   real(rk)                   :: dalkc_dh3o     
   real(rk)                   :: dalkresidual_dpH
   real(rk)                   :: ph             
   real(rk)                   :: h3o            
   real(rk)                   :: o2_sat         
   real(rk)                   :: n2_sat         
   real(rk)                   :: solubility_n2  
   real(rk)                   :: temp_sq        
   real(rk)                   :: zoo_eff        
   real(rk)                   :: din            
   real(rk)                   :: din_sq         
   real(rk)                   :: po4_sq         
   real(rk)                   :: phyto          
   real(rk)                   :: lpp_plus_lpp0  
   real(rk)                   :: spp_plus_spp0  
   real(rk)                   :: cya_plus_cya0  
   real(rk)                   :: food_zoo       
   real(rk)                   :: lim_light_lpp  
   real(rk)                   :: lim_light_spp  
   real(rk)                   :: lim_light_cya  
   real(rk)                   :: lr_assim_lpp   
   real(rk)                   :: lr_assim_lpp_doc
   real(rk)                   :: lr_assim_spp_doc
   real(rk)                   :: lr_assim_cya_doc
   real(rk)                   :: lr_assim_spp   
   real(rk)                   :: lr_assim_cya   
   real(rk)                   :: lr_assim_lpp_dop
   real(rk)                   :: lr_assim_spp_dop
   real(rk)                   :: lr_assim_lpp_don
   real(rk)                   :: lr_assim_spp_don
   real(rk)                   :: lr_graz_zoo    
   real(rk)                   :: frac_po4retent 
   real(rk)                   :: ref_p_sw       
   real(rk)                   :: ref_n_sw       
   real(rk)                   :: lr_pocp        
   real(rk)                   :: lr_dop         
   real(rk)                   :: lr_pocn        
   real(rk)                   :: lr_don         
   real(rk)                   :: w_poc_var      
   real(rk)                   :: w_pocn_var     
   real(rk)                   :: w_pocp_var     
   real(rk)                   :: phyto_C        
   real(rk)                   :: cdom_decay     
   real(rk)                   :: zoo_C          
   real(rk)                   :: lpp_C          
   real(rk)                   :: spp_C          
   real(rk)                   :: cya_C          
   real(rk)                   :: pp_total       
   real(rk)                   :: resp_total     
   real(rk)                   :: net_pp         
   real(rk)                   :: chl_a          
   real(rk)                   :: KD             
   real(rk)                   :: secchi_depth   
   real(rk)                   :: det_C          
   real(rk)                   :: chl_a_C        
   real(rk)                   :: chl_a_lpp_C    
   real(rk)                   :: chl_a_spp_C    
   real(rk)                   :: chl_a_cya_C    
   real(rk)                   :: cdom3_C        
   real(rk)                   :: cdom2_C        
   real(rk)                   :: cdom1_C        
   real(rk)                   :: r_zoo_mort_light
   real(rk)                   :: frac_denit_sed 
   real(rk)                   :: sed_tot        
   real(rk)                   :: sed_tot_active 
   real(rk)                   :: sed_tot_burial 
   real(rk)                   :: sed_active     
   real(rk)                   :: lr_sed_rec     
   real(rk)                   :: lr_sed_poc_rec 
   real(rk)                   :: ips_eff        
   real(rk)                   :: erosion_is_active
   real(rk)                   :: poc_active     
   real(rk)                   :: pocn_active    
   real(rk)                   :: pocp_active    
    real(rk)        :: lim_t_n2_7          
    real(rk)        :: lim_t_o2_0          
    real(rk)        :: lim_t_o2_2          
    real(rk)        :: lim_t_o2_4          
    real(rk)        :: lim_t_o2_6          
    real(rk)        :: lim_t_dic_8         
    real(rk)        :: lim_t_nh4_11        
    real(rk)        :: lim_t_no3_1         
    real(rk)        :: lim_t_no3_3         
    real(rk)        :: lim_t_no3_10        
    real(rk)        :: lim_t_po4_9         
    real(rk)        :: lim_t_spp_16        
    real(rk)        :: lim_t_zoo_18        
    real(rk)        :: lim_t_h2s_5         
    real(rk)        :: lim_t_h2s_23        
    real(rk)        :: lim_t_sul_24        
    real(rk)        :: lim_t_ipw_25        
    real(rk)        :: lim_t_lpp_15        
    real(rk)        :: lim_t_cya_17        
    real(rk)        :: lim_t_det_19        
    real(rk)        :: lim_t_poc_12        
    real(rk)        :: lim_t_pocp_13       
    real(rk)        :: lim_t_pocn_14       
    real(rk)        :: lim_t_doc_28        
    real(rk)        :: lim_t_dop_29        
    real(rk)        :: lim_t_don_30        
    real(rk)        :: lim_t_cdom_31       
    real(rk)        :: lim_t_sed_20        
    real(rk)        :: lim_t_ips_22        
    real(rk)        :: lim_t_sed_poc_21    
    real(rk)        :: lim_t_sed_pocn_26   
    real(rk)        :: lim_t_sed_pocp_27   
   real(rk)                   :: p_sed_resp_nh4 
   real(rk)                   :: p_nh4_nitdenit_n2
   real(rk)                   :: p_sed_denit_nh4
   real(rk)                   :: p_sed_sulf_nh4 
   real(rk)                   :: p_sed_poc_resp 
   real(rk)                   :: p_sed_poc_denit
   real(rk)                   :: p_sed_poc_sulf 
   real(rk)                   :: p_po4_retent_ips
   real(rk)                   :: p_ips_liber_po4
   real(rk)                   :: p_det_sedi_sed 
   real(rk)                   :: p_ipw_sedi_ips 
   real(rk)                   :: p_poc_sedi_sed 
   real(rk)                   :: p_pocn_sedi_sed
   real(rk)                   :: p_pocp_sedi_sed
   real(rk)                   :: p_sed_ero_det  
   real(rk)                   :: p_ips_ero_ipw  
   real(rk)                   :: p_sed_ero_poc  
   real(rk)                   :: p_sed_ero_pocn 
   real(rk)                   :: p_sed_ero_pocp 
   real(rk)                   :: p_sed_biores_det
   real(rk)                   :: p_ips_biores_ipw
   real(rk)                   :: p_sed_biores_poc
   real(rk)                   :: p_sed_biores_pocn
   real(rk)                   :: p_sed_biores_pocp
   real(rk)                   :: p_sed_burial   
   real(rk)                   :: p_ips_burial   
   real(rk)                   :: p_poc_burial   
   real(rk)                   :: p_pocn_burial  
   real(rk)                   :: p_pocp_burial  
   real(rk)                   :: p_sed_pocn_resp
   real(rk)                   :: p_sed_pocp_resp
   real(rk)                   :: p_sed_pocn_denit
   real(rk)                   :: p_sed_pocp_denit
   real(rk)                   :: p_sed_pocn_sulf
   real(rk)                   :: p_sed_pocp_sulf
   real(rk)                   :: p_nh4_nitdenit_pocn_n2
   real(rk)                   :: cgt_temp
   real(rk)                   :: cgt_sali
   real(rk)                   :: cgt_light
   real(rk)                   :: cgt_density
   real(rk)                   :: cgt_longitude
   real(rk)                   :: cgt_latitude
   real(rk)                   :: cgt_current_wave_stress
   real(rk)                   :: cgt_bottomdepth
   real(rk)                   :: cgt_timestep
   real(rk)                   :: temp1, temp2, temp3, temp4, temp5, &
                                 temp6, temp7, temp8, temp9
   real(rk)                   :: inv_secs_pr_day
   real(rk)                   :: inv_secs_pr_day_density
   real(rk), parameter        :: secs_pr_day=86400.0_rk
!    integer        :: cgt_iteration        ! current number of iteration in the iterative loop
   real(rk)                   :: cgt_iteration        ! current number of iteration in the iterative loop

!EOP
!-----------------------------------------------------------------------
!BOC

   inv_secs_pr_day = 1.0_rk/secs_pr_day
   ! Store values of constants in local variables
      critical_stress = self%critical_stress
      cya0            = self%cya0           
      din_min_lpp     = self%din_min_lpp    
      din_min_spp     = self%din_min_spp    
      dip_min_cya     = self%dip_min_cya    
      epsilon         = self%epsilon        
      food_min_zoo    = self%food_min_zoo   
      gamma0          = self%gamma0         
      gamma1          = self%gamma1         
      gamma2          = self%gamma2         
      gamma3          = self%gamma3         
      h2s_min_po4_liber = self%h2s_min_po4_liber
      ips_threshold   = self%ips_threshold  
      ips_cl          = self%ips_cl         
      k_h2s_no3       = self%k_h2s_no3      
      k_h2s_o2        = self%k_h2s_o2       
      k_sul_no3       = self%k_sul_no3      
      k_sul_o2        = self%k_sul_o2       
      light_opt_cya   = self%light_opt_cya  
      light_opt_lpp   = self%light_opt_lpp  
      light_opt_spp   = self%light_opt_spp  
      lpp0            = self%lpp0           
      no3_min_sed_denit = self%no3_min_sed_denit
      no3_min_det_denit = self%no3_min_det_denit
      o2_min_det_resp = self%o2_min_det_resp
      o2_min_nit      = self%o2_min_nit     
      o2_min_po4_retent = self%o2_min_po4_retent
      o2_min_sed_resp = self%o2_min_sed_resp
      patm_co2        = self%patm_co2       
      q10_det_rec     = self%q10_det_rec    
      q10_doc_rec     = self%q10_doc_rec    
      q10_h2s         = self%q10_h2s        
      q10_nit         = self%q10_nit        
      q10_sed_rec     = self%q10_sed_rec    
      r_biores        = self%r_biores       
      r_cya_assim     = self%r_cya_assim    
      r_cya_resp      = self%r_cya_resp     
      r_det_rec       = self%r_det_rec      
      r_ips_burial    = self%r_ips_burial   
      r_ips_ero       = self%r_ips_ero      
      r_ips_liber     = self%r_ips_liber    
      r_lpp_assim     = self%r_lpp_assim    
      r_lpp_resp      = self%r_lpp_resp     
      r_nh4_nitrif    = self%r_nh4_nitrif   
      r_pp_mort       = self%r_pp_mort      
      r_cya_mort_diff = self%r_cya_mort_diff
      r_cya_mort_thresh = self%r_cya_mort_thresh
      r_sed_ero       = self%r_sed_ero      
      r_sed_rec       = self%r_sed_rec      
      r_sed_poc_rec   = self%r_sed_poc_rec  
      r_spp_assim     = self%r_spp_assim    
      r_spp_resp      = self%r_spp_resp     
      r_zoo_graz      = self%r_zoo_graz     
      r_zoo_mort      = self%r_zoo_mort     
      r_zoo_resp      = self%r_zoo_resp     
      rfr_c           = self%rfr_c          
      rfr_h           = self%rfr_h          
      rfr_o           = self%rfr_o          
      rfr_p           = self%rfr_p          
      rfr_cp          = self%rfr_cp         
      sali_max_cya    = self%sali_max_cya   
      sali_min_cya    = self%sali_min_cya   
      nit_max_cya     = self%nit_max_cya    
      nit_switch_cya  = self%nit_switch_cya 
      sed_max         = self%sed_max        
      sed_burial      = self%sed_burial     
      spp0            = self%spp0           
      temp_min_cya    = self%temp_min_cya   
      temp_switch_cya = self%temp_switch_cya
      temp_min_spp    = self%temp_min_spp   
      temp_opt_zoo    = self%temp_opt_zoo   
      w_co2_stf       = self%w_co2_stf      
      w_cya           = self%w_cya          
      w_det           = self%w_det          
      w_ipw           = self%w_ipw          
      w_det_sedi      = self%w_det_sedi     
      w_ipw_sedi      = self%w_ipw_sedi     
      w_lpp           = self%w_lpp          
      w_n2_stf        = self%w_n2_stf       
      w_o2_stf        = self%w_o2_stf       
      zoo0            = self%zoo0           
      zoo_cl          = self%zoo_cl         
      don_fraction    = self%don_fraction   
      r_poc_rec       = self%r_poc_rec      
      r_pocp_rec      = self%r_pocp_rec     
      r_pocn_rec      = self%r_pocn_rec     
      w_poc           = self%w_poc          
      w_poc_sedi      = self%w_poc_sedi     
      w_pocp          = self%w_pocp         
      w_pocp_sedi     = self%w_pocp_sedi    
      w_pocn          = self%w_pocn         
      w_pocn_sedi     = self%w_pocn_sedi    
      fac_doc_assim_lpp = self%fac_doc_assim_lpp
      fac_doc_assim_cya = self%fac_doc_assim_cya
      fac_doc_assim_spp = self%fac_doc_assim_spp
      fac_dop_assim   = self%fac_dop_assim  
      fac_don_assim   = self%fac_don_assim  
      fac_enh_rec     = self%fac_enh_rec    
      ret_po4_1       = self%ret_po4_1      
      ret_po4_2       = self%ret_po4_2      
      frac_denit_scal = self%frac_denit_scal
      reduced_rec     = self%reduced_rec    
      martin_fac_poc  = self%martin_fac_poc 
      r_doc2poc       = self%r_doc2poc      
      r_don2pocn      = self%r_don2pocn     
      r_dop2pocp      = self%r_dop2pocp     
      r_doc_rec       = self%r_doc_rec      
      r_don_rec       = self%r_don_rec      
      r_dop_rec       = self%r_dop_rec      
      fac_ips_burial  = self%fac_ips_burial 
      r_cdom_decay    = self%r_cdom_decay   
      r_cdom_light    = self%r_cdom_light   
      ten             = self%ten            
      zero            = self%zero           
      one             = self%one            
      three           = self%three          
      min_chl_n       = self%min_chl_n      
      max_chl_n       = self%max_chl_n      
      light_max       = self%light_max      
      molar_mass_C    = self%molar_mass_C   
      I_h             = self%I_h            

   ! Enter spatial loops over the horizontal domain (if any).
   _HORIZONTAL_LOOP_BEGIN_

   ! Retrieve abiotic parameters
      _GET_HORIZONTAL_(self%id_taub,cgt_current_wave_stress)
      _GET_HORIZONTAL_(self%id_depth,cgt_bottomdepth) !local water depth
      _GET_HORIZONTAL_(self%id_lon,cgt_longitude)     ! Longitude [degE]
      _GET_HORIZONTAL_(self%id_lat,cgt_latitude)      ! Latitude  [degN]
      _GET_   (self%id_par,cgt_light)    ! local photosynthetically active radiation
      _GET_   (self%id_temp,cgt_temp)    ! local water temperature
      _GET_   (self%id_salt,cgt_sali)    ! local water salinity
      _GET_GLOBAL_(self%id_timestep,cgt_timestep)    ! integration time step [s]
      cgt_density   = 1035.0_rk          ! Boussinesq density
!      cgt_timestep  = 1.0_rk
      cgt_timestep  = cgt_timestep/secs_pr_day  ! ecosystem model time step [d]

      inv_secs_pr_day_density = 1.0_rk/(cgt_density*secs_pr_day)

   ! Retrieve current (local) state variable values.
      _GET_(self%id_t_n2           ,t_n2           )
      _GET_(self%id_t_o2           ,t_o2           )
      _GET_(self%id_t_dic          ,t_dic          )
      _GET_(self%id_t_nh4          ,t_nh4          )
      _GET_(self%id_t_no3          ,t_no3          )
      _GET_(self%id_t_po4          ,t_po4          )
      _GET_(self%id_t_spp          ,t_spp          )
      _GET_(self%id_t_zoo          ,t_zoo          )
      _GET_(self%id_t_h2s          ,t_h2s          )
      _GET_(self%id_t_sul          ,t_sul          )
      _GET_(self%id_t_alk          ,t_alk          )
      _GET_(self%id_t_ipw          ,t_ipw          )
      _GET_(self%id_t_lpp          ,t_lpp          )
      _GET_(self%id_t_cya          ,t_cya          )
      _GET_(self%id_t_det          ,t_det          )
      _GET_(self%id_t_poc          ,t_poc          )
      _GET_(self%id_t_pocp         ,t_pocp         )
      _GET_(self%id_t_pocn         ,t_pocn         )
      _GET_(self%id_t_doc          ,t_doc          )
      _GET_(self%id_t_dop          ,t_dop          )
      _GET_(self%id_t_don          ,t_don          )
      _GET_(self%id_t_cdom         ,t_cdom         )
      _GET_HORIZONTAL_(self%id_t_sed          ,t_sed          )
      _GET_HORIZONTAL_(self%id_t_ips          ,t_ips          )
      _GET_HORIZONTAL_(self%id_t_sed_poc      ,t_sed_poc      )
      _GET_HORIZONTAL_(self%id_t_sed_pocn     ,t_sed_pocn     )
      _GET_HORIZONTAL_(self%id_t_sed_pocp     ,t_sed_pocp     )

! Initialize auxiliaries for iterative loop
             temp_k          = 0.0
             ph_temp         = 0.0
             k_water         = 0.0
             k0_co2          = 0.0
             k1_co2          = 0.0
             k2_co2          = 0.0
             k_boron         = 0.0
             k1_po4          = 0.0
             k2_po4          = 0.0
             k3_po4          = 0.0
             k1_h2s          = 0.0
             boron_total     = 0.0
             alk_boron       = 0.0
             alk_h2s         = 0.0
             alk_water       = 0.0
             alk_po4_denominator = 0.0
             alk_po4         = 0.0
             alk_co2_denominator = 0.0
             alk_co2         = 0.0
             alk_residual    = 0.0
             dalkp_dh3o      = 0.0
             dalkc_dh3o      = 0.0
             dalkresidual_dpH = 0.0
             ph              = 0.0
             h3o             = 1.0e-8


! Iterative loop follows
             do cgt_iteration=1,10
                if (cgt_iteration .le. 1) then
                   ! absolute temperature [K] :
                   temp_k          = cgt_temp + 273.15             
                endif
                if (cgt_iteration .le. 10) then
                   ! temporary value assumed for pH [1] :
                   ph_temp         = 0.0-log(h3o)/log(10.0)        
                endif
                if (cgt_iteration .le. 1) then
                   ! self-ionization constant of Water [mol2/kg2] :
                   k_water         = exp( -13847.26 / temp_k + 148.96502 - 23.6521 * log(temp_k) + (118.67/temp_k - 5.977 + 1.0495 * log(temp_k)) * sqrt(cgt_sali) - 0.01615 * cgt_sali)
                endif
                if (cgt_iteration .le. 1) then
                   ! Solubility of CO2 [mol/kg/Pa] :
                   k0_co2          = exp(9345.17 / temp_k - 60.2409 + 23.3585 * (log(temp_k) - 4.605170186) + cgt_sali*(0.023517 - 0.00023656 * temp_k + 0.00000047036 *temp_k*temp_k))/101325.0
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant CO2 + 2 H2O <-> HCO3- + H3O+ [mol/kg] :
                   k1_co2          = power(ten,( -3633.86 / temp_k + 61.2172 - 9.6777 * log(temp_k) + 0.011555 * cgt_sali - 0.0001152 * cgt_sali * cgt_sali))
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant HCO3- + H2O <-> [CO3 2-] + H3O+ [mol/kg] :
                   k2_co2          = power(ten,( -471.78 / temp_k - 25.929 + 3.16967 * log(temp_k) + 0.01781 * cgt_sali - 0.0001122 * cgt_sali * cgt_sali))
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant of boric acid [mol/kg] :
                   k_boron         = exp(( -8966.9 - 2890.53*sqrt(cgt_sali) - 77.942*cgt_sali + 1.728*cgt_sali*sqrt(cgt_sali) - 0.0996*cgt_sali*cgt_sali) / temp_k + 148.0248 + 137.1942*sqrt(cgt_sali) + 1.62142*cgt_sali + (-24.4344 - 25.085*sqrt(cgt_sali &
) - 0.2474*cgt_sali)*log(temp_k) + 0.053105*sqrt(cgt_sali)*temp_k )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant H3PO4 + H2O <-> [H2PO4 -] + H3O+ [mol/kg] :
                   k1_po4          = exp( -4576.752/temp_k + 115.525 - 18.453*log(temp_k) + (0.69171 - 106.736/temp_k)*sqrt(cgt_sali) - (0.01844 + 0.65643/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant [H2PO4 -] + H2O+ <-> [HPO4 2-] + H3O+ [mol/kg] :
                   k2_po4          = exp( -8814.715/temp_k + 172.0883 - 27.927*log(temp_k) + (1.35660 - 160.340/temp_k)*sqrt(cgt_sali) - (0.05778 - 0.37335/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant [HPO4 2-] + H2O <-> [PO4 3-] + H3O+ [mol/kg] :
                   k3_po4          = exp( -3070.75/temp_k - 18.141 + (2.81197 + 17.27039/temp_k)*sqrt(cgt_sali) - (0.09984 + 44.99486/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant H2S + H2O <-> HS- + H3O+ [mol/kg] :
                   k1_h2s          = exp( -3131.42/temp_k + 5.818 + 0.368*(power(max(zero,cgt_sali),(one/three))))
                endif
                if (cgt_iteration .le. 1) then
                   ! total concentration of boron [mol/kg] :
                   boron_total     = 0.000416 * cgt_sali/35.0      
                endif
                if (cgt_iteration .le. 10) then
                   ! boron alkalinity [mol/kg] :
                   alk_boron       = boron_total * k_boron / (k_boron + h3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! hydrogen sulfide alkalinity [mol/kg] :
                   alk_h2s         = t_h2s * k1_h2s / (k1_h2s + h3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! water alkalinity [mol/kg] :
                   alk_water       = k_water / h3o - h3o           
                endif
                if (cgt_iteration .le. 10) then
                   ! denominator in phosphate alkalinity formula [mol3/kg3] :
                   alk_po4_denominator = (h3o*h3o*h3o + k1_po4*h3o*h3o + k1_po4*k2_po4*h3o + k1_po4*k2_po4*k3_po4)
                endif
                if (cgt_iteration .le. 10) then
                   ! phosphate alkalinity [mol/kg] :
                   alk_po4         = t_po4*(k1_po4*k2_po4*h3o + 2.0*k1_po4*k2_po4*k3_po4 - h3o*h3o*h3o) / alk_po4_denominator
                endif
                if (cgt_iteration .le. 10) then
                   ! denominator in carbonate alkalinity formula [mol2/kg2] :
                   alk_co2_denominator = (h3o*h3o + k1_co2*h3o + k1_co2*k2_co2)
                endif
                if (cgt_iteration .le. 10) then
                   ! carbonate alkalinity [mol/kg] :
                   alk_co2         = t_dic*k1_co2*(h3o+2*k2_co2)/alk_co2_denominator
                endif
                if (cgt_iteration .le. 10) then
                   ! error in total alkalinity calculation at the assumed pH [mol/kg] :
                   alk_residual    = t_alk - alk_co2 - alk_po4 - alk_boron - alk_h2s - alk_water
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of phosphate alkalinity with respect to h3o [1] :
                   dalkp_dh3o      = t_po4*(0.0-k1_po4*h3o*h3o*h3o*h3o-4*k1_po4*k2_po4*h3o*h3o*h3o-(k1_po4*k1_po4*k2_po4+9*k1_po4*k2_po4*k3_po4)*h3o*h3o-4*k1_po4*k1_po4*k2_po4*k3_po4*h3o-k1_po4*k1_po4*k2_po4*k2_po4*k3_po4 &
)/(alk_po4_denominator*alk_po4_denominator)
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of carbonate alkalinity with respect to h3o [1] :
                   dalkc_dh3o      = t_dic*(0.0-k1_co2*h3o*h3o-k1_co2*k1_co2*k2_co2-4*k1_co2*k2_co2*h3o)/(alk_co2_denominator*alk_co2_denominator)
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of residual_alk with respect to pH [mol/kg] :
                   dalkresidual_dpH = 0.0-log(10.0)*h3o*(alk_boron/(k_boron+h3o)+alk_h2s/(k1_h2s+h3o)+k_water/(h3o*h3o)+1-dalkp_dh3o-dalkc_dh3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! newly determined pH value [1] :
                   temp1 = alk_residual/dalkresidual_dpH 
                   ph              = ph_temp - temp1 + theta(abs(temp1) - 1)*0.5*temp1
                endif
                if (cgt_iteration .le. 10) then
                   ! h3o ion concentration [mol/kg] :
                   h3o             = power(ten,0.0-max(one,min((ten+three),ph)))
                endif
             enddo

!   Calculation of auxiliary variables (not iterative)
    o2_sat          = (10.18e0+((5.306e-3-4.8725e-5*cgt_temp)*cgt_temp-0.2785e0)*cgt_temp+cgt_sali*((2.2258e-3+(4.39e-7*cgt_temp-4.645e-5)*cgt_temp)*cgt_temp-6.33e-2))*44.66e0*1e-6
    temp1 = log((298.15-cgt_temp)/(273.15+cgt_temp))
    temp2 = temp1*temp1                   
    temp3 = temp2*temp1                   
    n2_sat          = 1e-6*exp(6.42931 + 2.92704*temp1 + 4.32531*temp2 + 4.69149*temp3 + cgt_sali*(0.0 -7.44129e-3 - 8.02566e-3*temp1 - 1.46775e-2*temp2))
    solubility_n2   = n2_sat * 1.263925e-5          
    temp_sq         = max(0.0,cgt_temp)*max(0.0,cgt_temp)
    zoo_eff         = t_zoo*t_zoo/zoo_cl            
    din             = t_no3+t_nh4                   
    din_sq          = din*din                       
    po4_sq          = t_po4*t_po4                   
    phyto           = t_lpp+t_spp+t_cya             
    lpp_plus_lpp0   = t_lpp+lpp0                    
    spp_plus_spp0   = t_spp+spp0                    
    cya_plus_cya0   = t_cya+cya0                    
    food_zoo        = t_lpp+t_spp+0.5*t_cya         
    temp1 = max(cgt_light/2.0,light_opt_lpp)
    lim_light_lpp   = cgt_light/temp1*exp(1-cgt_light/temp1)
    temp1 = max(cgt_light/2.0,light_opt_spp)
    lim_light_spp   = cgt_light/temp1*exp(1-cgt_light/temp1)
    temp1 = max(cgt_light/2.0,light_opt_cya)
    lim_light_cya   = cgt_light/temp1*exp(1-cgt_light/temp1)
    lr_assim_lpp    = r_lpp_assim*theta(t_o2-2*t_h2s)*min(din_sq/(din_sq+din_min_lpp*din_min_lpp),min(po4_sq/(po4_sq+din_min_lpp*din_min_lpp*rfr_p*rfr_p),lim_light_lpp))
    lr_assim_lpp_doc = fac_doc_assim_lpp * r_lpp_assim * theta(t_o2-2*t_h2s) * min(max(1 - din_sq/(din_sq+din_min_lpp*din_min_lpp),1 - po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
    lr_assim_spp_doc = fac_doc_assim_spp * r_spp_assim * theta(t_o2-2*t_h2s) * min(max(1 - din_sq/(din_sq+din_min_spp*din_min_spp),1 - po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
    lr_assim_cya_doc = fac_doc_assim_cya * r_cya_assim*theta(t_o2-2*t_h2s)*min(1 - po4_sq/(po4_sq+dip_min_cya*dip_min_cya),lim_light_cya)*(1/(1+exp(temp_switch_cya*(temp_min_cya-cgt_temp))))*(1/(1+exp(cgt_sali-sali_max_cya)) &
)*(1/(1+exp(sali_min_cya-cgt_sali)))
    lr_assim_spp    = r_spp_assim*theta(t_o2-2*t_h2s)*min(din_sq/(din_sq+din_min_spp*din_min_spp),min(po4_sq/(po4_sq+din_min_spp*din_min_spp*rfr_p*rfr_p),lim_light_spp))*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
    lr_assim_cya    = r_cya_assim*theta(t_o2-2*t_h2s)*min(po4_sq/(po4_sq+dip_min_cya*dip_min_cya),lim_light_cya)*(1/(1+exp(temp_switch_cya*(temp_min_cya-cgt_temp))))*(1/(1+exp(cgt_sali-sali_max_cya)))*(1/(1+exp(sali_min_cya-cgt_sali)) &
)*(1/(1+exp(nit_switch_cya*(din-nit_max_cya))))
    lr_assim_lpp_dop = fac_dop_assim * r_lpp_assim * theta(t_o2-2*t_h2s) * min(min(1 - din_sq/(din_sq+din_min_lpp*din_min_lpp),po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
    lr_assim_spp_dop = fac_dop_assim * r_spp_assim * theta(t_o2-2*t_h2s) * min(min(1 - din_sq/(din_sq+din_min_spp*din_min_spp),po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
    lr_assim_lpp_don = fac_don_assim * r_lpp_assim * theta(t_o2-2*t_h2s) * min(min(din_sq/(din_sq+din_min_lpp*din_min_lpp),1 - po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
    lr_assim_spp_don = fac_don_assim * r_spp_assim * theta(t_o2-2*t_h2s) * min(min(din_sq/(din_sq+din_min_spp*din_min_spp),1 - po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
    lr_graz_zoo     = r_zoo_graz*(1-exp(-food_zoo*food_zoo/(food_min_zoo*food_min_zoo)))*theta(t_o2-2*t_h2s)*(1.0+temp_sq/(temp_opt_zoo*temp_opt_zoo)*exp(2.0-cgt_temp*2.0/temp_opt_zoo))
    frac_po4retent  = ret_po4_1 + ret_po4_2*theta(cgt_latitude-60.75)
    ref_p_sw        = (1 - (po4_sq/(rfr_p*din_min_lpp*rfr_p*din_min_lpp+po4_sq)))/(1+exp(6.0*(1-din/(t_po4/rfr_p+epsilon))))
    ref_n_sw        = (1 - (din_sq/(din_min_lpp*din_min_lpp+din_sq)))/(1+exp(6.0*(1-t_po4/rfr_p/(din+epsilon))))
    lr_pocp         = r_pocp_rec*(1 + fac_enh_rec*ref_p_sw)
    lr_dop          = r_dop_rec*(1 + fac_enh_rec*ref_p_sw)
    lr_pocn         = r_pocn_rec*(1 + fac_enh_rec*ref_n_sw)
    lr_don          = r_don_rec*(1 + fac_enh_rec*ref_n_sw)
    w_poc_var       = martin_fac_poc * cgt_bottomdepth * (-1.0)
    w_pocn_var      = -0.15                         
    w_pocp_var      = -0.15                         
    phyto_C         = (t_lpp+t_spp+t_cya)*rfr_c *1000 *cgt_density
    cdom_decay      = r_cdom_decay/(0.037*12*10**6) 
    lpp_C           = t_lpp*molar_mass_C*rfr_c*1000*cgt_density
    spp_C           = t_spp*molar_mass_C*rfr_c*1000*cgt_density
    cya_C           = t_cya*molar_mass_C*rfr_c*1000*cgt_density
    chl_a           = ((t_lpp+t_spp+t_cya)*1000*cgt_density)*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    KD              = gamma0+(t_spp+t_lpp+t_cya)*gamma1*cgt_density+t_det*gamma2*cgt_density+t_cdom*gamma3*cgt_density
    secchi_depth    = theta(KD)*(1.614*KD**(-0.936)) + theta(1.0e-8-KD)*0.01
    det_C           = t_det*molar_mass_C*1000*rfr_c*cgt_density
    chl_a_C         = ((lpp_C+spp_C+cya_C))*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    chl_a_lpp_C     = lpp_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    chl_a_spp_C     = spp_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    chl_a_cya_C     = cya_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
    cdom3_C         = t_cdom*molar_mass_C*1000*rfr_c*cgt_density
    cdom2_C         = 0                             
    cdom1_C         = 0                             
    r_zoo_mort_light = 0.005 + 0.035 * cgt_light/(I_h+cgt_light)
       frac_denit_sed  = frac_denit_scal*(0.5+0.5*exp(-0.01*cgt_bottomdepth))
       sed_tot         = t_sed*rfr_c + t_sed_poc + t_sed_pocn*rfr_c + t_sed_pocp*rfr_cp
       sed_tot_active  = max(0.0,min(sed_tot,sed_max*rfr_c))
       sed_tot_burial  = max(0.0,min(sed_tot,sed_burial*rfr_c))
       sed_active      = sed_tot_active * t_sed/sed_tot
       lr_sed_rec      = r_sed_rec*exp(q10_sed_rec*cgt_temp)*(1.0-reduced_rec*theta(2*t_h2s-t_o2))
       lr_sed_poc_rec  = r_sed_poc_rec*exp(q10_sed_rec*cgt_temp)*(1.0-reduced_rec*theta(2*t_h2s-t_o2))
       ips_eff         = max(t_ips,t_ips+t_ips*(t_ips-ips_threshold)/ips_cl)
       erosion_is_active = theta(cgt_current_wave_stress - critical_stress)
       poc_active      = sed_tot_active * t_sed_poc/sed_tot
       pocn_active     = sed_tot_active * t_sed_pocn/sed_tot
       pocp_active     = sed_tot_active * t_sed_pocp/sed_tot

   ! Calculate process limitation functions
       lim_t_n2_7           = theta(t_n2-0.0)
       lim_t_o2_0           = 1.0-exp(-t_o2/o2_min_det_resp)
       lim_t_o2_2           = theta(t_o2-0.0)
       lim_t_o2_4           = t_o2*t_o2/(t_o2*t_o2+o2_min_po4_retent*o2_min_po4_retent)
       lim_t_o2_6           = t_o2*t_o2/(t_o2*t_o2+o2_min_sed_resp*o2_min_sed_resp)
       lim_t_dic_8          = theta(t_dic-0.0)
       lim_t_nh4_11         = theta(t_nh4-0.0)
       lim_t_no3_1          = 1.0-exp(-t_no3/no3_min_det_denit)
       lim_t_no3_3          = t_no3*t_no3/(t_no3*t_no3+no3_min_sed_denit*no3_min_sed_denit)
       lim_t_no3_10         = theta(t_no3-0.0)
       lim_t_po4_9          = theta(t_po4-0.0)
       lim_t_spp_16         = theta(t_spp-0.0)
       lim_t_zoo_18         = theta(t_zoo-0.0)
       lim_t_h2s_5          = theta(t_h2s-h2s_min_po4_liber)
       lim_t_h2s_23         = theta(t_h2s-0.0)
       lim_t_sul_24         = theta(t_sul-0.0)
       lim_t_ipw_25         = theta(t_ipw-0.0)
       lim_t_lpp_15         = theta(t_lpp-0.0)
       lim_t_cya_17         = theta(t_cya-0.0)
       lim_t_det_19         = theta(t_det-0.0)
       lim_t_poc_12         = theta(t_poc-0.0)
       lim_t_pocp_13        = theta(t_pocp-0.0)
       lim_t_pocn_14        = theta(t_pocn-0.0)
       lim_t_doc_28         = theta(t_doc-0.0)
       lim_t_dop_29         = theta(t_dop-0.0)
       lim_t_don_30         = theta(t_don-0.0)
       lim_t_cdom_31        = theta(t_cdom-0.0)
       lim_t_sed_20         = theta(t_sed-0.0)
       lim_t_ips_22         = theta(t_ips-0.0)
       lim_t_sed_poc_21     = theta(t_sed_poc-0.0)
       lim_t_sed_pocn_26    = theta(t_sed_pocn-0.0)
       lim_t_sed_pocp_27    = theta(t_sed_pocp-0.0)

   ! Calculate process rates
       p_sed_resp_nh4  = (lr_sed_rec*sed_active)*lim_t_o2_2*lim_t_sed_20
       p_nh4_nitdenit_n2 = (frac_denit_sed*p_sed_resp_nh4*theta(t_o2-5.0e-6))*lim_t_nh4_11*lim_t_o2_2
       p_sed_denit_nh4 = (lr_sed_rec*sed_active)*(1.0-lim_t_o2_2)*lim_t_no3_3*lim_t_sed_20
       p_sed_sulf_nh4  = (lr_sed_rec*sed_active)*(1.0-lim_t_o2_2)*(1.0-lim_t_no3_3)*lim_t_sed_20
       p_sed_poc_resp  = (lr_sed_poc_rec*poc_active)*lim_t_o2_2*lim_t_sed_poc_21
       p_sed_poc_denit = (lr_sed_poc_rec*poc_active)*(1.0-lim_t_o2_2)*lim_t_no3_3*lim_t_sed_poc_21
       p_sed_poc_sulf  = (lr_sed_poc_rec*poc_active)*(1.0-lim_t_o2_2)*(1.0-lim_t_no3_3)*lim_t_sed_poc_21
       p_po4_retent_ips = (p_sed_resp_nh4*frac_po4retent)*lim_t_o2_4*lim_t_po4_9
       p_ips_liber_po4 = (t_ips*r_ips_liber)*lim_t_h2s_5*lim_t_ips_22
       p_det_sedi_sed  = ((1.0-erosion_is_active)*(0.0-w_det_sedi)*t_det*cgt_density)*lim_t_det_19
       p_ipw_sedi_ips  = ((1.0-erosion_is_active)*(0.0-w_ipw_sedi)*t_ipw*cgt_density)*lim_t_ipw_25
       p_poc_sedi_sed  = ((1.0-erosion_is_active)*(0.0-w_poc_var)*t_poc*cgt_density)*lim_t_poc_12
       p_pocn_sedi_sed = ((1.0-erosion_is_active)*(0.0-w_pocn_sedi)*t_pocn*cgt_density)*lim_t_pocn_14
       p_pocp_sedi_sed = ((1.0-erosion_is_active)*(0.0-w_pocp_sedi)*t_pocp*cgt_density)*lim_t_pocp_13
       p_sed_ero_det   = (erosion_is_active*r_sed_ero*sed_active)*lim_t_sed_20
       p_ips_ero_ipw   = (erosion_is_active*r_ips_ero*t_ips)*lim_t_ips_22
       p_sed_ero_poc   = (erosion_is_active*r_sed_ero*poc_active)*lim_t_sed_poc_21
       p_sed_ero_pocn  = (erosion_is_active*r_sed_ero*pocn_active)*lim_t_sed_pocn_26
       p_sed_ero_pocp  = (erosion_is_active*r_sed_ero*pocp_active)*lim_t_sed_pocp_27
       p_sed_biores_det = (r_biores*exp(-0.02*cgt_bottomdepth)*sed_active)*lim_t_o2_6*lim_t_sed_20
       p_ips_biores_ipw = (r_biores*exp(-0.02*cgt_bottomdepth)*t_ips)*lim_t_o2_6*lim_t_ips_22
       p_sed_biores_poc = (r_biores*exp(-0.02*cgt_bottomdepth)*poc_active)*lim_t_o2_6*lim_t_sed_poc_21
       p_sed_biores_pocn = (r_biores*exp(-0.02*cgt_bottomdepth)*pocn_active)*lim_t_o2_6*lim_t_sed_pocn_26
       p_sed_biores_pocp = (r_biores*exp(-0.02*cgt_bottomdepth)*pocp_active)*lim_t_o2_6*lim_t_sed_pocp_27
       p_sed_burial    = ((sed_tot-sed_tot_burial)/cgt_timestep*t_sed/sed_tot)*lim_t_sed_20
       p_ips_burial    = (fac_ips_burial*(sed_tot-sed_tot_burial)/cgt_timestep*t_ips/sed_tot)*lim_t_ips_22
       p_poc_burial    = ((sed_tot-sed_tot_burial)/cgt_timestep*t_sed_poc/sed_tot)*lim_t_sed_poc_21
       p_pocn_burial   = ((sed_tot-sed_tot_burial)/cgt_timestep*t_sed_pocn/sed_tot)*lim_t_sed_pocn_26
       p_pocp_burial   = ((sed_tot-sed_tot_burial)/cgt_timestep*t_sed_pocp/sed_tot)*lim_t_sed_pocp_27
       p_sed_pocn_resp = (lr_sed_rec*pocn_active)*lim_t_sed_pocn_26*lim_t_o2_2
       p_sed_pocp_resp = (lr_sed_rec*pocp_active)*lim_t_o2_2*lim_t_sed_pocp_27
       p_sed_pocn_denit = (lr_sed_rec*pocn_active)*(1.0-lim_t_o2_2)*lim_t_no3_3*lim_t_sed_pocn_26
       p_sed_pocp_denit = (lr_sed_rec*pocp_active)*(1.0-lim_t_o2_2)*lim_t_no3_3*lim_t_sed_pocp_27
       p_sed_pocn_sulf = (lr_sed_rec*pocn_active)*(1.0-lim_t_o2_2)*(1.0-lim_t_no3_3)*lim_t_pocn_14
       p_sed_pocp_sulf = (lr_sed_rec*pocp_active)*(1.0-lim_t_o2_2)*(1.0-lim_t_no3_3)*lim_t_pocp_13
       p_nh4_nitdenit_pocn_n2 = (frac_denit_sed*p_sed_pocn_resp*theta(t_o2-5.0e-6))*lim_t_o2_2*lim_t_nh4_11

   ! Apply time tendencies to tracers
      _SET_BOTTOM_ODE_(self%id_t_sed          ,0.0                     + p_det_sedi_sed              *inv_secs_pr_day                     - p_sed_resp_nh4              *inv_secs_pr_day                     - p_sed_denit_nh4             *inv_secs_pr_day   &
                   - p_sed_sulf_nh4              *inv_secs_pr_day                     - p_sed_ero_det               *inv_secs_pr_day                     - p_sed_biores_det            *inv_secs_pr_day                     - p_sed_burial                &
 *inv_secs_pr_day                    )
      _SET_BOTTOM_ODE_(self%id_t_ips          ,0.0                     + (p_po4_retent_ips)*(rfr_p)  *inv_secs_pr_day                     + p_ipw_sedi_ips              *inv_secs_pr_day                     - p_ips_liber_po4             *inv_secs_pr_day   &
                   - p_ips_ero_ipw               *inv_secs_pr_day                     - p_ips_biores_ipw            *inv_secs_pr_day                     - p_ips_burial                *inv_secs_pr_day                    )
      _SET_BOTTOM_ODE_(self%id_t_sed_poc      ,0.0                     + p_poc_sedi_sed              *inv_secs_pr_day                     - p_sed_poc_resp              *inv_secs_pr_day                     - p_sed_poc_denit             *inv_secs_pr_day   &
                   - p_sed_poc_sulf              *inv_secs_pr_day                     - p_sed_ero_poc               *inv_secs_pr_day                     - p_sed_biores_poc            *inv_secs_pr_day                     - p_poc_burial                &
 *inv_secs_pr_day                    )
      _SET_BOTTOM_ODE_(self%id_t_sed_pocn     ,0.0                     + p_pocn_sedi_sed             *inv_secs_pr_day                     - p_sed_ero_pocn              *inv_secs_pr_day                     - p_sed_biores_pocn           *inv_secs_pr_day   &
                   - p_pocn_burial               *inv_secs_pr_day                     - p_sed_pocn_resp             *inv_secs_pr_day                     - p_sed_pocn_denit            *inv_secs_pr_day                    )
      _SET_BOTTOM_ODE_(self%id_t_sed_pocp     ,0.0                     + p_pocp_sedi_sed             *inv_secs_pr_day                     - p_sed_ero_pocp              *inv_secs_pr_day                     - p_sed_biores_pocp           *inv_secs_pr_day   &
                   - p_pocp_burial               *inv_secs_pr_day                     - p_sed_pocp_resp             *inv_secs_pr_day                     - p_sed_pocp_denit            *inv_secs_pr_day                    )
      _SET_BOTTOM_EXCHANGE_(self%id_t_n2           ,0.0                     + (p_nh4_nitdenit_n2)*(0.5)   *inv_secs_pr_day_density                     + (p_sed_denit_nh4)*(2.65)    *inv_secs_pr_day_density                     + (p_sed_poc_denit)*(0.4)   &
   *inv_secs_pr_day_density                     + (p_sed_pocn_denit)*(2.65)   *inv_secs_pr_day_density                     + (p_sed_pocp_denit)*(42.4)   *inv_secs_pr_day_density                     + (p_nh4_nitdenit_pocn_n2)*(0.5 &
)*inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_o2           ,0.0                     - (p_sed_resp_nh4)*(6.625)    *inv_secs_pr_day_density                     - (p_nh4_nitdenit_n2)*(0.75)  *inv_secs_pr_day_density                     - p_sed_poc_resp            &
   *inv_secs_pr_day_density                     - (p_sed_pocn_resp)*(6.625)   *inv_secs_pr_day_density                     - (p_sed_pocp_resp)*(106)     *inv_secs_pr_day_density                     - (p_nh4_nitdenit_pocn_n2)*(0.75 &
)*inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_dic          ,0.0                     + (p_sed_resp_nh4)*(rfr_c)    *inv_secs_pr_day_density                     + (p_sed_denit_nh4)*(rfr_c)   *inv_secs_pr_day_density                     + (p_sed_sulf_nh4)*(rfr_c)  &
   *inv_secs_pr_day_density                     + p_sed_poc_resp              *inv_secs_pr_day_density                     + p_sed_poc_denit             *inv_secs_pr_day_density                     + p_sed_poc_sulf              *inv_secs_pr_day_density  &
                    + (p_sed_pocn_resp)*(6.625)   *inv_secs_pr_day_density                     + (p_sed_pocp_resp)*(106)     *inv_secs_pr_day_density                     + (p_sed_pocn_denit)*(6.625)  *inv_secs_pr_day_density                     + &
 (p_sed_pocp_denit)*(106)    *inv_secs_pr_day_density                     + (p_sed_pocn_sulf)*(6.625)   *inv_secs_pr_day_density                     + (p_sed_pocp_sulf)*(106)     *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_nh4          ,0.0                     + p_sed_resp_nh4              *inv_secs_pr_day_density                     + p_sed_denit_nh4             *inv_secs_pr_day_density                     + p_sed_sulf_nh4            &
   *inv_secs_pr_day_density                     + p_sed_pocn_resp             *inv_secs_pr_day_density                     + p_sed_pocn_denit            *inv_secs_pr_day_density                     + p_sed_pocn_sulf             *inv_secs_pr_day_density  &
                    - p_nh4_nitdenit_n2           *inv_secs_pr_day_density                     - p_nh4_nitdenit_pocn_n2      *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_no3          ,0.0                     - (p_sed_denit_nh4)*(5.3)     *inv_secs_pr_day_density                     - (p_sed_poc_denit)*(0.8)     *inv_secs_pr_day_density                     - (p_sed_pocn_denit)*(5.3)  &
   *inv_secs_pr_day_density                     - (p_sed_pocp_denit)*(84.8)   *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_po4          ,0.0                     + (p_sed_resp_nh4)*(rfr_p)    *inv_secs_pr_day_density                     + (p_sed_denit_nh4)*(rfr_p)   *inv_secs_pr_day_density                     + (p_sed_sulf_nh4)*(rfr_p)  &
   *inv_secs_pr_day_density                     + p_ips_liber_po4             *inv_secs_pr_day_density                     + p_sed_pocp_resp             *inv_secs_pr_day_density                     + p_sed_pocp_denit            *inv_secs_pr_day_density  &
                    + p_sed_pocp_sulf             *inv_secs_pr_day_density                     - (p_po4_retent_ips)*(rfr_p)  *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_h2s          ,0.0                     + (p_sed_sulf_nh4)*(3.3125)   *inv_secs_pr_day_density                     + (p_sed_poc_sulf)*(0.5)      *inv_secs_pr_day_density                     + (p_sed_pocn_sulf)*(3.3125 &
)  *inv_secs_pr_day_density                     + (p_sed_pocp_sulf)*(53)      *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_alk          ,0.0                     + (1)*(p_sed_pocn_resp)*(0.5) *inv_secs_pr_day_density                     + (1)*(p_sed_pocn_denit)*(0.5)*inv_secs_pr_day_density                     + (1)*(p_sed_pocn_sulf &
)*(0.5) *inv_secs_pr_day_density                     - (1)*(p_sed_pocp_denit)*(3)  *inv_secs_pr_day_density                     - (1)*(p_sed_pocp_sulf)*(3)   *inv_secs_pr_day_density                     + (-1)*(p_nh4_nitdenit_n2)    &
 *inv_secs_pr_day_density                     + (-1)*(p_sed_pocp_resp)*(3)  *inv_secs_pr_day_density                     + (-1)*(p_nh4_nitdenit_pocn_n2)*inv_secs_pr_day_density                     - (-1)*(p_sed_resp_nh4)*(0.8125)*inv_secs_pr_day_density &
                     - (-1)*(p_sed_denit_nh4)*(6.1125)*inv_secs_pr_day_density                     - (-1)*(p_sed_sulf_nh4)*(7.4375)*inv_secs_pr_day_density                     - (-1)*(p_sed_poc_denit)*(0.8)*inv_secs_pr_day_density                     - &
 (-1)*(p_sed_poc_sulf)       *inv_secs_pr_day_density                     - (-1)*(p_sed_pocn_resp)*(0.5)*inv_secs_pr_day_density                     - (-1)*(p_sed_pocp_denit)*(84.8)*inv_secs_pr_day_density                     - (-1)*(p_sed_pocn_sulf &
)*(7.125)*inv_secs_pr_day_density                     - (-1)*(p_sed_pocp_sulf)*(106)*inv_secs_pr_day_density                     + (2)*(p_sed_resp_nh4)*(rfr_p)*inv_secs_pr_day_density                     + (2)*(p_sed_denit_nh4)*(rfr_p &
)*inv_secs_pr_day_density                     + (2)*(p_sed_sulf_nh4)*(rfr_p)*inv_secs_pr_day_density                     + (2)*(p_ips_liber_po4)       *inv_secs_pr_day_density                     + (2)*(p_sed_pocp_resp)       *inv_secs_pr_day_density    &
                  + (2)*(p_sed_pocp_denit)      *inv_secs_pr_day_density                     + (2)*(p_sed_pocp_sulf)       *inv_secs_pr_day_density                     - (2)*(p_po4_retent_ips)*(rfr_p)*inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_ipw          ,0.0                     + p_ips_ero_ipw               *inv_secs_pr_day_density                     + p_ips_biores_ipw            *inv_secs_pr_day_density                     - p_ipw_sedi_ips            &
   *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_det          ,0.0                     + p_sed_ero_det               *inv_secs_pr_day_density                     + p_sed_biores_det            *inv_secs_pr_day_density                     - p_det_sedi_sed            &
   *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_poc          ,0.0                     + p_sed_ero_poc               *inv_secs_pr_day_density                     + p_sed_biores_poc            *inv_secs_pr_day_density                     - p_poc_sedi_sed            &
   *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_pocp         ,0.0                     + p_sed_ero_pocp              *inv_secs_pr_day_density                     + p_sed_biores_pocp           *inv_secs_pr_day_density                     - p_pocp_sedi_sed           &
   *inv_secs_pr_day_density                     - p_sed_pocp_sulf             *inv_secs_pr_day_density                            )
      _SET_BOTTOM_EXCHANGE_(self%id_t_pocn         ,0.0                     + p_sed_ero_pocn              *inv_secs_pr_day_density                     + p_sed_biores_pocn           *inv_secs_pr_day_density                     - p_pocn_sedi_sed           &
   *inv_secs_pr_day_density                     - p_sed_pocn_sulf             *inv_secs_pr_day_density                            )

    ! Export diagnostic variables
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_resp_nh4  ,p_sed_resp_nh4 )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_poc_resp  ,p_sed_poc_resp )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_poc_sulf  ,p_sed_poc_sulf )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_det_sedi_sed  ,p_det_sedi_sed )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_poc_sedi_sed  ,p_poc_sedi_sed )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_pocn_sedi_sed ,p_pocn_sedi_sed)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_pocp_sedi_sed ,p_pocp_sedi_sed)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_ero_pocn  ,p_sed_ero_pocn )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_ero_pocp  ,p_sed_ero_pocp )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_biores_poc ,p_sed_biores_poc)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_biores_pocn ,p_sed_biores_pocn)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_biores_pocp ,p_sed_biores_pocp)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_burial    ,p_sed_burial   )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_poc_burial    ,p_poc_burial   )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_pocn_burial   ,p_pocn_burial  )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_pocp_burial   ,p_pocp_burial  )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_pocn_resp ,p_sed_pocn_resp)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_pocp_resp ,p_sed_pocp_resp)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_sed_pocp_denit ,p_sed_pocp_denit)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_sed_tot         ,sed_tot        )


   ! Leave spatial loops over the horizontal domain (if any).
   _HORIZONTAL_LOOP_END_

   end subroutine do_bottom
!EOC

!-----------------------------------------------------------------------
!BOP
!
! !IROUTINE: Surface fluxes for the ergom model
!
! !INTERFACE:

   subroutine do_surface(self,_ARGUMENTS_DO_SURFACE_)
   class (type_bsh_ergom_neccton),intent(in) :: self
   _DECLARE_ARGUMENTS_DO_SURFACE_
!
! !REVISION HISTORY:
!  Original author(s): Hans Burchard, Karsten Bolding
!
! !LOCAL VARIABLES:
   real(rk)                   :: critical_stress
   real(rk)                   :: cya0           
   real(rk)                   :: din_min_lpp    
   real(rk)                   :: din_min_spp    
   real(rk)                   :: dip_min_cya    
   real(rk)                   :: epsilon        
   real(rk)                   :: food_min_zoo   
   real(rk)                   :: gamma0         
   real(rk)                   :: gamma1         
   real(rk)                   :: gamma2         
   real(rk)                   :: gamma3         
   real(rk)                   :: h2s_min_po4_liber
   real(rk)                   :: ips_threshold  
   real(rk)                   :: ips_cl         
   real(rk)                   :: k_h2s_no3      
   real(rk)                   :: k_h2s_o2       
   real(rk)                   :: k_sul_no3      
   real(rk)                   :: k_sul_o2       
   real(rk)                   :: light_opt_cya  
   real(rk)                   :: light_opt_lpp  
   real(rk)                   :: light_opt_spp  
   real(rk)                   :: lpp0           
   real(rk)                   :: no3_min_sed_denit
   real(rk)                   :: no3_min_det_denit
   real(rk)                   :: o2_min_det_resp
   real(rk)                   :: o2_min_nit     
   real(rk)                   :: o2_min_po4_retent
   real(rk)                   :: o2_min_sed_resp
   real(rk)                   :: patm_co2       
   real(rk)                   :: q10_det_rec    
   real(rk)                   :: q10_doc_rec    
   real(rk)                   :: q10_h2s        
   real(rk)                   :: q10_nit        
   real(rk)                   :: q10_sed_rec    
   real(rk)                   :: r_biores       
   real(rk)                   :: r_cya_assim    
   real(rk)                   :: r_cya_resp     
   real(rk)                   :: r_det_rec      
   real(rk)                   :: r_ips_burial   
   real(rk)                   :: r_ips_ero      
   real(rk)                   :: r_ips_liber    
   real(rk)                   :: r_lpp_assim    
   real(rk)                   :: r_lpp_resp     
   real(rk)                   :: r_nh4_nitrif   
   real(rk)                   :: r_pp_mort      
   real(rk)                   :: r_cya_mort_diff
   real(rk)                   :: r_cya_mort_thresh
   real(rk)                   :: r_sed_ero      
   real(rk)                   :: r_sed_rec      
   real(rk)                   :: r_sed_poc_rec  
   real(rk)                   :: r_spp_assim    
   real(rk)                   :: r_spp_resp     
   real(rk)                   :: r_zoo_graz     
   real(rk)                   :: r_zoo_mort     
   real(rk)                   :: r_zoo_resp     
   real(rk)                   :: rfr_c          
   real(rk)                   :: rfr_h          
   real(rk)                   :: rfr_o          
   real(rk)                   :: rfr_p          
   real(rk)                   :: rfr_cp         
   real(rk)                   :: sali_max_cya   
   real(rk)                   :: sali_min_cya   
   real(rk)                   :: nit_max_cya    
   real(rk)                   :: nit_switch_cya 
   real(rk)                   :: sed_max        
   real(rk)                   :: sed_burial     
   real(rk)                   :: spp0           
   real(rk)                   :: temp_min_cya   
   real(rk)                   :: temp_switch_cya
   real(rk)                   :: temp_min_spp   
   real(rk)                   :: temp_opt_zoo   
   real(rk)                   :: w_co2_stf      
   real(rk)                   :: w_cya          
   real(rk)                   :: w_det          
   real(rk)                   :: w_ipw          
   real(rk)                   :: w_det_sedi     
   real(rk)                   :: w_ipw_sedi     
   real(rk)                   :: w_lpp          
   real(rk)                   :: w_n2_stf       
   real(rk)                   :: w_o2_stf       
   real(rk)                   :: zoo0           
   real(rk)                   :: zoo_cl         
   real(rk)                   :: don_fraction   
   real(rk)                   :: r_poc_rec      
   real(rk)                   :: r_pocp_rec     
   real(rk)                   :: r_pocn_rec     
   real(rk)                   :: w_poc          
   real(rk)                   :: w_poc_sedi     
   real(rk)                   :: w_pocp         
   real(rk)                   :: w_pocp_sedi    
   real(rk)                   :: w_pocn         
   real(rk)                   :: w_pocn_sedi    
   real(rk)                   :: fac_doc_assim_lpp
   real(rk)                   :: fac_doc_assim_cya
   real(rk)                   :: fac_doc_assim_spp
   real(rk)                   :: fac_dop_assim  
   real(rk)                   :: fac_don_assim  
   real(rk)                   :: fac_enh_rec    
   real(rk)                   :: ret_po4_1      
   real(rk)                   :: ret_po4_2      
   real(rk)                   :: frac_denit_scal
   real(rk)                   :: reduced_rec    
   real(rk)                   :: martin_fac_poc 
   real(rk)                   :: r_doc2poc      
   real(rk)                   :: r_don2pocn     
   real(rk)                   :: r_dop2pocp     
   real(rk)                   :: r_doc_rec      
   real(rk)                   :: r_don_rec      
   real(rk)                   :: r_dop_rec      
   real(rk)                   :: fac_ips_burial 
   real(rk)                   :: r_cdom_decay   
   real(rk)                   :: r_cdom_light   
   real(rk)                   :: ten            
   real(rk)                   :: zero           
   real(rk)                   :: one            
   real(rk)                   :: three          
   real(rk)                   :: min_chl_n      
   real(rk)                   :: max_chl_n      
   real(rk)                   :: light_max      
   real(rk)                   :: molar_mass_C   
   real(rk)                   :: I_h            
   real(rk)                   :: t_n2           
   real(rk)                   :: t_o2           
   real(rk)                   :: t_dic          
   real(rk)                   :: t_nh4          
   real(rk)                   :: t_no3          
   real(rk)                   :: t_po4          
   real(rk)                   :: t_spp          
   real(rk)                   :: t_zoo          
   real(rk)                   :: t_h2s          
   real(rk)                   :: t_sul          
   real(rk)                   :: t_alk          
   real(rk)                   :: t_ipw          
   real(rk)                   :: t_lpp          
   real(rk)                   :: t_cya          
   real(rk)                   :: t_det          
   real(rk)                   :: t_poc          
   real(rk)                   :: t_pocp         
   real(rk)                   :: t_pocn         
   real(rk)                   :: t_doc          
   real(rk)                   :: t_dop          
   real(rk)                   :: t_don          
   real(rk)                   :: t_cdom         
   real(rk)                   :: temp_k         
   real(rk)                   :: ph_temp        
   real(rk)                   :: k_water        
   real(rk)                   :: k0_co2         
   real(rk)                   :: k1_co2         
   real(rk)                   :: k2_co2         
   real(rk)                   :: k_boron        
   real(rk)                   :: k1_po4         
   real(rk)                   :: k2_po4         
   real(rk)                   :: k3_po4         
   real(rk)                   :: k1_h2s         
   real(rk)                   :: boron_total    
   real(rk)                   :: alk_boron      
   real(rk)                   :: alk_h2s        
   real(rk)                   :: alk_water      
   real(rk)                   :: alk_po4_denominator
   real(rk)                   :: alk_po4        
   real(rk)                   :: alk_co2_denominator
   real(rk)                   :: alk_co2        
   real(rk)                   :: alk_residual   
   real(rk)                   :: dalkp_dh3o     
   real(rk)                   :: dalkc_dh3o     
   real(rk)                   :: dalkresidual_dpH
   real(rk)                   :: ph             
   real(rk)                   :: h3o            
   real(rk)                   :: o2_sat         
   real(rk)                   :: n2_sat         
   real(rk)                   :: solubility_n2  
   real(rk)                   :: temp_sq        
   real(rk)                   :: zoo_eff        
   real(rk)                   :: din            
   real(rk)                   :: din_sq         
   real(rk)                   :: po4_sq         
   real(rk)                   :: phyto          
   real(rk)                   :: lpp_plus_lpp0  
   real(rk)                   :: spp_plus_spp0  
   real(rk)                   :: cya_plus_cya0  
   real(rk)                   :: food_zoo       
   real(rk)                   :: lim_light_lpp  
   real(rk)                   :: lim_light_spp  
   real(rk)                   :: lim_light_cya  
   real(rk)                   :: lr_assim_lpp   
   real(rk)                   :: lr_assim_lpp_doc
   real(rk)                   :: lr_assim_spp_doc
   real(rk)                   :: lr_assim_cya_doc
   real(rk)                   :: lr_assim_spp   
   real(rk)                   :: lr_assim_cya   
   real(rk)                   :: lr_assim_lpp_dop
   real(rk)                   :: lr_assim_spp_dop
   real(rk)                   :: lr_assim_lpp_don
   real(rk)                   :: lr_assim_spp_don
   real(rk)                   :: lr_graz_zoo    
   real(rk)                   :: frac_po4retent 
   real(rk)                   :: ref_p_sw       
   real(rk)                   :: ref_n_sw       
   real(rk)                   :: lr_pocp        
   real(rk)                   :: lr_dop         
   real(rk)                   :: lr_pocn        
   real(rk)                   :: lr_don         
   real(rk)                   :: w_poc_var      
   real(rk)                   :: w_pocn_var     
   real(rk)                   :: w_pocp_var     
   real(rk)                   :: phyto_C        
   real(rk)                   :: cdom_decay     
   real(rk)                   :: zoo_C          
   real(rk)                   :: lpp_C          
   real(rk)                   :: spp_C          
   real(rk)                   :: cya_C          
   real(rk)                   :: pp_total       
   real(rk)                   :: resp_total     
   real(rk)                   :: net_pp         
   real(rk)                   :: chl_a          
   real(rk)                   :: KD             
   real(rk)                   :: secchi_depth   
   real(rk)                   :: det_C          
   real(rk)                   :: chl_a_C        
   real(rk)                   :: chl_a_lpp_C    
   real(rk)                   :: chl_a_spp_C    
   real(rk)                   :: chl_a_cya_C    
   real(rk)                   :: cdom3_C        
   real(rk)                   :: cdom2_C        
   real(rk)                   :: cdom1_C        
   real(rk)                   :: r_zoo_mort_light
   real(rk)                   :: pco2           
   real(rk)                   :: co2            
   real(rk)                   :: schmidtnumber_co2
   real(rk)                   :: solubility_o2  
   real(rk)                   :: schmidtnumber_o2
   real(rk)                   :: schmidtnumber_n2
   real(rk)                   :: lim_t_n2_7          
   real(rk)                   :: lim_t_o2_0          
   real(rk)                   :: lim_t_o2_2          
   real(rk)                   :: lim_t_o2_4          
   real(rk)                   :: lim_t_o2_6          
   real(rk)                   :: lim_t_dic_8         
   real(rk)                   :: lim_t_nh4_11        
   real(rk)                   :: lim_t_no3_1         
   real(rk)                   :: lim_t_no3_3         
   real(rk)                   :: lim_t_no3_10        
   real(rk)                   :: lim_t_po4_9         
   real(rk)                   :: lim_t_spp_16        
   real(rk)                   :: lim_t_zoo_18        
   real(rk)                   :: lim_t_h2s_5         
   real(rk)                   :: lim_t_h2s_23        
   real(rk)                   :: lim_t_sul_24        
   real(rk)                   :: lim_t_ipw_25        
   real(rk)                   :: lim_t_lpp_15        
   real(rk)                   :: lim_t_cya_17        
   real(rk)                   :: lim_t_det_19        
   real(rk)                   :: lim_t_poc_12        
   real(rk)                   :: lim_t_pocp_13       
   real(rk)                   :: lim_t_pocn_14       
   real(rk)                   :: lim_t_doc_28        
   real(rk)                   :: lim_t_dop_29        
   real(rk)                   :: lim_t_don_30        
   real(rk)                   :: lim_t_cdom_31       
   real(rk)                   :: p_n2_stf_down  
   real(rk)                   :: p_n2_stf_up    
   real(rk)                   :: p_o2_stf_down  
   real(rk)                   :: p_o2_stf_up    
   real(rk)                   :: p_co2_stf_down 
   real(rk)                   :: p_co2_stf_up   
   real(rk)                   :: cgt_temp
   real(rk)                   :: cgt_sali
   real(rk)                   :: cgt_light
   real(rk)                   :: cgt_density
   real(rk)                   :: cgt_longitude
   real(rk)                   :: cgt_latitude
   real(rk)                   :: cgt_current_wave_stress
   real(rk)                   :: cgt_timestep
   real(rk)                   :: cgt_bottomdepth
   real(rk)                   :: temp1, temp2, temp3, temp4, temp5, &
                                 temp6, temp7, temp8, temp9
   real(rk)                   :: inv_secs_pr_day_density
   real(rk), parameter        :: secs_pr_day=86400.0_rk
   real(rk)                   :: cgt_iteration
!   integer                    :: cgt_iteration        ! current number of iteration in the iterative loop
!EOP
!-----------------------------------------------------------------------
!BOC
      ! Store values of constants in local variables
      critical_stress = self%critical_stress
      cya0            = self%cya0           
      din_min_lpp     = self%din_min_lpp    
      din_min_spp     = self%din_min_spp    
      dip_min_cya     = self%dip_min_cya    
      epsilon         = self%epsilon        
      food_min_zoo    = self%food_min_zoo   
      gamma0          = self%gamma0         
      gamma1          = self%gamma1         
      gamma2          = self%gamma2         
      gamma3          = self%gamma3         
      h2s_min_po4_liber = self%h2s_min_po4_liber
      ips_threshold   = self%ips_threshold  
      ips_cl          = self%ips_cl         
      k_h2s_no3       = self%k_h2s_no3      
      k_h2s_o2        = self%k_h2s_o2       
      k_sul_no3       = self%k_sul_no3      
      k_sul_o2        = self%k_sul_o2       
      light_opt_cya   = self%light_opt_cya  
      light_opt_lpp   = self%light_opt_lpp  
      light_opt_spp   = self%light_opt_spp  
      lpp0            = self%lpp0           
      no3_min_sed_denit = self%no3_min_sed_denit
      no3_min_det_denit = self%no3_min_det_denit
      o2_min_det_resp = self%o2_min_det_resp
      o2_min_nit      = self%o2_min_nit     
      o2_min_po4_retent = self%o2_min_po4_retent
      o2_min_sed_resp = self%o2_min_sed_resp
      patm_co2        = self%patm_co2       
      q10_det_rec     = self%q10_det_rec    
      q10_doc_rec     = self%q10_doc_rec    
      q10_h2s         = self%q10_h2s        
      q10_nit         = self%q10_nit        
      q10_sed_rec     = self%q10_sed_rec    
      r_biores        = self%r_biores       
      r_cya_assim     = self%r_cya_assim    
      r_cya_resp      = self%r_cya_resp     
      r_det_rec       = self%r_det_rec      
      r_ips_burial    = self%r_ips_burial   
      r_ips_ero       = self%r_ips_ero      
      r_ips_liber     = self%r_ips_liber    
      r_lpp_assim     = self%r_lpp_assim    
      r_lpp_resp      = self%r_lpp_resp     
      r_nh4_nitrif    = self%r_nh4_nitrif   
      r_pp_mort       = self%r_pp_mort      
      r_cya_mort_diff = self%r_cya_mort_diff
      r_cya_mort_thresh = self%r_cya_mort_thresh
      r_sed_ero       = self%r_sed_ero      
      r_sed_rec       = self%r_sed_rec      
      r_sed_poc_rec   = self%r_sed_poc_rec  
      r_spp_assim     = self%r_spp_assim    
      r_spp_resp      = self%r_spp_resp     
      r_zoo_graz      = self%r_zoo_graz     
      r_zoo_mort      = self%r_zoo_mort     
      r_zoo_resp      = self%r_zoo_resp     
      rfr_c           = self%rfr_c          
      rfr_h           = self%rfr_h          
      rfr_o           = self%rfr_o          
      rfr_p           = self%rfr_p          
      rfr_cp          = self%rfr_cp         
      sali_max_cya    = self%sali_max_cya   
      sali_min_cya    = self%sali_min_cya   
      nit_max_cya     = self%nit_max_cya    
      nit_switch_cya  = self%nit_switch_cya 
      sed_max         = self%sed_max        
      sed_burial      = self%sed_burial     
      spp0            = self%spp0           
      temp_min_cya    = self%temp_min_cya   
      temp_switch_cya = self%temp_switch_cya
      temp_min_spp    = self%temp_min_spp   
      temp_opt_zoo    = self%temp_opt_zoo   
      w_co2_stf       = self%w_co2_stf      
      w_cya           = self%w_cya          
      w_det           = self%w_det          
      w_ipw           = self%w_ipw          
      w_det_sedi      = self%w_det_sedi     
      w_ipw_sedi      = self%w_ipw_sedi     
      w_lpp           = self%w_lpp          
      w_n2_stf        = self%w_n2_stf       
      w_o2_stf        = self%w_o2_stf       
      zoo0            = self%zoo0           
      zoo_cl          = self%zoo_cl         
      don_fraction    = self%don_fraction   
      r_poc_rec       = self%r_poc_rec      
      r_pocp_rec      = self%r_pocp_rec     
      r_pocn_rec      = self%r_pocn_rec     
      w_poc           = self%w_poc          
      w_poc_sedi      = self%w_poc_sedi     
      w_pocp          = self%w_pocp         
      w_pocp_sedi     = self%w_pocp_sedi    
      w_pocn          = self%w_pocn         
      w_pocn_sedi     = self%w_pocn_sedi    
      fac_doc_assim_lpp = self%fac_doc_assim_lpp
      fac_doc_assim_cya = self%fac_doc_assim_cya
      fac_doc_assim_spp = self%fac_doc_assim_spp
      fac_dop_assim   = self%fac_dop_assim  
      fac_don_assim   = self%fac_don_assim  
      fac_enh_rec     = self%fac_enh_rec    
      ret_po4_1       = self%ret_po4_1      
      ret_po4_2       = self%ret_po4_2      
      frac_denit_scal = self%frac_denit_scal
      reduced_rec     = self%reduced_rec    
      martin_fac_poc  = self%martin_fac_poc 
      r_doc2poc       = self%r_doc2poc      
      r_don2pocn      = self%r_don2pocn     
      r_dop2pocp      = self%r_dop2pocp     
      r_doc_rec       = self%r_doc_rec      
      r_don_rec       = self%r_don_rec      
      r_dop_rec       = self%r_dop_rec      
      fac_ips_burial  = self%fac_ips_burial 
      r_cdom_decay    = self%r_cdom_decay   
      r_cdom_light    = self%r_cdom_light   
      ten             = self%ten            
      zero            = self%zero           
      one             = self%one            
      three           = self%three          
      min_chl_n       = self%min_chl_n      
      max_chl_n       = self%max_chl_n      
      light_max       = self%light_max      
      molar_mass_C    = self%molar_mass_C   
      I_h             = self%I_h            

   ! Enter spatial loops over the horizontal domain (if any).
   _HORIZONTAL_LOOP_BEGIN_

   ! Retrieve abiotic parameters
      _GET_HORIZONTAL_(self%id_taub,cgt_current_wave_stress)
      _GET_   (self%id_par,cgt_light) ! local photosynthetically active radiation
      _GET_   (self%id_temp,cgt_temp) !local water temperature
      _GET_   (self%id_salt,cgt_sali) !local water temperature
      _GET_GLOBAL_(self%id_timestep,cgt_timestep) !integration time step [s]
      _GET_HORIZONTAL_(self%id_lon,cgt_longitude)! Longitude [degE]
      _GET_HORIZONTAL_(self%id_lat,cgt_latitude) ! Latitude  [degN]
      _GET_HORIZONTAL_(self%id_depth,cgt_bottomdepth) !local water depth
      cgt_density = 1035.0
      cgt_timestep  = cgt_timestep/secs_pr_day  ! ecosystem model time step [d]

      inv_secs_pr_day_density = 1.0_rk/(cgt_density*secs_pr_day)


   ! Retrieve current (local) state variable values.
      _GET_(self%id_t_n2           ,t_n2           )
      _GET_(self%id_t_o2           ,t_o2           )
      _GET_(self%id_t_dic          ,t_dic          )
      _GET_(self%id_t_nh4          ,t_nh4          )
      _GET_(self%id_t_no3          ,t_no3          )
      _GET_(self%id_t_po4          ,t_po4          )
      _GET_(self%id_t_spp          ,t_spp          )
      _GET_(self%id_t_zoo          ,t_zoo          )
      _GET_(self%id_t_h2s          ,t_h2s          )
      _GET_(self%id_t_sul          ,t_sul          )
      _GET_(self%id_t_alk          ,t_alk          )
      _GET_(self%id_t_ipw          ,t_ipw          )
      _GET_(self%id_t_lpp          ,t_lpp          )
      _GET_(self%id_t_cya          ,t_cya          )
      _GET_(self%id_t_det          ,t_det          )
      _GET_(self%id_t_poc          ,t_poc          )
      _GET_(self%id_t_pocp         ,t_pocp         )
      _GET_(self%id_t_pocn         ,t_pocn         )
      _GET_(self%id_t_doc          ,t_doc          )
      _GET_(self%id_t_dop          ,t_dop          )
      _GET_(self%id_t_don          ,t_don          )
      _GET_(self%id_t_cdom         ,t_cdom         )

   ! Initialize auxiliaries for iterative loop
             temp_k          = 0.0
             ph_temp         = 0.0
             k_water         = 0.0
             k0_co2          = 0.0
             k1_co2          = 0.0
             k2_co2          = 0.0
             k_boron         = 0.0
             k1_po4          = 0.0
             k2_po4          = 0.0
             k3_po4          = 0.0
             k1_h2s          = 0.0
             boron_total     = 0.0
             alk_boron       = 0.0
             alk_h2s         = 0.0
             alk_water       = 0.0
             alk_po4_denominator = 0.0
             alk_po4         = 0.0
             alk_co2_denominator = 0.0
             alk_co2         = 0.0
             alk_residual    = 0.0
             dalkp_dh3o      = 0.0
             dalkc_dh3o      = 0.0
             dalkresidual_dpH = 0.0
             ph              = 0.0
             h3o             = 1.0e-8

   ! Iterative loop follows
             do cgt_iteration=1,10
                if (cgt_iteration .le. 1) then
                   ! absolute temperature [K] :
                   temp_k          = cgt_temp + 273.15             
                endif
                if (cgt_iteration .le. 10) then
                   ! temporary value assumed for pH [1] :
                   ph_temp         = 0.0-log(h3o)/log(10.0)        
                endif
                if (cgt_iteration .le. 1) then
                   ! self-ionization constant of Water [mol2/kg2] :
                   k_water         = exp( -13847.26 / temp_k + 148.96502 - 23.6521 * log(temp_k) + (118.67/temp_k - 5.977 + 1.0495 * log(temp_k)) * sqrt(cgt_sali) - 0.01615 * cgt_sali)
                endif
                if (cgt_iteration .le. 1) then
                   ! Solubility of CO2 [mol/kg/Pa] :
                   k0_co2          = exp(9345.17 / temp_k - 60.2409 + 23.3585 * (log(temp_k) - 4.605170186) + cgt_sali*(0.023517 - 0.00023656 * temp_k + 0.00000047036 *temp_k*temp_k))/101325.0
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant CO2 + 2 H2O <-> HCO3- + H3O+ [mol/kg] :
                   k1_co2          = power(ten,( -3633.86 / temp_k + 61.2172 - 9.6777 * log(temp_k) + 0.011555 * cgt_sali - 0.0001152 * cgt_sali * cgt_sali))
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant HCO3- + H2O <-> [CO3 2-] + H3O+ [mol/kg] :
                   k2_co2          = power(ten,( -471.78 / temp_k - 25.929 + 3.16967 * log(temp_k) + 0.01781 * cgt_sali - 0.0001122 * cgt_sali * cgt_sali))
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant of boric acid [mol/kg] :
                   k_boron         = exp(( -8966.9 - 2890.53*sqrt(cgt_sali) - 77.942*cgt_sali + 1.728*cgt_sali*sqrt(cgt_sali) - 0.0996*cgt_sali*cgt_sali) / temp_k + 148.0248 + 137.1942*sqrt(cgt_sali) + 1.62142*cgt_sali + (-24.4344 - 25.085*sqrt(cgt_sali &
) - 0.2474*cgt_sali)*log(temp_k) + 0.053105*sqrt(cgt_sali)*temp_k )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant H3PO4 + H2O <-> [H2PO4 -] + H3O+ [mol/kg] :
                   k1_po4          = exp( -4576.752/temp_k + 115.525 - 18.453*log(temp_k) + (0.69171 - 106.736/temp_k)*sqrt(cgt_sali) - (0.01844 + 0.65643/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant [H2PO4 -] + H2O+ <-> [HPO4 2-] + H3O+ [mol/kg] :
                   k2_po4          = exp( -8814.715/temp_k + 172.0883 - 27.927*log(temp_k) + (1.35660 - 160.340/temp_k)*sqrt(cgt_sali) - (0.05778 - 0.37335/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant [HPO4 2-] + H2O <-> [PO4 3-] + H3O+ [mol/kg] :
                   k3_po4          = exp( -3070.75/temp_k - 18.141 + (2.81197 + 17.27039/temp_k)*sqrt(cgt_sali) - (0.09984 + 44.99486/temp_k)*cgt_sali )
                endif
                if (cgt_iteration .le. 1) then
                   ! Acid dissociation constant H2S + H2O <-> HS- + H3O+ [mol/kg] :
                   k1_h2s          = exp( -3131.42/temp_k + 5.818 + 0.368*(power(max(zero,cgt_sali),(one/three))))
                endif
                if (cgt_iteration .le. 1) then
                   ! total concentration of boron [mol/kg] :
                   boron_total     = 0.000416 * cgt_sali/35.0      
                endif
                if (cgt_iteration .le. 10) then
                   ! boron alkalinity [mol/kg] :
                   alk_boron       = boron_total * k_boron / (k_boron + h3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! hydrogen sulfide alkalinity [mol/kg] :
                   alk_h2s         = t_h2s * k1_h2s / (k1_h2s + h3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! water alkalinity [mol/kg] :
                   alk_water       = k_water / h3o - h3o           
                endif
                if (cgt_iteration .le. 10) then
                   ! denominator in phosphate alkalinity formula [mol3/kg3] :
                   alk_po4_denominator = (h3o*h3o*h3o + k1_po4*h3o*h3o + k1_po4*k2_po4*h3o + k1_po4*k2_po4*k3_po4)
                endif
                if (cgt_iteration .le. 10) then
                   ! phosphate alkalinity [mol/kg] :
                   alk_po4         = t_po4*(k1_po4*k2_po4*h3o + 2.0*k1_po4*k2_po4*k3_po4 - h3o*h3o*h3o) / alk_po4_denominator
                endif
                if (cgt_iteration .le. 10) then
                   ! denominator in carbonate alkalinity formula [mol2/kg2] :
                   alk_co2_denominator = (h3o*h3o + k1_co2*h3o + k1_co2*k2_co2)
                endif
                if (cgt_iteration .le. 10) then
                   ! carbonate alkalinity [mol/kg] :
                   alk_co2         = t_dic*k1_co2*(h3o+2*k2_co2)/alk_co2_denominator
                endif
                if (cgt_iteration .le. 10) then
                   ! error in total alkalinity calculation at the assumed pH [mol/kg] :
                   alk_residual    = t_alk - alk_co2 - alk_po4 - alk_boron - alk_h2s - alk_water
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of phosphate alkalinity with respect to h3o [1] :
                   dalkp_dh3o      = t_po4*(0.0-k1_po4*h3o*h3o*h3o*h3o-4*k1_po4*k2_po4*h3o*h3o*h3o-(k1_po4*k1_po4*k2_po4+9*k1_po4*k2_po4*k3_po4)*h3o*h3o-4*k1_po4*k1_po4*k2_po4*k3_po4*h3o-k1_po4*k1_po4*k2_po4*k2_po4*k3_po4 &
)/(alk_po4_denominator*alk_po4_denominator)
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of carbonate alkalinity with respect to h3o [1] :
                   dalkc_dh3o      = t_dic*(0.0-k1_co2*h3o*h3o-k1_co2*k1_co2*k2_co2-4*k1_co2*k2_co2*h3o)/(alk_co2_denominator*alk_co2_denominator)
                endif
                if (cgt_iteration .le. 10) then
                   ! derivative of residual_alk with respect to pH [mol/kg] :
                   dalkresidual_dpH = 0.0-log(10.0)*h3o*(alk_boron/(k_boron+h3o)+alk_h2s/(k1_h2s+h3o)+k_water/(h3o*h3o)+1-dalkp_dh3o-dalkc_dh3o)
                endif
                if (cgt_iteration .le. 10) then
                   ! newly determined pH value [1] :
                   temp1 = alk_residual/dalkresidual_dpH 
                   ph              = ph_temp - temp1 + theta(abs(temp1) - 1)*0.5*temp1
                endif
                if (cgt_iteration .le. 10) then
                   ! h3o ion concentration [mol/kg] :
                   h3o             = power(ten,0.0-max(one,min((ten+three),ph)))
                endif
             enddo

   ! Calculate values of auxiliary variables (not iterative)
       o2_sat          = (10.18e0+((5.306e-3-4.8725e-5*cgt_temp)*cgt_temp-0.2785e0)*cgt_temp+cgt_sali*((2.2258e-3+(4.39e-7*cgt_temp-4.645e-5)*cgt_temp)*cgt_temp-6.33e-2))*44.66e0*1e-6
       temp1 = log((298.15-cgt_temp)/(273.15+cgt_temp))
       temp2 = temp1*temp1                   
       temp3 = temp2*temp1                   
       n2_sat          = 1e-6*exp(6.42931 + 2.92704*temp1 + 4.32531*temp2 + 4.69149*temp3 + cgt_sali*(0.0 -7.44129e-3 - 8.02566e-3*temp1 - 1.46775e-2*temp2))
       solubility_n2   = n2_sat * 1.263925e-5          
       temp_sq         = max(0.0,cgt_temp)*max(0.0,cgt_temp)
       zoo_eff         = t_zoo*t_zoo/zoo_cl            
       din             = t_no3+t_nh4                   
       din_sq          = din*din                       
       po4_sq          = t_po4*t_po4                   
       phyto           = t_lpp+t_spp+t_cya             
       lpp_plus_lpp0   = t_lpp+lpp0                    
       spp_plus_spp0   = t_spp+spp0                    
       cya_plus_cya0   = t_cya+cya0                    
       food_zoo        = t_lpp+t_spp+0.5*t_cya         
       temp1 = max(cgt_light/2.0,light_opt_lpp)
       lim_light_lpp   = cgt_light/temp1*exp(1-cgt_light/temp1)
       temp1 = max(cgt_light/2.0,light_opt_spp)
       lim_light_spp   = cgt_light/temp1*exp(1-cgt_light/temp1)
       temp1 = max(cgt_light/2.0,light_opt_cya)
       lim_light_cya   = cgt_light/temp1*exp(1-cgt_light/temp1)
       lr_assim_lpp    = r_lpp_assim*theta(t_o2-2*t_h2s)*min(din_sq/(din_sq+din_min_lpp*din_min_lpp),min(po4_sq/(po4_sq+din_min_lpp*din_min_lpp*rfr_p*rfr_p),lim_light_lpp))
       lr_assim_lpp_doc = fac_doc_assim_lpp * r_lpp_assim * theta(t_o2-2*t_h2s) * min(max(1 - din_sq/(din_sq+din_min_lpp*din_min_lpp),1 - po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
       lr_assim_spp_doc = fac_doc_assim_spp * r_spp_assim * theta(t_o2-2*t_h2s) * min(max(1 - din_sq/(din_sq+din_min_spp*din_min_spp),1 - po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp &
)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
       lr_assim_cya_doc = fac_doc_assim_cya * r_cya_assim*theta(t_o2-2*t_h2s)*min(1 - po4_sq/(po4_sq+dip_min_cya*dip_min_cya),lim_light_cya)*(1/(1+exp(temp_switch_cya*(temp_min_cya-cgt_temp))))*(1/(1+exp(cgt_sali-sali_max_cya)) &
)*(1/(1+exp(sali_min_cya-cgt_sali)))
       lr_assim_spp    = r_spp_assim*theta(t_o2-2*t_h2s)*min(din_sq/(din_sq+din_min_spp*din_min_spp),min(po4_sq/(po4_sq+din_min_spp*din_min_spp*rfr_p*rfr_p),lim_light_spp))*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
       lr_assim_cya    = r_cya_assim*theta(t_o2-2*t_h2s)*min(po4_sq/(po4_sq+dip_min_cya*dip_min_cya),lim_light_cya)*(1/(1+exp(temp_switch_cya*(temp_min_cya-cgt_temp))))*(1/(1+exp(cgt_sali-sali_max_cya)))*(1/(1+exp(sali_min_cya-cgt_sali)) &
)*(1/(1+exp(nit_switch_cya*(din-nit_max_cya))))
       lr_assim_lpp_dop = fac_dop_assim * r_lpp_assim * theta(t_o2-2*t_h2s) * min(min(1 - din_sq/(din_sq+din_min_lpp*din_min_lpp),po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
       lr_assim_spp_dop = fac_dop_assim * r_spp_assim * theta(t_o2-2*t_h2s) * min(min(1 - din_sq/(din_sq+din_min_spp*din_min_spp),po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
       lr_assim_lpp_don = fac_don_assim * r_lpp_assim * theta(t_o2-2*t_h2s) * min(min(din_sq/(din_sq+din_min_lpp*din_min_lpp),1 - po4_sq/(din_min_lpp*din_min_lpp*rfr_p*rfr_p + po4_sq)), lim_light_lpp)
       lr_assim_spp_don = fac_don_assim * r_spp_assim * theta(t_o2-2*t_h2s) * min(min(din_sq/(din_sq+din_min_spp*din_min_spp),1 - po4_sq/(din_min_spp*din_min_spp*rfr_p*rfr_p + po4_sq)), lim_light_spp)*(1+temp_sq/(temp_sq+temp_min_spp*temp_min_spp))
       lr_graz_zoo     = r_zoo_graz*(1-exp(-food_zoo*food_zoo/(food_min_zoo*food_min_zoo)))*theta(t_o2-2*t_h2s)*(1.0+temp_sq/(temp_opt_zoo*temp_opt_zoo)*exp(2.0-cgt_temp*2.0/temp_opt_zoo))
       frac_po4retent  = ret_po4_1 + ret_po4_2*theta(cgt_latitude-60.75)
       ref_p_sw        = (1 - (po4_sq/(rfr_p*din_min_lpp*rfr_p*din_min_lpp+po4_sq)))/(1+exp(6.0*(1-din/(t_po4/rfr_p+epsilon))))
       ref_n_sw        = (1 - (din_sq/(din_min_lpp*din_min_lpp+din_sq)))/(1+exp(6.0*(1-t_po4/rfr_p/(din+epsilon))))
       lr_pocp         = r_pocp_rec*(1 + fac_enh_rec*ref_p_sw)
       lr_dop          = r_dop_rec*(1 + fac_enh_rec*ref_p_sw)
       lr_pocn         = r_pocn_rec*(1 + fac_enh_rec*ref_n_sw)
       lr_don          = r_don_rec*(1 + fac_enh_rec*ref_n_sw)
       w_poc_var       = martin_fac_poc * cgt_bottomdepth * (-1.0)
       w_pocn_var      = -0.15                         
       w_pocp_var      = -0.15                         
       phyto_C         = (t_lpp+t_spp+t_cya)*rfr_c *1000 *cgt_density
       cdom_decay      = r_cdom_decay/(0.037*12*10**6) 
       lpp_C           = t_lpp*molar_mass_C*rfr_c*1000*cgt_density
       spp_C           = t_spp*molar_mass_C*rfr_c*1000*cgt_density
       cya_C           = t_cya*molar_mass_C*rfr_c*1000*cgt_density
       chl_a           = ((t_lpp+t_spp+t_cya)*1000*cgt_density)*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
       KD              = gamma0+(t_spp+t_lpp+t_cya)*gamma1*cgt_density+t_det*gamma2*cgt_density+t_cdom*gamma3*cgt_density
       secchi_depth    = theta(KD)*(1.614*KD**(-0.936)) + theta(1.0e-8-KD)*0.01
       det_C           = t_det*molar_mass_C*1000*rfr_c*cgt_density
       chl_a_C         = ((lpp_C+spp_C+cya_C))*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
       chl_a_lpp_C     = lpp_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
       chl_a_spp_C     = spp_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
       chl_a_cya_C     = cya_C*max(min_chl_n,max_chl_n*(1-(max_chl_n/(min_chl_n*light_max)*cgt_light)))
       cdom3_C         = t_cdom*molar_mass_C*1000*rfr_c*cgt_density
       cdom2_C         = 0                             
       cdom1_C         = 0                             
       r_zoo_mort_light = 0.005 + 0.035 * cgt_light/(I_h+cgt_light)

       pco2            = t_dic / k0_co2 / (1 + k1_co2/h3o + k1_co2*k2_co2/h3o/h3o)
       co2             = pco2*k0_co2                   
       schmidtnumber_co2 = 2068.9 + cgt_temp*((-118.63) + cgt_temp*(2.9311 + cgt_temp*(-0.027)))
       solubility_o2   = o2_sat*4.71265e-5             
       schmidtnumber_o2 = 1929.7 + cgt_temp*((-117.46) + cgt_temp*(3.116 + cgt_temp*(-0.0306)))
       schmidtnumber_n2 = 2206.1 + cgt_temp*((-144.86) + cgt_temp*(4.5413 + cgt_temp*(-0.056988)))

   ! Calculate process limitation functions
       lim_t_n2_7           = theta(t_n2-0.0)
       lim_t_o2_0           = 1.0-exp(-t_o2/o2_min_det_resp)
       lim_t_o2_2           = theta(t_o2-0.0)
       lim_t_o2_4           = t_o2*t_o2/(t_o2*t_o2+o2_min_po4_retent*o2_min_po4_retent)
       lim_t_o2_6           = t_o2*t_o2/(t_o2*t_o2+o2_min_sed_resp*o2_min_sed_resp)
       lim_t_dic_8          = theta(t_dic-0.0)
       lim_t_nh4_11         = theta(t_nh4-0.0)
       lim_t_no3_1          = 1.0-exp(-t_no3/no3_min_det_denit)
       lim_t_no3_3          = t_no3*t_no3/(t_no3*t_no3+no3_min_sed_denit*no3_min_sed_denit)
       lim_t_no3_10         = theta(t_no3-0.0)
       lim_t_po4_9          = theta(t_po4-0.0)
       lim_t_spp_16         = theta(t_spp-0.0)
       lim_t_zoo_18         = theta(t_zoo-0.0)
       lim_t_h2s_5          = theta(t_h2s-h2s_min_po4_liber)
       lim_t_h2s_23         = theta(t_h2s-0.0)
       lim_t_sul_24         = theta(t_sul-0.0)
       lim_t_ipw_25         = theta(t_ipw-0.0)
       lim_t_lpp_15         = theta(t_lpp-0.0)
       lim_t_cya_17         = theta(t_cya-0.0)
       lim_t_det_19         = theta(t_det-0.0)
       lim_t_poc_12         = theta(t_poc-0.0)
       lim_t_pocp_13        = theta(t_pocp-0.0)
       lim_t_pocn_14        = theta(t_pocn-0.0)
       lim_t_doc_28         = theta(t_doc-0.0)
       lim_t_dop_29         = theta(t_dop-0.0)
       lim_t_don_30         = theta(t_don-0.0)
       lim_t_cdom_31        = theta(t_cdom-0.0)

   ! Calculate process rates
       p_n2_stf_down   = w_n2_stf*(n2_sat-t_n2)*theta(n2_sat-t_n2)*cgt_density
       p_n2_stf_up     = (w_n2_stf*(t_n2-n2_sat)*theta(t_n2-n2_sat)*cgt_density)*lim_t_n2_7
       p_o2_stf_down   = w_o2_stf*(o2_sat-t_o2)*theta(o2_sat-t_o2)*cgt_density
       p_o2_stf_up     = (w_o2_stf*(t_o2-o2_sat)*theta(t_o2-o2_sat)*cgt_density)*lim_t_o2_2
       p_co2_stf_down  = w_co2_stf*(patm_co2-pco2)*k0_co2*theta(patm_co2-pco2)*cgt_density
       p_co2_stf_up    = (w_co2_stf*(pco2-patm_co2)*k0_co2*theta(pco2-patm_co2)*cgt_density)*lim_t_dic_8

   ! Apply time tendencies to tracers
      _ADD_SURFACE_FLUX_(self%id_t_n2           ,0.0                     + p_n2_stf_down               *inv_secs_pr_day_density                     - p_n2_stf_up                 *inv_secs_pr_day_density                            )
      _ADD_SURFACE_FLUX_(self%id_t_o2           ,0.0                     + p_o2_stf_down               *inv_secs_pr_day_density                     - p_o2_stf_up                 *inv_secs_pr_day_density                            )
      _ADD_SURFACE_FLUX_(self%id_t_dic          ,0.0                     + p_co2_stf_down              *inv_secs_pr_day_density                     - p_co2_stf_up                *inv_secs_pr_day_density                            )
    
    ! Export diagnostic variables
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_n2_stf_down   ,p_n2_stf_down  )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_n2_stf_up     ,p_n2_stf_up    )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_o2_stf_down   ,p_o2_stf_down  )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_o2_stf_up     ,p_o2_stf_up    )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_co2_stf_down  ,p_co2_stf_down )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_p_co2_stf_up    ,p_co2_stf_up   )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_pco2            ,pco2           )
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_schmidtnumber_co2 ,schmidtnumber_co2)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_schmidtnumber_o2 ,schmidtnumber_o2)
       _SET_HORIZONTAL_DIAGNOSTIC_(self%id_schmidtnumber_n2 ,schmidtnumber_n2)
   ! Leave spatial loops over the horizontal domain (if any)
   _HORIZONTAL_LOOP_END_

   end subroutine do_surface
!EOC


!-----------------------------------------------------------------------

  END MODULE bsh_ergom_neccton

!-----------------------------------------------------------------------
! Copyright by the GOTM-team under the GNU Public License - www.gnu.org
!-----------------------------------------------------------------------
